<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Handwriting Quiz Master V3</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #222; color: #fff; margin: 0; padding: 20px; text-align: center; user-select: none; }
        .hidden { display: none !important; }
        
        /* Layouts */
        .screen { max-width: 1000px; margin: 0 auto; transition: 0.3s; }
        
        /* --- PC Fullscreen Styles (Free Mode) --- */
        body.solo-mode { padding: 0; margin: 0; overflow: hidden; background: #000; }
        body.solo-mode .header-area, 
        body.solo-mode .qr-section, 
        body.solo-mode #mode-indicator { display: none !important; }
        
        body.solo-mode #pc-grid { 
            display: flex; justify-content: center; align-items: center; 
            height: 100vh; width: 100vw; margin: 0; 
        }
        body.solo-mode .pc-card {
            width: 95vw; height: 90vh; 
            border: none; background: transparent;
        }
        body.solo-mode .pc-canvas-box {
            width: 100%; height: 100%; 
            background: #fff; 
        }
        body.solo-mode .player-name { display: none; } /* Hide name in fullscreen */
        body.solo-mode .status-text { display: none; }

        /* Exit Button for Solo Mode */
        #btn-exit-solo {
            position: fixed; top: 10px; left: 10px; z-index: 999;
            background: rgba(255,255,255,0.3); color: #000; font-size: 12px; padding: 5px;
            display: none;
        }
        body.solo-mode #btn-exit-solo { display: block; }

        /* --- Canvas (Drawing Board) --- */
        .canvas-wrapper {
            position: relative;
            width: 100%; max-width: 600px; /* Wide Canvas */
            aspect-ratio: 16 / 9;
            margin: 0 auto 10px auto;
            border: 4px solid #fff;
            background: #fff;
            border-radius: 10px;
            overflow: hidden;
            cursor: crosshair;
        }
        canvas { display: block; touch-action: none; width: 100%; height: 100%; } 

        /* Buttons */
        button { border: none; padding: 10px 20px; border-radius: 5px; font-size: 16px; cursor: pointer; margin: 5px; transition: 0.2s; color: #fff; }
        .btn-clear { background: #7f8c8d; }
        .btn-submit { background: #e74c3c; font-weight: bold; width: 100px; }
        .btn-submit:disabled { background: #555; cursor: not-allowed; }
        .btn-copy { background: #27ae60; font-size: 14px; padding: 5px 10px; }
        .btn-mode { background: #3498db; font-weight: bold; border: 2px solid #fff; }
        
        .btn-judge-ok { background: #e74c3c; flex: 1; margin: 2px; } 
        .btn-judge-ng { background: #3498db; flex: 1; margin: 2px; } 
        
        /* PC Grid Display (Normal Mode) */
        #pc-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(310px, 1fr)); 
            gap: 20px; margin-top: 20px; 
        }
        .pc-card {
            background: #444; border-radius: 10px; padding: 10px;
            display: flex; flex-direction: column; align-items: center;
            transition: 0.3s; border: 4px solid #555;
        }
        /* PC Canvas Container (Normal) */
        .pc-canvas-box {
            width: 300px; height: 169px; /* 16:9 ratio */
            background: #fff; border-radius: 5px; position: relative;
        }
        .pc-card canvas { width: 100%; height: 100%; }
        
        /* Quiz Mode Effects */
        .pc-card.hidden-answer .pc-canvas-box canvas { filter: blur(15px); opacity: 0.5; }
        .pc-card.revealed .pc-canvas-box canvas { filter: blur(0); opacity: 1; }
        
        .bg-correct { background-color: #c0392b !important; border-color: #e74c3c !important; }
        .bg-wrong { background-color: #2980b9 !important; border-color: #3498db !important; }
        
        .player-name { font-size: 20px; font-weight: bold; margin-bottom: 10px; }
        .status-text { font-size: 14px; color: #aaa; margin-top: 5px; }

        /* Judge List */
        .judge-item {
            background: #333; padding: 10px; margin-bottom: 10px; border-radius: 8px; border: 1px solid #555;
            display: flex; flex-direction: column; align-items: center;
        }
        .judge-item img { width: 100%; max-width: 300px; background: #fff; border-radius: 4px; margin-bottom: 10px; }
        .judge-controls { display: flex; width: 100%; justify-content: space-between; }

        /* QR Area */
        .qr-section { display: flex; justify-content: space-around; margin-top: 50px; border-top: 1px solid #555; padding-top: 20px; flex-wrap: wrap; }
        .qr-box { background: #333; padding: 15px; border-radius: 10px; margin: 10px; }
        input[type="text"] { padding: 5px; border-radius: 5px; border: none; width: 200px; font-size: 12px; }
        
        /* Mode Indicator */
        #mode-indicator { font-size: 24px; font-weight: bold; color: #f1c40f; margin-bottom: 10px; }
        
        /* Orientation Warning */
        #orientation-msg { 
            display: none; background: #e67e22; color: #000; padding: 5px; 
            margin-bottom: 10px; font-size: 12px; font-weight: bold; border-radius: 5px;
        }
    </style>
</head>
<body>

<div id="screen-pc" class="screen hidden">
    <button id="btn-exit-solo" onclick="exitSoloMode()">× 戻る</button>

    <div class="header-area" style="display:flex; justify-content:space-between; align-items:center;">
        <h1 style="color:#f1c40f; margin:0;">Handwriting Quiz V3</h1>
        <div>
            <button onclick="toggleMode()" class="btn-mode" id="btn-mode-toggle">モード切替: クイズ</button>
            <button onclick="resetBoard()" style="background:#f39c12; color:#000;">全消去</button>
        </div>
    </div>
    
    <div id="mode-indicator">現在のモード: クイズ (判定あり)</div>
    
    <div id="pc-grid">
        </div>

    <div class="qr-section">
        <div class="qr-box">
            <p>【判定役用】</p>
            <div id="qrcode-judge" style="background:#fff; padding:10px; display:inline-block;"></div>
            <div style="margin-top:5px;">
                <input type="text" id="url-judge" readonly>
                <button class="btn-copy" onclick="copyUrl('url-judge')">コピー</button>
            </div>
        </div>
        <div class="qr-box">
            <p>【参加者用】</p>
            <div id="qrcode-player" style="background:#fff; padding:10px; display:inline-block;"></div>
            <div style="margin-top:5px;">
                <input type="text" id="url-player" readonly>
                <button class="btn-copy" onclick="copyUrl('url-player')">コピー</button>
            </div>
        </div>
    </div>
</div>


<div id="screen-judge" class="screen hidden">
    <h2 style="color:#f39c12;">[判定役] 管理画面</h2>
    <p id="judge-status" style="color:#2ecc71;">PC接続済み</p>
    <div id="judge-warning" style="color:#e74c3c; font-weight:bold; display:none;">※現在はフリーモードです。<br>PC画面に直接反映されています。</div>
    <hr>
    <div id="judge-list">
        <p style="color:#aaa;">回答待ち...</p>
    </div>
</div>


<div id="screen-login" class="screen hidden">
    <h1>手書きクイズ</h1>
    <p>スマホを横にして使ってください</p>
    <input type="text" id="my-name" placeholder="ニックネーム" style="padding:10px; width:80%; font-size:16px;">
    <br><br>
    <button onclick="joinGame()" style="background:#27ae60; width:80%;">参加する</button>
</div>

<div id="screen-draw" class="screen hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2 id="disp-name" style="margin:0; font-size:18px;"></h2>
        <div id="orientation-msg">スマホを横にすると書きやすいです</div>
    </div>
    
    <p id="mode-msg" style="font-size:12px; color:#aaa; margin:5px 0;">クイズモード: 書いて送信してください</p>
    
    <div class="canvas-wrapper">
        <canvas id="drawing-board" width="800" height="450"></canvas>
    </div>
    
    <div style="display:flex; justify-content:center;">
        <button class="btn-clear" onclick="clearCanvas()">消去</button>
        <button id="btn-send" class="btn-submit" onclick="sendImage()">送信</button>
    </div>
    <p id="player-status" style="color:#f1c40f; margin-top:5px; font-weight:bold; font-size:14px;"></p>
</div>


<script>
    // --- Global Vars ---
    let peer, myId;
    let connections = {}; 
    let judgeConn = null;
    let players = {}; 
    
    let isFreeMode = false; // Toggle for Realtime Mode

    // Canvas vars (Player side)
    let canvas, ctx;
    let isDrawing = false;
    let lastX = 0, lastY = 0;

    // --- Init ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const hostId = urlParams.get('host');
        const role = urlParams.get('role');

        if (hostId) {
            setupPeer(false, hostId, role);
        } else {
            setupPeer(true);
        }
        
        // Orientation Check
        if(window.innerWidth < window.innerHeight) {
            const msg = document.getElementById('orientation-msg');
            if(msg) msg.style.display = 'block';
        }
    };

    function setupPeer(isHostMode, hostId = null, role = null) {
        peer = new Peer();
        peer.on('open', (id) => {
            myId = id;
            if (isHostMode) {
                initHost();
            } else {
                if (role === 'judge') initJudge(hostId);
                else initPlayer(hostId);
            }
        });
        peer.on('error', err => {
            console.error(err);
            if(!isHostMode) alert("接続エラー: QRを読み直してください。");
        });
    }

    // ================= HOST (PC) LOGIC =================
    function initHost() {
        document.getElementById('screen-pc').classList.remove('hidden');
        
        const baseUrl = location.href.split('?')[0];
        const judgeUrl = `${baseUrl}?host=${myId}&role=judge`;
        const playerUrl = `${baseUrl}?host=${myId}`;

        new QRCode(document.getElementById("qrcode-judge"), { text: judgeUrl, width: 128, height: 128 });
        document.getElementById('url-judge').value = judgeUrl;

        new QRCode(document.getElementById("qrcode-player"), { text: playerUrl, width: 128, height: 128 });
        document.getElementById('url-player').value = playerUrl;

        peer.on('connection', c => {
            c.on('open', () => {
                c.on('data', data => handleHostData(c, data));
            });
        });
    }

    function toggleMode() {
        isFreeMode = !isFreeMode;
        const ind = document.getElementById('mode-indicator');
        const btn = document.getElementById('btn-mode-toggle');
        
        if (isFreeMode) {
            ind.innerText = "現在のモード: フリー (リアルタイム・全画面)";
            ind.style.color = "#3498db";
            btn.innerText = "モード切替: フリー";
            broadcast({ type: 'MODE_CHANGE', mode: 'free' });
            
            document.querySelectorAll('.pc-card').forEach(el => el.classList.remove('hidden-answer', 'revealed'));
            
            // If players exist, trigger solo mode immediately
            if (Object.keys(players).length > 0) {
                document.body.classList.add('solo-mode');
            }

        } else {
            ind.innerText = "現在のモード: クイズ (判定あり)";
            ind.style.color = "#f1c40f";
            btn.innerText = "モード切替: クイズ";
            broadcast({ type: 'MODE_CHANGE', mode: 'quiz' });
            
            document.querySelectorAll('.pc-card').forEach(el => el.classList.add('hidden-answer'));
            exitSoloMode();
        }
    }

    function exitSoloMode() {
        document.body.classList.remove('solo-mode');
    }

    function handleHostData(c, data) {
        if (data.type === 'JUDGE_JOIN') {
            judgeConn = c;
            judgeConn.send({ type: 'MODE_CHANGE', mode: isFreeMode ? 'free' : 'quiz' });
        }
        
        else if (data.type === 'PLAYER_JOIN') {
            connections[c.peer] = c;
            players[c.peer] = { name: data.name, status: 'waiting' };
            createPlayerCard(c.peer, data.name);
            c.send({ type: 'MODE_CHANGE', mode: isFreeMode ? 'free' : 'quiz' });
            
            if(isFreeMode) {
                document.body.classList.add('solo-mode');
            }
        }
        
        else if (data.type === 'RT_DRAW') {
            if (players[c.peer] && players[c.peer].pcCtx) {
                const ctx = players[c.peer].pcCtx;
                ctx.lineWidth = 5; // Thicker for large screen
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';
                
                if(data.action === 'start') {
                    ctx.beginPath();
                    ctx.moveTo(data.x, data.y);
                } else if(data.action === 'move') {
                    ctx.beginPath();
                    ctx.moveTo(data.lastX, data.lastY);
                    ctx.lineTo(data.x, data.y);
                    ctx.stroke();
                } else if(data.action === 'clear') {
                    ctx.clearRect(0,0,800,450);
                }
            }
        }

        else if (data.type === 'SUBMIT_IMAGE') {
            if (isFreeMode) return; 
            
            const p = players[c.peer];
            p.status = 'received';
            
            const card = document.getElementById(`card-${c.peer}`);
            if(card) {
                card.querySelector('.status-text').innerText = "回答 受信済み";
                const img = new Image();
                img.onload = () => {
                    p.pcCtx.clearRect(0,0,800,450);
                    p.pcCtx.drawImage(img, 0, 0);
                };
                img.src = data.image;
            }

            if (judgeConn) {
                judgeConn.send({
                    type: 'NEW_ANSWER',
                    id: c.peer,
                    name: p.name,
                    image: data.image
                });
            }
        }

        else if (data.type === 'JUDGE_DECISION') {
            const pId = data.targetId;
            const p = players[pId];
            if (p) {
                p.status = data.result;
                const card = document.getElementById(`card-${pId}`);
                if(card) {
                    card.classList.remove('bg-correct', 'bg-wrong', 'hidden-answer');
                    card.classList.add('revealed');
                    
                    if (data.result === 'correct') {
                        card.classList.add('bg-correct');
                        card.querySelector('.status-text').innerText = "正解！！";
                    } else {
                        card.classList.add('bg-wrong');
                        card.querySelector('.status-text').innerText = "不正解...";
                    }
                }
            }
        }
    }

    function createPlayerCard(id, name) {
        if(document.getElementById(`card-${id}`)) return;

        const grid = document.getElementById('pc-grid');
        const div = document.createElement('div');
        div.id = `card-${id}`;
        let baseClass = "pc-card";
        if (!isFreeMode) baseClass += " hidden-answer";
        
        div.className = baseClass;
        div.innerHTML = `
            <div class="player-name">${name}</div>
            <div class="pc-canvas-box">
                <canvas id="canvas-${id}" width="800" height="450"></canvas>
            </div>
            <div class="status-text">回答待ち...</div>
        `;
        grid.appendChild(div);

        const cvs = document.getElementById(`canvas-${id}`);
        players[id].pcCtx = cvs.getContext('2d');
    }

    function resetBoard() {
        if(!confirm("全員の回答をリセットしますか？")) return;
        
        Object.keys(players).forEach(id => {
            const p = players[id];
            p.status = 'waiting';
            if(p.pcCtx) p.pcCtx.clearRect(0,0,800,450);
            
            const card = document.getElementById(`card-${id}`);
            if(card) {
                card.className = "pc-card"; 
                if(!isFreeMode) card.classList.add('hidden-answer');
                card.querySelector('.status-text').innerText = "回答待ち...";
            }

            if(connections[id]) connections[id].send({ type: 'RESET' });
        });
        
        if(judgeConn) judgeConn.send({ type: 'RESET_ALL' });
    }

    function copyUrl(id) {
        const el = document.getElementById(id);
        el.select();
        navigator.clipboard.writeText(el.value).then(() => alert("コピーしました"));
    }

    function broadcast(data) {
        Object.values(connections).forEach(c => c.send(data));
        if(judgeConn) judgeConn.send(data);
    }

    // ================= JUDGE LOGIC =================
    function initJudge(hostId) {
        document.getElementById('screen-judge').classList.remove('hidden');
        hostConn = peer.connect(hostId);
        
        hostConn.on('open', () => {
            hostConn.send({ type: 'JUDGE_JOIN' });
        });
        
        hostConn.on('data', data => {
            if (data.type === 'NEW_ANSWER') {
                addJudgeItem(data);
            } else if (data.type === 'RESET_ALL') {
                document.getElementById('judge-list').innerHTML = '<p style="color:#aaa;">回答待ち...</p>';
            } else if (data.type === 'MODE_CHANGE') {
                const warning = document.getElementById('judge-warning');
                if(data.mode === 'free') {
                    warning.style.display = 'block';
                    document.getElementById('judge-list').style.opacity = '0.3';
                } else {
                    warning.style.display = 'none';
                    document.getElementById('judge-list').style.opacity = '1';
                }
            }
        });
    }

    function addJudgeItem(data) {
        const list = document.getElementById('judge-list');
        if(list.innerHTML.includes('回答待ち')) list.innerHTML = "";
        
        if(document.getElementById(`judge-${data.id}`)) {
            document.getElementById(`judge-${data.id}`).remove();
        }

        const div = document.createElement('div');
        div.id = `judge-${data.id}`;
        div.className = 'judge-item';
        div.innerHTML = `
            <div style="font-weight:bold; margin-bottom:5px;">${data.name}</div>
            <img src="${data.image}">
            <div class="judge-controls">
                <button class="btn-judge-ok" onclick="sendDecision('${data.id}', 'correct', this)">正解 (赤)</button>
                <button class="btn-judge-ng" onclick="sendDecision('${data.id}', 'wrong', this)">不正解 (青)</button>
            </div>
        `;
        list.appendChild(div);
    }

    function sendDecision(targetId, result, btn) {
        hostConn.send({ type: 'JUDGE_DECISION', targetId: targetId, result: result });
        const parent = btn.parentNode;
        parent.innerHTML = `<span style="font-weight:bold; color:${result==='correct'?'#e74c3c':'#3498db'}">判定済み: ${result==='correct'?'正解':'不正解'}</span>`;
    }

    // ================= PLAYER LOGIC =================
    function initPlayer(hostId) {
        document.getElementById('screen-login').classList.remove('hidden');
        
        canvas = document.getElementById('drawing-board');
        ctx = canvas.getContext('2d');
        
        // Touch
        canvas.addEventListener('touchstart', startDraw, {passive: false});
        canvas.addEventListener('touchmove', draw, {passive: false});
        
        // Mouse
        canvas.addEventListener('mousedown', startDraw);
        canvas.addEventListener('mousemove', draw);
        window.addEventListener('mouseup', endDraw);

        hostConn = peer.connect(hostId);
        hostConn.on('open', () => console.log("Connected"));
        hostConn.on('data', data => {
            if (data.type === 'RESET') {
                clearCanvas();
                const btn = document.getElementById('btn-send');
                btn.disabled = false; 
                btn.innerText = "送信";
                document.getElementById('player-status').innerText = "";
            } else if (data.type === 'MODE_CHANGE') {
                isFreeMode = (data.mode === 'free');
                const msg = document.getElementById('mode-msg');
                const btn = document.getElementById('btn-send');
                if (isFreeMode) {
                    msg.innerText = "フリーモード: リアルタイムで反映されます";
                    btn.style.display = "none"; 
                } else {
                    msg.innerText = "クイズモード: 書いて送信してください";
                    btn.style.display = "inline-block";
                }
            }
        });
    }

    function joinGame() {
        const name = document.getElementById('my-name').value;
        if (!name) return alert("名前を入力してください");
        
        hostConn.send({ type: 'PLAYER_JOIN', name: name });
        document.getElementById('screen-login').classList.add('hidden');
        document.getElementById('screen-draw').classList.remove('hidden');
        document.getElementById('disp-name').innerText = name;
        
        ctx.lineWidth = 5;
        ctx.lineCap = 'round';
        ctx.strokeStyle = '#000';
    }

    function getPos(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;
        
        let x, y;
        if (e.touches) {
            x = (e.touches[0].clientX - rect.left) * scaleX;
            y = (e.touches[0].clientY - rect.top) * scaleY;
        } else {
            x = (e.clientX - rect.left) * scaleX;
            y = (e.clientY - rect.top) * scaleY;
        }
        return {x, y};
    }

    function startDraw(e) {
        e.preventDefault();
        isDrawing = true;
        const pos = getPos(e);
        lastX = pos.x;
        lastY = pos.y;
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        
        if(isFreeMode) {
            hostConn.send({ type: 'RT_DRAW', action: 'start', x: lastX, y: lastY });
        }
    }

    function draw(e) {
        if (!isDrawing) return;
        e.preventDefault();
        const pos = getPos(e);
        
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        
        if(isFreeMode) {
            hostConn.send({ type: 'RT_DRAW', action: 'move', x: pos.x, y: pos.y, lastX: lastX, lastY: lastY });
        }
        
        lastX = pos.x;
        lastY = pos.y;
    }

    function endDraw() {
        isDrawing = false;
    }

    function clearCanvas() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        if(isFreeMode) {
            hostConn.send({ type: 'RT_DRAW', action: 'clear' });
        }
    }

    function sendImage() {
        if (isFreeMode) return;
        const dataUrl = canvas.toDataURL('image/png');
        hostConn.send({ type: 'SUBMIT_IMAGE', image: dataUrl });
        
        const btn = document.getElementById('btn-send');
        btn.disabled = true;
        btn.innerText = "送信済み";
        document.getElementById('player-status').innerText = "判定をお待ちください...";
    }

</script>
</body>
</html>
