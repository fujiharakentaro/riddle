<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>è¢«ã‚‰ãªã„ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ V5.1</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DotGothic16&family=Reggae+One&family=Noto+Serif+JP:wght@900&display=swap" rel="stylesheet">
    
    <style>
        body {
            font-family: 'DotGothic16', sans-serif;
            background-color: #111;
            color: #fff;
            margin: 0;
            padding: 0;
            overflow-x: hidden;
            text-align: center;
            user-select: none;
        }

        .hidden { display: none !important; }
        
        /* Global BG */
        #global-bg-layer {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1; background-color: #000;
        }
        #global-bg-img {
            width: 100%; height: 100%; object-fit: cover; opacity: 0.5; transition: opacity 0.5s, filter 0.5s;
        }

        .screen { 
            width: 100vw; height: 100vh; 
            position: absolute; top: 0; left: 0; 
            display: flex; flex-direction: column; 
            align-items: center; justify-content: center;
        }

        /* Title Logo */
        .title-logo {
            font-family: 'Noto Serif JP', serif; font-weight: 900;
            font-size: 100px; line-height: 1.1; margin-bottom: 40px;
            position: relative; z-index: 1; color: transparent; 
            -webkit-text-stroke: 6px #f1c40f; filter: drop-shadow(0 0 8px rgba(0,0,0,0.9));
        }
        .title-logo::before {
            content: attr(data-text); position: absolute; left: 0; top: 0; width: 100%; height: 100%; z-index: 2;
            background: linear-gradient(to bottom, #ff3333 10%, #cc0000 60%, #800000 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent; -webkit-text-stroke: 0;
        }
        @media (max-width: 800px) { .title-logo { font-size: 60px; -webkit-text-stroke: 4px #f1c40f; } }

        /* Buttons */
        button { font-family: 'DotGothic16', sans-serif; background: #333; color: #fff; border: 1px solid #fff; padding: 8px 16px; cursor: pointer; margin: 5px; transition: 0.1s; }
        button:active { transform: translateY(2px); }
        button:disabled { opacity: 0.5; cursor: not-allowed; background: #555; }
        
        .btn-title-start {
            padding: 20px 60px; font-size: 28px; background: linear-gradient(to bottom, #c0392b, #8e2a1f);
            border: 4px solid #f1c40f; border-radius: 10px; color: #fff; text-shadow: 2px 2px 0 #000; 
            box-shadow: 0 10px 0 #5a1a15, 0 15px 10px rgba(0,0,0,0.5); font-family: 'Noto Serif JP', serif; font-weight: 900; margin-bottom: 20px;
        }
        .btn-title-start:active { transform: translateY(6px); box-shadow: 0 4px 0 #5a1a15; }

        .btn-title-settings {
            padding: 10px 30px; font-size: 16px; background: rgba(0,0,0,0.5); border: 1px solid #777;
            cursor: pointer; color: #ccc; margin-top: 20px;
        }
        .btn-large { padding: 15px 30px; font-size: 20px; background: #c0392b; border: 2px solid #fff; }
        .btn-confirm { background: #e67e22; color: #000; font-weight: bold; }
        .btn-debug { background: #8e44ad; border-color: #9b59b6; color: #fff; font-weight: bold; margin-top: 20px; }

        /* Start Options */
        .start-options-box {
            background: rgba(0,0,0,0.95); border: 4px double #f1c40f; padding: 30px; border-radius: 10px;
            width: 90%; max-width: 500px; box-shadow: 0 0 30px rgba(241, 196, 15, 0.2);
        }
        .option-row { margin: 25px 0; font-size: 22px; display: flex; justify-content: space-between; align-items: center; }
        .option-row input { width: 80px; font-size: 22px; padding: 5px; text-align: center; background: #000; color: #fff; border: 1px solid #777; font-family: 'DotGothic16'; }

        /* Setup Screen */
        #setup-container { width: 95%; max-width: 800px; height: 90vh; overflow-y: auto; background: rgba(34, 34, 34, 0.95); border: 4px double #777; padding: 20px; box-sizing: border-box; text-align: left; }
        .setup-section { margin-bottom: 20px; border-bottom: 1px dashed #555; padding-bottom: 20px; }
        .setup-section h3 { color: #f1c40f; margin-top: 0; }
        .floor-config-row { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; background: #333; padding: 5px; }
        .floor-label { width: 40px; font-weight: bold; }
        .q-list-item { background: #333; padding: 5px; margin-bottom: 2px; display: flex; justify-content: space-between; font-size: 14px; }
        input[type="text"], input[type="number"] { padding: 5px; background: #000; color: #fff; border: 1px solid #777; text-align: center; font-family: 'DotGothic16'; }
        
        .file-status { font-size: 12px; color: #555; margin-left: 5px; border: 1px solid #555; padding: 2px 4px; border-radius: 4px; }
        .file-status.active { color: #2ecc71; border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }

        /* Lobby */
        #lobby-url-container { margin-top: 10px; background: #222; padding: 5px; border: 1px solid #555; cursor: pointer; transition: 0.2s; }
        #lobby-url-container:hover { background: #333; border-color: #fff; }
        #lobby-url-container:active { background: #444; }

        /* Game Screen Layout */
        .dungeon-header { 
            position: absolute; top: 0; left: 0; width: 100%; 
            display: flex; justify-content: space-between; padding: 20px; box-sizing: border-box; 
            z-index: 20; text-shadow: 2px 2px 0 #000; 
        }
        .floor-indicator { font-size: 40px; color: #f1c40f; font-family: 'Noto Serif JP', serif; font-weight: 900; }
        .timer-box { font-size: 32px; border: 2px solid #fff; padding: 5px 15px; background: rgba(0,0,0,0.7); }
        .timer-warning { color: #e74c3c; animation: blink 0.5s infinite; }
        
        .enemy-area { 
            flex: 1; width: 100%; position: relative; 
            display: flex; flex-direction: column; align-items: center; 
            justify-content: flex-end; 
            padding-bottom: 20px;
        }

        .enemy-img { 
            position: absolute; 
            /* Top is controlled by JS now */
            left: 50%; 
            transform-origin: top center;
            object-fit: contain; 
            filter: drop-shadow(0 0 20px rgba(0,0,0,0.8)); 
            animation: float 3s ease-in-out infinite; 
            z-index: 5; 
            opacity: 0; 
            transition: opacity 0.3s ease-in;
        }
        
        .question-box { 
            position: relative; z-index: 10;
            background: rgba(0,0,0,0.9); border: 4px double #fff; padding: 5px 15px; 
            font-size: 55px; font-weight: 900;
            width: 90%; max-width: 800px;
            margin-top: auto; 
            margin-bottom: 20px; 
            border-radius: 12px; text-align: center; box-shadow: 0 0 25px rgba(0,0,0,0.9);
            line-height: 1.1; 
            min-height: auto;
            display: flex; align-items: center; justify-content: center;
        }
        
        .answers-grid { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; width: 95%; padding-bottom: 20px; z-index: 30; min-height: 120px; }
        
        .answer-card { 
            background: #222; border: 2px solid #777; padding: 10px; 
            width: 140px; min-height: 90px; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; 
            position: relative; transition: 0.2s; cursor: pointer; 
        }
        .p-name { font-size: 12px; color: #aaa; }
        .p-ans { font-size: 28px; font-weight: bold; word-break: break-all; line-height: 1.1; }
        
        .answer-card.selected-ng { background: #c0392b !important; border-color: #e74c3c !important; transform: scale(1.05); }
        .answer-card.selected-ng::after { content: "è¢«ã‚Š!"; position: absolute; top: -5px; right: -5px; font-weight:bold; background: #fff; color: #c0392b; padding: 2px 6px; font-size: 14px; border: 2px solid #c0392b; }

        /* Debug Controller */
        #screen-debug-controller { 
            padding: 10px; background: #1a1a1a; 
            display: flex; flex-direction: column; align-items: center; 
            overflow-y: auto; height: 100vh; 
        }
        .debug-input-row {
            display: flex; width: 100%; max-width: 400px; margin-bottom: 10px;
            background: #333; padding: 10px; border-radius: 5px; align-items: center;
        }
        .debug-p-label { width: 80px; font-size: 14px; color: #f1c40f; font-weight: bold; }
        .debug-p-input { flex: 1; padding: 8px; font-size: 18px; border: none; border-radius: 4px; text-align: left; }

        /* Debug UI */
        #debug-panel {
            position: absolute; bottom: 80px; left: 0; width: 100%;
            display: flex; justify-content: center; gap: 20px; z-index: 100;
        }
        .debug-btn {
            padding: 10px 20px; font-size: 18px; border: 2px solid #fff; cursor: pointer;
            box-shadow: 0 0 10px rgba(0,0,0,0.5); font-family: 'DotGothic16';
        }
        .debug-btn.win { background: #27ae60; }
        .debug-btn.lose { background: #c0392b; }

        @keyframes float { 0%, 100% { transform: translateX(-50%) translateY(0); } 50% { transform: translateX(-50%) translateY(-15px); } }
        @keyframes blink { 50% { opacity: 0.5; } }
        .shake-screen { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; background: #300 !important; }
        @keyframes shake { 10%, 90% { transform: translate3d(-5px, 0, 0); } 20%, 80% { transform: translate3d(10px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-10px, 0, 0); } 40%, 60% { transform: translate3d(10px, 0, 0); } }
        
        .slash-effect { 
            position: absolute; top: 50%; left: 50%; 
            width: 150vw; height: 15px; 
            background: #fff; box-shadow: 0 0 25px #fff; 
            transform: translate(-50%, -50%) rotate(-45deg); 
            animation: slash 0.2s ease-out forwards;
            z-index: 100; opacity: 0;
        }
        @keyframes slash { 
            0% { width: 0; opacity: 1; } 
            50% { width: 200vw; opacity: 1; } 
            100% { width: 250vw; opacity: 0; } 
        }

        /* Player Screen */
        #screen-player { padding: 20px; box-sizing: border-box; background: #222; }
    </style>
</head>
<body>

<audio id="bgm-player" loop></audio>
<div id="global-bg-layer"><img id="global-bg-img" src="" style="display:none;"></div>

<div id="screen-title" class="screen">
    <div class="title-logo" data-text="è¢«ã‚‰ãªã„ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³">è¢«ã‚‰ãªã„ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³</div>
    <button class="btn-title-start" onclick="showStartOptions()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <br>
    <button class="btn-title-settings" onclick="showScreen('screen-setup')">è¨­å®šï¼ˆç´ æãƒ»BGMãƒ»ãŠé¡Œï¼‰</button>
</div>

<div id="screen-start-options" class="screen hidden" style="background:rgba(0,0,0,0.8);">
    <div class="start-options-box">
        <h2 style="color:#f1c40f; margin-top:0;">ãƒŸãƒƒã‚·ãƒ§ãƒ³è¨­å®š</h2>
        <div class="option-row">
            <label>å‚åŠ äººæ•°</label>
            <div><input type="number" id="opt-players" value="4" min="2" style="width:60px;"> äºº</div>
        </div>
        <div class="option-row">
            <label>éšå±¤æ•°</label>
            <div><input type="number" id="opt-floors" value="7" min="1" max="7" style="width:60px;"> éš</div>
        </div>
        <div class="option-row">
            <label>åˆ¶é™æ™‚é–“</label>
            <div><input type="number" id="opt-time" value="300" step="30" style="width:60px;"> ç§’</div>
        </div>
        <div style="margin-top:30px;">
            <button class="btn-large" onclick="goToLobby()">ãƒ­ãƒ“ãƒ¼ã‚’ä½œæˆ</button>
            <br>
            <button class="btn-title-settings" onclick="showScreen('screen-title')" style="margin-top:10px;">æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="screen-debug-start" class="screen hidden" style="background:rgba(0,0,0,0.9);">
    <div class="start-options-box" style="border-color:#8e44ad;">
        <h2 style="color:#8e44ad; margin-top:0;">ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š</h2>
        <p style="font-size:14px; color:#aaa;">ã‚¹ãƒãƒ›å´ã§è¤‡æ•°äººåˆ†ã®å›ç­”ã‚’å…¥åŠ›ã§ãã¾ã™ã€‚</p>
        <div class="option-row">
            <label>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆäººæ•°</label>
            <div><input type="number" id="debug-opt-players" value="8" min="2" max="20" style="width:60px;"> äºº</div>
        </div>
        <div style="margin-top:30px;">
            <button class="btn-debug" onclick="goToDebugLobby()">ãƒ‡ãƒãƒƒã‚°ãƒ­ãƒ“ãƒ¼ä½œæˆ</button>
            <br>
            <button class="btn-title-settings" onclick="showScreen('screen-setup')" style="margin-top:10px;">æˆ»ã‚‹</button>
        </div>
    </div>
</div>

<div id="screen-setup" class="screen hidden" style="background:none;">
    <div style="display:flex; justify-content:center; align-items:center; height:100vh;">
        <div id="setup-container">
            <h2 style="text-align:center; color:#e74c3c; margin:0 0 20px 0;">ç´ æãƒ»è©³ç´°è¨­å®š</h2>
            
            <div class="setup-section">
                <h3>1. BGMãƒ»èƒŒæ™¯</h3>
                <label>BGM: <input type="file" id="file-bgm" accept="audio/*" onchange="autoSaveAsset('bgm', this)"></label>
                <span id="status-bgm" class="file-status">æœªè¨­å®š</span>
                <br><br>
                <label>ã‚¿ã‚¤ãƒˆãƒ«èƒŒæ™¯: <input type="file" id="bg-title" accept="image/*" onchange="autoSaveAsset('titleBg', this)"></label>
                <span id="status-bg-title" class="file-status">æœªè¨­å®š</span>
                <br>
                <label>èƒŒæ™¯ã®æ˜ã‚‹ã•: <span id="disp-opacity">50%</span> <input type="range" id="bg-opacity" min="0.1" max="1.0" step="0.1" value="0.5" onchange="saveOpacity()"></label>
            </div>
            
            <div class="setup-section">
                <h3>2. éšå±¤ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ« (æœ€å¤§7éšå±¤åˆ†)</h3>
                <div id="visual-config-area"></div>
            </div>
            
            <div class="setup-section">
                <h3>3. ãŠé¡Œç™»éŒ²</h3>
                <div style="display:flex; gap:5px; margin-bottom:10px;">
                    <input type="text" id="q-text" placeholder="ãŠé¡Œ" style="flex:1; text-align:left;">
                    <input type="number" id="q-count" placeholder="æ•°" style="width:60px;">
                    <button onclick="addQuestion()">è¿½åŠ </button>
                </div>
                <div id="question-list" style="max-height:150px; overflow-y:auto; border:1px solid #555;"></div>
                <div style="text-align:right; font-size:12px; color:#f1c40f;" id="q-status">0 å•</div>
            </div>
            
            <div style="text-align:center; margin-bottom: 20px;">
                <button class="btn-large" onclick="saveSettingsAndBack()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
            </div>
            
            <div style="text-align:center; border-top:1px dashed #555; padding-top:20px;">
                <button class="btn-debug" onclick="showScreen('screen-debug-start')">ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰è¨­å®š</button>
            </div>
        </div>
    </div>
</div>

<div id="screen-lobby" class="screen hidden" style="background:rgba(34,34,34,0.8);">
    <h2 style="font-family: 'Noto Serif JP', serif; font-weight:900; color:#f1c40f;" id="lobby-title">å†’é™ºè€…ã‚’å‹Ÿé›†ä¸­...</h2>
    <div style="background:#fff; padding:10px; border: 4px double #333;"><div id="qrcode"></div></div>
    <div id="lobby-url-container" onclick="copyUrl()">
        <p id="lobby-url" style="font-size:14px; color:#ccc; margin:5px; word-break:break-all;"></p>
        <span style="font-size:12px; color:#e67e22;">(ã‚¿ãƒƒãƒ—ã—ã¦URLã‚’ã‚³ãƒ”ãƒ¼)</span>
    </div>
    <div id="lobby-members" style="margin: 20px; font-size: 28px; color:#2ecc71;">å‚åŠ è€…: 0äºº</div>
    <button class="btn-title-start" id="btn-start-game" onclick="startGame()" disabled>ãƒ€ãƒ³ã‚¸ãƒ§ãƒ³ã¸æŒ‘ã‚€</button>
    <br><button class="btn-title-settings" onclick="showScreen('screen-title')">æˆ»ã‚‹</button>
</div>

<div id="screen-host" class="screen hidden">
    <div class="dungeon-header">
        <div class="floor-indicator">B<span id="disp-floor">1</span> <span style="font-size:20px;">/ <span id="max-floor-disp"></span></span></div>
        <div class="timer-box" id="game-timer">00:00</div>
    </div>
    
    <div class="enemy-area">
        <div id="slash-layer"></div>
        <img src="" id="enemy-img" class="enemy-img" style="display:none;">
        <div id="enemy-placeholder" style="font-size:120px; filter: drop-shadow(0 0 10px #fff);">ğŸ‘¾</div>
        
        <div class="question-box" id="question-text">---</div>
        
        <div style="margin-top:10px; height: 50px;">
            <button id="btn-open" onclick="openAnswers()" class="hidden btn-title-start" style="font-size:20px; padding:10px 30px;">å›ç­”ã‚ªãƒ¼ãƒ—ãƒ³</button>
            <div id="judge-ui" class="hidden">
                <span style="font-size:16px; background:#000; padding:5px; color:#e74c3c; border:2px solid #e74c3c;">è¢«ã‚Š(NG)ã‚’ã‚¿ãƒƒãƒ—ã—ã¦é¸æŠ</span>
                <button onclick="confirmJudgement()" class="btn-confirm btn-large">åˆ¤å®šç¢ºå®šï¼ˆæ”»æ’ƒï¼ï¼‰</button>
            </div>
        </div>
    </div>
    
    <div id="debug-panel" class="hidden">
        <button class="debug-btn win" onclick="debugTrigger(true)">æˆåŠŸ (Next)</button>
        <button class="debug-btn lose" onclick="debugTrigger(false)">å¤±æ•— (Back)</button>
    </div>

    <div class="answers-grid" id="answers-container"></div>
</div>

<div id="screen-result" class="screen hidden" style="background:#000;">
    <h1 id="res-title" style="font-family: 'Noto Serif JP', serif; font-weight:900; font-size: 80px; color: #f1c40f;">CLEAR</h1>
    <button class="btn-title-settings" onclick="location.reload()" style="font-size:24px; padding:15px 30px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
</div>

<div id="screen-login" class="screen hidden" style="background:#222;">
    <h2 style="color:#e67e22;">å†’é™ºè€…ã‚®ãƒ«ãƒ‰</h2>
    <input type="text" id="p-name-input" placeholder="åå‰" style="width:250px; font-size:24px; padding:10px;"><br><br>
    <button id="btn-player-join" class="btn-title-start" onclick="joinGame()" style="font-size:24px; padding:15px 40px;">ç™»éŒ²</button>
</div>

<div id="screen-player" class="screen hidden">
    <div class="player-status" id="p-status" style="font-size:28px; color:#f1c40f;">å¾…æ©Ÿä¸­...</div>
    <div style="background:#333; padding:20px; border:4px double #777; width:90%; margin-bottom:30px;">
        <div style="color:#aaa; font-size:14px;">ä»Šå›ã®ãŠé¡Œ</div>
        <div id="p-question" style="font-size:24px; font-weight:bold;"></div>
    </div>
    <input type="text" id="p-ans-input" placeholder="å›ç­”ã‚’å…¥åŠ›" style="width:90%; font-size:24px; padding:15px;"><br><br>
    <button class="btn-large" id="p-send-btn" onclick="sendAnswer()" style="width:90%; background:#27ae60; font-size:28px; padding:20px;">é€ä¿¡</button>
</div>

<div id="screen-debug-controller" class="hidden">
    <h3 style="color:#8e44ad; margin:10px;">ğŸ›  ãƒ‡ãƒãƒƒã‚°ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼</h3>
    <div id="debug-inputs-area" style="width:100%; display:flex; flex-direction:column; align-items:center;"></div>
    <button class="btn-large" style="position:sticky; bottom:20px; width:90%; background:#8e44ad;" onclick="sendDebugAnswers()">å…¨å›ç­”ã‚’ä¸€æ‹¬é€ä¿¡</button>
</div>

<script>
    const MAX_ASSETS = 7;
    const DB_NAME = 'AnswerDungeon_Permanent_Data'; 
    let config = { players: 4, time: 300, floors: 7, questions: [], assets: {}, titleBg: null, bgOpacity: 0.5, bgm: null };
    const DEFAULT_QS = [
        {text:"éƒ½é“åºœçœŒ(47)", count:47}, {text:"ä¸–ç•Œã®å›½(196)", count:196}, {text:"å…ƒç´ è¨˜å·(118)", count:118},
        {text:"å±±æ‰‹ç·šã®é§…(30)", count:30}, {text:"ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆ(26)", count:26}, {text:"å°†æ£‹ã®é§’(8)", count:8},
        {text:"å¹²æ”¯(12)", count:12}, {text:"æ˜Ÿåº§(12)", count:12}, {text:"å¤ªé™½ç³»ã®æƒ‘æ˜Ÿ(8)", count:8}, 
        {text:"è™¹ã®è‰²(7)", count:7}, {text:"ç¡¬è²¨ã®ç¨®é¡(6)", count:6}, {text:"äº”å¤§é™¸(5)", count:5}, 
        {text:"å­£ç¯€(4)", count:4}, {text:"ä¿¡å·æ©Ÿã®è‰²(3)", count:3}, {text:"ã˜ã‚ƒã‚“ã‘ã‚“ã®æ‰‹(3)", count:3}
    ];
    let peer, conn, myId, players = {}, connections = {}, currentFloor = 1, floorQuestions = {}, timerInterval, remainingTime;
    let isDebugMode = false;
    let debugControllerConn = null;

    function openDB() { return new Promise((r,j)=>{const q=indexedDB.open(DB_NAME,1);q.onupgradeneeded=e=>e.target.result.createObjectStore('config');q.onsuccess=()=>r(q.result);q.onerror=()=>j(q.error);}); }
    async function saveDB(k,v) { const d=await openDB(),t=d.transaction('config','readwrite');t.objectStore('config').put(v,k);return new Promise(r=>t.oncomplete=r); }
    async function loadDB(k) { const d=await openDB(),t=d.transaction('config','readonly'),r=t.objectStore('config').get(k);return new Promise(s=>r.onsuccess=()=>s(r.result)); }

    window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('host')) setupPeer(false, urlParams.get('host'));
        else { await loadSavedConfig(); initSetupUI(); showScreen('screen-title'); }
    };

    async function loadSavedConfig() {
        try {
            const saved = await loadDB('userConfig');
            if(saved) {
                config.questions = saved.questions || [];
                config.bgOpacity = saved.bgOpacity || 0.5;
                document.getElementById('bg-opacity').value = config.bgOpacity;
                updateOpacityDisp();
                if(saved.titleBg) { config.titleBg = URL.createObjectURL(saved.titleBg); setFileStatus('status-bg-title', true); }
                if(saved.bgm) { config.bgm = saved.bgm; document.getElementById('bgm-player').src = URL.createObjectURL(saved.bgm); document.getElementById('bgm-player').volume = 0.3; setFileStatus('status-bgm', true); }
                if(saved.assets) {
                    for(let i=1; i<=MAX_ASSETS; i++) {
                        config.assets[i] = { bg: null, enemy: null };
                        if(saved.assets[i]?.bg) config.assets[i].bg = URL.createObjectURL(saved.assets[i].bg);
                        if(saved.assets[i]?.enemy) config.assets[i].enemy = URL.createObjectURL(saved.assets[i].enemy);
                    }
                }
            }
        } catch(e) { console.error(e); }
    }

    async function saveOpacity() { config.bgOpacity = document.getElementById('bg-opacity').value; updateOpacityDisp(); await saveDB('userConfig', {...await loadDB('userConfig'), bgOpacity:config.bgOpacity}); }
    async function autoSaveAsset(type, input, floorIndex) {
        const file = input.files[0]; if(!file) return;
        const cur = await loadDB('userConfig') || {};
        if(type==='bgm') { cur.bgm=file; config.bgm=file; document.getElementById('bgm-player').src=URL.createObjectURL(file); setFileStatus('status-bgm',true); }
        else if(type==='titleBg') { cur.titleBg=file; config.titleBg=URL.createObjectURL(file); setFileStatus('status-bg-title',true); updateBackground(config.titleBg); }
        else if(type==='floorBg') { if(!cur.assets)cur.assets={}; if(!cur.assets[floorIndex])cur.assets[floorIndex]={}; cur.assets[floorIndex].bg=file; config.assets[floorIndex].bg=URL.createObjectURL(file); setFileStatus(`status-bg-${floorIndex}`,true); }
        else if(type==='floorEnemy') { if(!cur.assets)cur.assets={}; if(!cur.assets[floorIndex])cur.assets[floorIndex]={}; cur.assets[floorIndex].enemy=file; config.assets[floorIndex].enemy=URL.createObjectURL(file); setFileStatus(`status-en-${floorIndex}`,true); }
        await saveDB('userConfig', cur);
    }
    async function autoSaveQuestions() { const cur = await loadDB('userConfig') || {}; cur.questions = config.questions; await saveDB('userConfig', cur); }

    function setFileStatus(id,a){const e=document.getElementById(id);if(e){e.innerText=a?"âœ…ä¿å­˜æ¸ˆ":"æœªè¨­å®š";if(a)e.classList.add('active');else e.classList.remove('active');}}
    function updateOpacityDisp() { const v=document.getElementById('bg-opacity').value; document.getElementById('disp-opacity').innerText=Math.round(v*100)+"%"; document.getElementById('global-bg-img').style.opacity=v; }
    function updateBackground(src) { const i=document.getElementById('global-bg-img'); if(src){i.src=src;i.style.display="block";}else{i.style.display="none";} i.style.opacity=config.bgOpacity; }

    function initSetupUI() {
        if(!config.assets[1]) for(let i=1; i<=MAX_ASSETS; i++) config.assets[i] = { bg: null, enemy: null };
        const c = document.getElementById('visual-config-area'); c.innerHTML = "";
        for(let i=1; i<=MAX_ASSETS; i++) {
            const row = document.createElement('div'); row.className = 'floor-config-row';
            const b = config.assets[i]?.bg ? "active" : ""; const e = config.assets[i]?.enemy ? "active" : "";
            row.innerHTML = `<div class="floor-label">${i}F</div><label style="font-size:12px;">èƒŒæ™¯ <span id="status-bg-${i}" class="file-status ${b}">${b?"âœ…ä¿å­˜æ¸ˆ":"æœªè¨­å®š"}</span><br><input type="file" accept="image/*" style="width:130px;" onchange="autoSaveAsset('floorBg',this,${i})"></label><label style="font-size:12px;">æ•µ <span id="status-en-${i}" class="file-status ${e}">${e?"âœ…ä¿å­˜æ¸ˆ":"æœªè¨­å®š"}</span><br><input type="file" accept="image/*" style="width:130px;" onchange="autoSaveAsset('floorEnemy',this,${i})"></label>`;
            c.appendChild(row);
        }
        renderQuestionList();
    }
    function renderQuestionList() {
        const l = document.getElementById('question-list'); l.innerHTML = "";
        config.questions.forEach(q=>{ const i=document.createElement('div'); i.className='q-list-item'; i.innerHTML=`<span>${q.text}</span><span>(ç›®å®‰:${q.count})</span>`; l.appendChild(i); });
        document.getElementById('q-status').innerText = `${config.questions.length} å•`;
    }
    function addQuestion() {
        const t = document.getElementById('q-text').value, c = parseInt(document.getElementById('q-count').value);
        if(!t || !c) return alert("å…¥åŠ›ã—ã¦ãã ã•ã„");
        config.questions = config.questions.filter(q=>q.text!==t); config.questions.push({text:t,count:c});
        renderQuestionList(); autoSaveQuestions(); document.getElementById('q-text').value=""; document.getElementById('q-count').value="";
    }
    function saveSettingsAndBack() { showScreen('screen-title'); }
    async function copyUrl() { const t=document.getElementById('lobby-url').innerText; try{await navigator.clipboard.writeText(t);alert("ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ");}catch(e){alert("ã‚³ãƒ”ãƒ¼å¤±æ•—:"+e);} }

    function showStartOptions() { showScreen('screen-start-options'); }
    
    // --- LOBBY LOGIC ---
    function goToLobby() {
        config.players = parseInt(document.getElementById('opt-players').value);
        config.time = parseInt(document.getElementById('opt-time').value);
        config.floors = parseInt(document.getElementById('opt-floors').value);
        isDebugMode = false;
        prepareLobby();
    }

    function goToDebugLobby() {
        config.players = parseInt(document.getElementById('debug-opt-players').value);
        config.time = 999;
        config.floors = 7; 
        isDebugMode = true;
        document.getElementById('lobby-title').innerText = "ğŸ›  ãƒ‡ãƒãƒƒã‚°ãƒ¢ãƒ¼ãƒ‰å¾…æ©Ÿä¸­...";
        prepareLobby();
    }

    function prepareLobby() {
        if(config.questions.length===0) config.questions=[...DEFAULT_QS];
        try { generateFloorQuestions(); showScreen('screen-lobby'); if(!peer) setupPeer(true); } catch(e){ alert("åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:"+e); }
    }

    function generateFloorQuestions() {
        let v = config.questions.filter(q=>q.count>=config.players);
        v = v.filter((val,i,a)=>a.findIndex(t=>(t.text===val.text))===i);
        if(v.length===0) v=[...config.questions];
        v.sort((a,b)=>b.count-a.count);
        for(let i=1; i<=config.floors; i++) {
            const t = v.length, s = Math.floor((i-1)*t/config.floors), e = Math.floor(i*t/config.floors);
            let b = v.slice(s,e); if(b.length===0) b=[v[Math.min(s,t-1)]];
            floorQuestions[i] = b[Math.floor(Math.random()*b.length)].text;
        }
    }

    // --- PEER JS ---
    function setupPeer(isHost, hostId=null) {
        peer = new Peer();
        peer.on('open', id => {
            myId = id;
            if(isHost) {
                const url = `${location.href.split('?')[0]}?host=${myId}`;
                new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });
                document.getElementById('lobby-url').innerText = url;
            } else showScreen('screen-login');
        });
        peer.on('connection', c => { 
            c.on('open', () => {
                c.on('data', d => handleData(c, d));
                c.on('close', () => removePlayer(c.peer));
            });
            connections[c.peer] = c;
        });
        peer.on('error', e => alert("Connection Error: "+e));
    }

    function handleData(c, data) {
        if(data.type === 'JOIN') {
            if(isDebugMode) {
                debugControllerConn = c;
                players = {};
                for(let i=1; i<=config.players; i++) {
                    players[`debug_p${i}`] = { name: `Player ${i}`, answer: null, id: `debug_p${i}` };
                }
                c.send({ type: 'DEBUG_INIT', count: config.players });
                updateLobby();
            } else {
                players[c.peer] = { name: data.name, answer: null, id: c.peer };
                updateLobby(); c.send({ type: 'JOIN_OK' });
            }
        } else if (data.type === 'ANSWER') {
            if(players[c.peer]) { players[c.peer].answer = data.answer; updateGridHost(); }
        } else if (data.type === 'DEBUG_ANSWERS') {
            const answers = data.answers;
            let idx = 0;
            Object.keys(players).forEach(pid => {
                if(idx < answers.length) players[pid].answer = answers[idx];
                idx++;
            });
            updateGridHost();
        }
    }

    function removePlayer(peerId) {
        if(players[peerId]) { delete players[peerId]; updateLobby(); updateGridHost(); }
    }

    function updateLobby() {
        const cnt = Object.keys(players).length;
        document.getElementById('lobby-members').innerText = `å‚åŠ è€…: ${cnt}äºº / ${config.players}äºº`;
        if(cnt >= 1) document.getElementById('btn-start-game').disabled = false;
        else document.getElementById('btn-start-game').disabled = true;
    }

    function startGame() {
        if(Object.keys(players).length === 0) return alert("å‚åŠ è€…ãŒã„ã¾ã›ã‚“");
        if(Object.keys(floorQuestions).length === 0) try{generateFloorQuestions()}catch(e){return alert(e)};
        
        const audio = document.getElementById('bgm-player');
        if(audio.src) audio.play().catch(e=>console.log(e));
        
        if(isDebugMode) {
            if(debugControllerConn) debugControllerConn.send({ type: 'START' });
        } else {
            broadcast({ type: 'START' });
        }
        
        currentFloor = 1; remainingTime = config.time;
        showScreen('screen-host'); startTimer(); loadFloor();
    }

    function loadFloor() {
        document.getElementById('screen-host').classList.remove('shake-screen');
        const assetIndex = (MAX_ASSETS - config.floors) + currentFloor;
        const asset = config.assets[assetIndex] || { bg: null, enemy: null };
        updateBackground(asset.bg);

        const enemyImg = document.getElementById('enemy-img');
        const enemyPh = document.getElementById('enemy-placeholder');
        enemyImg.style.opacity = "0"; 
        
        // V5.1: Size & Position Logic
        let scale = 0.9; // Default for 4, 6, 7
        let topPos = "80px"; // Default top

        if (currentFloor <= 3) {
            scale = 0.6 + (currentFloor * 0.1); // 0.7, 0.8, 0.9
        } else if (currentFloor === 5) {
            scale = 0.9;
            topPos = "calc(80px - 20vh)"; // Shift UP by 20vh
        }

        if (asset.enemy) { 
            enemyImg.src = asset.enemy; enemyImg.style.display = "block"; 
            enemyImg.style.height = "85vh"; // Base size
            enemyImg.style.top = topPos;
            enemyImg.style.transform = `translateX(-50%) scale(${scale})`; 
            enemyImg.onload = () => { enemyImg.style.opacity = "1"; }; enemyPh.style.display = "none"; 
        } else { enemyImg.style.display = "none"; enemyPh.style.display = "block"; enemyPh.style.opacity = "1"; }
        
        document.getElementById('disp-floor').innerText = currentFloor;
        document.getElementById('max-floor-disp').innerText = config.floors;
        const qText = floorQuestions[currentFloor] || "ã‚¨ãƒ©ãƒ¼";
        document.getElementById('question-text').innerText = qText;
        Object.keys(players).forEach(id => players[id].answer = null);
        
        document.getElementById('btn-open').classList.add('hidden');
        document.getElementById('judge-ui').classList.add('hidden');
        updateGridHost();
        
        if(isDebugMode) {
            document.getElementById('debug-panel').classList.remove('hidden');
            if(debugControllerConn) debugControllerConn.send({ type: 'QUESTION', text: qText });
        } else {
            document.getElementById('debug-panel').classList.add('hidden');
            broadcast({ type: 'QUESTION', text: qText });
        }
    }

    function updateGridHost() {
        const c = document.getElementById('answers-container');
        if(!document.getElementById('btn-open').classList.contains('hidden') || !document.getElementById('judge-ui').classList.contains('hidden')) return;
        c.innerHTML = "";
        Object.values(players).forEach(p => {
            const card = document.createElement('div'); card.className = "answer-card";
            if(p.answer) { card.innerHTML = `<div class="p-name">${p.name}</div><div class="p-ans" style="color:#f39c12">å›ç­”æ¸ˆ</div>`; }
            else { card.innerHTML = `<div class="p-name">${p.name}</div><div class="p-ans" style="color:#555">...</div>`; }
            c.appendChild(card);
        });
        let ansCount = Object.values(players).filter(p => p.answer).length;
        if(ansCount === Object.keys(players).length && ansCount > 0) document.getElementById('btn-open').classList.remove('hidden');
    }

    function openAnswers() {
        document.getElementById('btn-open').classList.add('hidden');
        const c = document.getElementById('answers-container'); c.innerHTML = "";
        const counts = {};
        Object.values(players).forEach(p => { if(!p.answer) return; const v = p.answer.trim().toLowerCase(); counts[v] = (counts[v] || 0) + 1; });
        Object.values(players).forEach(p => {
            const card = document.createElement('div'); card.className = "answer-card";
            card.innerHTML = `<div class="p-name">${p.name}</div><div class="p-ans">${p.answer}</div>`;
            if(counts[p.answer.trim().toLowerCase()] > 1) card.classList.add('selected-ng');
            card.onclick = () => card.classList.toggle('selected-ng');
            c.appendChild(card);
        });
        document.getElementById('judge-ui').classList.remove('hidden');
    }

    function confirmJudgement() {
        const isFail = document.querySelectorAll('.answer-card.selected-ng').length > 0;
        document.getElementById('judge-ui').classList.add('hidden');
        if(isFail) {
            document.getElementById('screen-host').classList.add('shake-screen');
            setTimeout(() => {
                document.getElementById('screen-host').classList.remove('shake-screen');
                if(currentFloor === 1) endGame(false); else { currentFloor--; loadFloor(); }
            }, 1000);
        } else {
            const slash = document.getElementById('slash-layer'); slash.style.display = 'block'; slash.classList.add('slash-effect');
            document.getElementById('enemy-img').style.opacity = 0; document.getElementById('enemy-placeholder').style.opacity = 0;
            setTimeout(() => {
                slash.classList.remove('slash-effect'); slash.style.display = 'none';
                if(currentFloor === config.floors) endGame(true); else { currentFloor++; loadFloor(); }
            }, 500);
        }
    }

    function debugTrigger(isSuccess) {
        if(isSuccess) {
            const slash = document.getElementById('slash-layer'); slash.style.display = 'block'; slash.classList.add('slash-effect');
            document.getElementById('enemy-img').style.opacity = 0; document.getElementById('enemy-placeholder').style.opacity = 0;
            setTimeout(() => {
                slash.classList.remove('slash-effect'); slash.style.display = 'none';
                if(currentFloor === config.floors) endGame(true); else { currentFloor++; loadFloor(); }
            }, 500);
        } else {
            document.getElementById('screen-host').classList.add('shake-screen');
            setTimeout(() => {
                document.getElementById('screen-host').classList.remove('shake-screen');
                if(currentFloor === 1) endGame(false); else { currentFloor--; loadFloor(); }
            }, 1000);
        }
    }

    function startTimer() {
        const el = document.getElementById('game-timer');
        if(timerInterval) clearInterval(timerInterval);
        timerInterval = setInterval(() => {
            remainingTime--;
            const m = Math.floor(remainingTime/60).toString().padStart(2,'0'), s = (remainingTime%60).toString().padStart(2,'0');
            el.innerText = `${m}:${s}`;
            if(remainingTime<=30) el.classList.add('timer-warning');
            if(remainingTime<=0) { clearInterval(timerInterval); endGame(false); }
        }, 1000);
    }

    function endGame(isClear) {
        clearInterval(timerInterval); showScreen('screen-result');
        const t = document.getElementById('res-title');
        t.innerText = isClear ? "GAME CLEAR!!" : "GAME OVER"; t.style.color = isClear ? "#f1c40f" : "#e74c3c";
        if(isDebugMode) { if(debugControllerConn) debugControllerConn.send({ type: 'END', isClear }); }
        else broadcast({ type: 'END', isClear });
    }

    function broadcast(data) { Object.values(connections).forEach(c => c.send(data)); }

    // --- PLAYER & CONTROLLER LOGIC ---
    let hostConn;
    function joinGame() {
        const name = document.getElementById('p-name-input').value;
        if(!name) return alert("åå‰ã‚’å…¥åŠ›");
        
        const btn = document.getElementById('btn-player-join'); btn.disabled = true; btn.innerText = "æ¥ç¶šä¸­...";
        const urlParams = new URLSearchParams(window.location.search);
        const hId = urlParams.get('host');
        if(!hId) { alert("ãƒ›ã‚¹ãƒˆIDãªã—"); btn.disabled = false; return; }

        hostConn = peer.connect(hId);
        const tm = setTimeout(() => { if(!hostConn.open) { alert("æ¥ç¶šå¤±æ•—"); btn.disabled = false; } }, 5000);

        hostConn.on('open', () => {
            clearTimeout(tm);
            hostConn.send({ type:'JOIN', name:name });
            // Screen handling upon receiving data
        });
        hostConn.on('error', e => { clearTimeout(tm); alert("æ¥ç¶šã‚¨ãƒ©ãƒ¼: "+e); btn.disabled = false; });

        hostConn.on('data', d => {
            if(d.type === 'DEBUG_INIT') {
                showScreen('screen-debug-controller');
                initDebugController(d.count);
            } else if(d.type === 'JOIN_OK') {
                showScreen('screen-player');
            } else if(d.type === 'START') {
                document.getElementById('p-status').innerText = "ã‚²ãƒ¼ãƒ é–‹å§‹ï¼";
            } else if(d.type === 'QUESTION') {
                document.getElementById('p-status').innerText = "å›ç­”ã—ã¦ãã ã•ã„";
                document.getElementById('p-question').innerText = d.text;
                document.getElementById('p-ans-input').value = ""; document.getElementById('p-ans-input').disabled = false;
                document.getElementById('p-send-btn').disabled = false; document.getElementById('p-send-btn').innerText = "é€ä¿¡"; document.getElementById('p-send-btn').style.background = "#27ae60";
                document.querySelectorAll('.debug-p-input').forEach(i => { i.value = ""; i.disabled = false; });
            } else if(d.type === 'END') {
                document.getElementById('p-status').innerText = d.isClear ? "ã‚¯ãƒªã‚¢ï¼" : "çµ‚äº†...";
            }
        });
    }

    function initDebugController(count) {
        const area = document.getElementById('debug-inputs-area');
        area.innerHTML = "";
        for(let i=1; i<=count; i++) {
            const div = document.createElement('div'); div.className = "debug-input-row";
            div.innerHTML = `<div class="debug-p-label">Player ${i}</div><input type="text" class="debug-p-input" id="dbg-in-${i}" placeholder="å›ç­”">`;
            area.appendChild(div);
        }
    }

    function sendDebugAnswers() {
        const inputs = document.querySelectorAll('.debug-p-input');
        const answers = Array.from(inputs).map(i => i.value);
        hostConn.send({ type: 'DEBUG_ANSWERS', answers: answers });
        inputs.forEach(i => i.disabled = true);
    }

    function sendAnswer() {
        const val = document.getElementById('p-ans-input').value;
        if(!val) return;
        hostConn.send({ type:'ANSWER', answer:val });
        document.getElementById('p-status').innerText = "å¾…æ©Ÿä¸­...";
        document.getElementById('p-ans-input').disabled = true;
        document.getElementById('p-send-btn').disabled = true;
        document.getElementById('p-send-btn').innerText = "é€ä¿¡æ¸ˆ";
        document.getElementById('p-send-btn').style.background = "#555";
    }

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(e => e.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if(id === 'screen-title' || id === 'screen-setup' || id === 'screen-lobby') updateBackground(config.titleBg);
    }
</script>
</body>
</html>
