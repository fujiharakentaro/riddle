<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bluff Quiz Master V10</title>
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: #222; color: #fff; margin: 0; padding: 20px; text-align: center; }
        h1 { color: #f39c12; text-shadow: 2px 2px #000; margin-bottom: 20px; }
        .hidden { display: none !important; }
        .screen { max-width: 800px; margin: 0 auto; background: #333; padding: 20px; border-radius: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.5); min-height: 400px; position: relative; }
        
        /* Input & Button */
        input, textarea { width: 90%; padding: 10px; margin: 5px 0; border-radius: 5px; border: none; font-size: 16px; }
        button { background: #e74c3c; color: white; border: none; padding: 10px 20px; border-radius: 5px; font-size: 18px; cursor: pointer; margin: 10px; transition: 0.2s; }
        button:hover { background: #c0392b; }
        button:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
        
        /* Layouts */
        .title-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 300px; }
        .btn-gear { position: absolute; top: 15px; right: 15px; background: none; border: none; font-size: 30px; cursor: pointer; padding: 0; margin: 0; }
        .btn-gear:hover { transform: rotate(90deg); transition: 0.3s; }
        .btn-big-start { width: 200px; height: 200px; border-radius: 50%; background: #e74c3c; font-size: 28px; font-weight: bold; box-shadow: 0 10px 0 #c0392b, 0 10px 20px rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; margin: 0 auto; }
        .btn-big-start:active { box-shadow: 0 5px 0 #c0392b, 0 5px 10px rgba(0,0,0,0.5); transform: translateY(5px); }
        .btn-lobby-back { position: absolute; top: 15px; left: 15px; background: #7f8c8d; font-size: 12px; padding: 5px 10px; }

        /* Specific Buttons */
        .btn-back { background: #7f8c8d; font-size: 14px; padding: 5px 15px; }
        .btn-opt { background: #3498db; width: 100%; margin: 10px 0; text-align: left; }
        .btn-copy { background: #27ae60; font-size: 14px; padding: 5px 10px; }
        .btn-start-q { background: #e67e22; font-weight: bold; width: 45%; margin: 5px; }
        .btn-judge-qr { background: #8e44ad; font-size: 14px; padding: 5px 10px; margin-left: 10px; }
        .btn-publish { background: #e67e22; width: 90%; font-weight: bold; padding: 15px; position: sticky; bottom: 10px; box-shadow: 0 0 15px rgba(0,0,0,0.5); }

        /* Judge Toggle */
        .judge-toggle { display: flex; width: 100%; margin-top: 5px; }
        .judge-toggle button { flex: 1; margin: 2px; font-size: 14px; padding: 8px; border: 2px solid #555; background: #333; color: #aaa; }
        .judge-toggle button.selected-adopt { background: #3498db; color: #fff; border-color: #3498db; }
        .judge-toggle button.selected-correct { background: #f1c40f; color: #000; border-color: #f1c40f; }

        /* QR Section */
        #qrcode-lobby, #qrcode-reg { margin: 10px auto; background: #fff; padding: 10px; width: 128px; }
        .judge-access-box { border: 2px solid #8e44ad; padding: 10px; border-radius: 10px; margin-top: 20px; background: #2c2c2c; }
        
        /* Lists & Status */
        ul { list-style: none; padding: 0; }
        li { background: #444; margin: 5px 0; padding: 10px; border-radius: 5px; position: relative; }
        .status { font-weight: bold; color: #2ecc71; margin: 10px 0; }
        .big-text { font-size: 32px; font-weight: bold; margin: 30px 0; line-height: 1.4; color: #f1c40f; }
        .waiting-text { font-size: 24px; color: #aaa; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .score-box { display: flex; justify-content: space-between; border-bottom: 1px solid #555; padding: 5px; }
        .voter-tag { display: inline-block; background: #9b59b6; color: #fff; font-size: 12px; padding: 2px 6px; border-radius: 4px; margin-left: 5px; vertical-align: middle; }
        .author-tag { display: block; font-size: 12px; color: #aaa; text-align: right; margin-top: 5px; }
        .opt-row { text-align: left; font-size: 20px; padding: 15px; }
        .real-answer-box { border: 2px solid #2ecc71; background: rgba(46, 204, 113, 0.1); }
        
        .judge-info-box { background: #222; padding: 10px; border: 1px solid #555; border-radius: 5px; margin-bottom: 10px; text-align: left; }
        .input-status-row { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 1px solid #555; }
        .status-badge { padding: 2px 8px; border-radius: 4px; font-size: 12px; }
        .badge-wait { background: #7f8c8d; }
        .badge-done { background: #3498db; }
        .badge-correct { background: #f1c40f; color: #000; font-weight: bold; }
    </style>
</head>
<body>

<div id="host-title" class="screen hidden">
    <h1>Bluff Quiz Master V10</h1>
    <button class="btn-gear" onclick="goToQRegistration()" title="問題登録">⚙️</button>
    <div class="title-container">
        <button class="btn-big-start" onclick="goToGameSettings()">GAME<br>START</button>
    </div>
</div>

<div id="host-q-reg" class="screen hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>問題登録</h2>
        <button class="btn-back" onclick="goToTitle()">＜ タイトルへ</button>
    </div>
    
    <div style="text-align: left; margin-bottom: 20px;">
        <input type="text" id="new-q" placeholder="問題文 (例: 英単語「Aglet」の意味は？)">
        <input type="text" id="new-a" placeholder="正解 (例: 靴紐の先端の固い部分)">
        <button onclick="addQuestion()" style="width:100%; margin:10px 0;">追加する</button>
    </div>
    
    <div style="background:#222; padding:10px; border-radius:5px; margin-top:10px; text-align:left; max-height: 200px; overflow-y: auto;">
        <h4>登録済みリスト</h4>
        <ul id="q-list-display"></ul>
    </div>

    <div class="judge-access-box">
        <h3 style="color:#8e44ad; margin:0;">【判定役用アクセス】</h3>
        <p style="font-size:12px; margin:5px 0;">ホストのスマホで読み込んでください。<br>URLは固定です。一度繋げばOK！</p>
        <div style="display:flex; justify-content:center; align-items:center;">
            <div id="qrcode-reg">QR生成中...</div>
            <div style="margin-left:20px; text-align:left;">
                <input type="text" id="judge-url-input" readonly style="width:150px; font-size:10px;">
                <button class="btn-copy" onclick="copyUrl('judge-url-input')">コピー</button>
            </div>
        </div>
    </div>
</div>

<div id="host-settings" class="screen hidden">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h2>人数設定</h2>
        <button class="btn-back" onclick="goToTitle()">＜ タイトルへ</button>
    </div>
    <div style="margin: 40px 0;">
        <p style="font-size:20px;">参加人数を設定してください</p>
        <input type="number" id="player-count" value="3" min="2" style="width: 80px; font-size:24px; text-align:center;">
        <span style="font-size:24px;"> 人</span>
    </div>
    <button class="btn-big-start" style="width:150px; height:150px; font-size:20px;" onclick="goToLobby()">部屋を開く</button>
</div>

<div id="host-lobby" class="screen hidden">
    <button class="btn-lobby-back" onclick="backToSettings()">＜ 設定に戻る</button>
    <h1 id="lobby-title">参加者待機中...</h1>
    
    <div style="display:flex; justify-content:center; align-items:center; flex-direction:column;">
        <div id="qrcode-lobby"></div>
        <div>
            <input type="text" id="room-url-input" readonly style="width:200px; font-size:12px;">
            <button class="btn-copy" onclick="copyUrl('room-url-input')">URLコピー</button>
        </div>
        <p id="qr-desc" style="font-size:12px; color:#aaa; margin-top:5px;">参加者はこのQRを読み込んでください</p>
    </div>

    <div class="status">現在の参加者: <span id="joined-count">0</span> / <span id="max-count">0</span></div>
    <div style="font-size:12px; color:#aaa;">※判定役は人数に含まれません</div>
    <ul id="player-list"></ul>
    
    <div id="q-selector" style="border-top:1px solid #555; margin-top:20px; padding-top:10px;">
        <h3>▼ ゲームスタート（問題選択） ▼</h3>
        <div id="q-buttons" style="display:flex; flex-wrap:wrap; justify-content:center;"></div>
    </div>
</div>

<div id="host-waiting-phase" class="screen hidden">
    <h1 style="color:#aaa;">回答募集中</h1>
    <div class="big-text" id="host-wait-q-text"></div>
    <p class="waiting-text">参加者が回答を作成しています...</p>
    <hr>
    <div id="input-status-list" style="text-align:left; background:#222; padding:10px; border-radius:5px;"></div>
    <div class="status">回答済み: <span id="input-done-count">0</span> 人</div>
</div>

<div id="host-vote-phase" class="screen hidden">
    <h1>正解はどれだ！？</h1>
    <div class="big-text" id="vote-q-text"></div>
    <div style="font-size:20px; font-weight:bold; color:#f1c40f; margin-bottom:10px;">▼ 選択肢 ▼</div>
    <ul id="options-display"></ul>
    
    <div id="voting-status-msg">
        <p class="waiting-text">投票を待っています...</p>
        <div class="status">投票済み: <span id="vote-done-count">0</span> 人</div>
    </div>
    <button id="btn-show-result" class="hidden" onclick="calcResults()">結果発表へ</button>
</div>

<div id="host-result" class="screen hidden">
    <h1>結果発表</h1>
    <h2 id="real-answer-display" style="color:#2ecc71;"></h2>
    <div style="text-align: left;">
        <h3>選択肢の詳細</h3>
        <ul id="options-detail-list"></ul>
    </div>
    <hr>
    <h3>現在のトータルスコア</h3>
    <div id="total-scores" style="text-align: left;"></div>
    <button onclick="backToLobby()">次の問題へ</button>
</div>


<div id="client-connecting" class="screen hidden">
    <h2>接続中...</h2>
    <p>ホストを探しています</p>
</div>

<div id="client-login" class="screen hidden">
    <h1>参加登録</h1>
    <p>ニックネームを入力してください</p>
    <input type="text" id="my-name" placeholder="名前 (例: タナカ)">
    <button onclick="joinGame('player')">ゲームに参加</button>
</div>

<div id="client-wait" class="screen hidden">
    <h2>待機中...</h2>
    <p id="client-wait-msg">ホストが問題を選ぶのを待っています</p>
</div>

<div id="client-input" class="screen hidden">
    <h2>問題</h2>
    <p id="cli-q-text" style="font-weight: bold; font-size:18px;"></p>
    <hr>
    <p>みんなを騙す「偽の正解」を入力せよ！</p>
    <input type="text" id="fake-answer" placeholder="偽の答え...">
    <button onclick="submitFakeAnswer()">送信</button>
</div>

<div id="client-judge-panel" class="screen hidden">
    <h2 style="color:#3498db; margin-bottom:5px;">[判定役] 管理画面</h2>
    <p id="judge-status" style="font-size:12px; color:#2ecc71;">接続完了</p>
    
    <div class="judge-info-box">
        <div style="color:#aaa; font-size:12px;">問題:</div>
        <div id="judge-q-text" style="font-weight:bold; margin-bottom:5px;">(問題選択待ち)</div>
        <div style="color:#aaa; font-size:12px;">正解:</div>
        <div id="judge-a-text" style="color:#2ecc71; font-weight:bold;"></div>
    </div>
    
    <div id="judge-answer-list" style="margin-bottom:60px;">
        <p style="font-size:12px; color:#aaa;">回答が届くとここに表示されます</p>
    </div>

    <button class="btn-publish" onclick="publishAndStartVote()">確定して出題する</button>
</div>

<div id="client-vote" class="screen hidden">
    <h2>どれが正解？</h2>
    <div id="cli-options"></div>
    <div id="cli-vote-wait" class="hidden">
        <p style="color:#2ecc71; font-weight:bold; font-size:20px;">正解！！</p>
        <p>あなたは正解を知っていたので投票はお休みです。<br>高みの見物をお楽しみください。</p>
    </div>
</div>

<div id="client-result" class="screen hidden">
    <h2>結果</h2>
    <p id="cli-result-msg"></p>
    <p>次の問題を待っています...</p>
</div>


<script>
    // --- Global Variables ---
    let peer, conn;
    let myId = null;
    let hostConn = null; 
    let connections = {}; 
    
    let players = {}; 
    let judgeConn = null; 

    let judgeLocalData = {}; 

    let questions = [
        {q: "「たほいや」の意味は？", a: "イノシシを追い払う小屋"},
        {q: "「アグレット」の意味は？", a: "靴紐の先端の固い部分"},
    ];
    let currentQ = null; 
    let maxPlayers = 3;
    let isHost = false;
    let myRole = 'player'; 

    // --- Init ---
    window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const hostId = urlParams.get('host');
        const roleParam = urlParams.get('role');

        if (hostId) {
            isHost = false;
            initClient(hostId, roleParam);
        } else {
            isHost = true;
            initHostPeer();
        }
    };

    // ================= HOST SETUP & LOGIC =================

    function initHostPeer() {
        peer = new Peer();
        peer.on('open', (id) => {
            myId = id;
            console.log("Host ID:", myId);
            goToTitle();
            renderJudgeQr();
            peer.on('connection', (c) => { c.on('open', () => setupHostConnection(c)); });
        });
    }

    function setupHostConnection(c) {
        c.on('data', (data) => {
            if (data.type === 'JOIN') {
                connections[c.peer] = c;
                if(data.role === 'judge') {
                    judgeConn = c;
                    console.log("Judge Connected");
                    syncJudgeState();
                } else {
                    players[c.peer] = { name: data.name, score: 0, fakeAnswer: '', vote: '', status: 'waiting' };
                    updatePlayerList();
                }
            } 
            else if (data.type === 'FAKE_ANSWER') {
                players[c.peer].fakeAnswer = data.answer; 
                players[c.peer].status = 'submitted';
                updateHostWaitingStatus(); 
                if(judgeConn) {
                    judgeConn.send({
                        type: 'JUDGE_NEW_ANSWER',
                        playerId: c.peer,
                        playerName: players[c.peer].name,
                        answer: data.answer
                    });
                }
            }
            else if (data.type === 'JUDGE_BATCH_DECISION') {
                processBatchDecision(data.decisions);
            }
            else if (data.type === 'VOTE') {
                players[c.peer].vote = data.vote; 
                checkAllVotesReceived();
            }
        });
    }

    function syncJudgeState() {
        if(!judgeConn) return;
        judgeConn.send({ type: 'JUDGE_CONNECTED' });
        if(currentQ) {
            judgeConn.send({ type: 'JUDGE_INIT_Q', q: currentQ.q, a: currentQ.a });
            Object.keys(players).forEach(pid => {
                if(players[pid].fakeAnswer) {
                    judgeConn.send({
                        type: 'JUDGE_NEW_ANSWER',
                        playerId: pid,
                        playerName: players[pid].name,
                        answer: players[pid].fakeAnswer
                    });
                }
            });
        }
    }

    // ================= HOST NAVIGATION =================
    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
    }
    function goToTitle() { showScreen('host-title'); }
    function goToQRegistration() { renderQList(); showScreen('host-q-reg'); }
    function goToGameSettings() { showScreen('host-settings'); }
    function backToSettings() { goToGameSettings(); }

    function addQuestion() {
        const q = document.getElementById('new-q').value;
        const a = document.getElementById('new-a').value;
        if(q && a){
            questions.push({q, a});
            document.getElementById('new-q').value = "";
            document.getElementById('new-a').value = "";
            renderQList();
        }
    }

    function renderQList() {
        const list = document.getElementById('q-list-display');
        list.innerHTML = questions.map((item, i) => `<li>問題${i+1}: ${item.q} <br><span style="font-size:12px; color:#aaa;">(答: ${item.a})</span></li>`).join('');
        const btnDiv = document.getElementById('q-buttons');
        btnDiv.innerHTML = questions.map((item, i) => `<button class="btn-start-q" onclick="startGame(${i})">問題 ${i+1} をスタート</button>`).join('');
    }

    function renderJudgeQr() {
        const qrEl = document.getElementById("qrcode-reg");
        qrEl.innerHTML = "";
        const url = `${location.href.split('?')[0]}?host=${myId}&role=judge`;
        new QRCode(qrEl, { text: url, width: 128, height: 128 });
        document.getElementById('judge-url-input').value = url;
    }

    function goToLobby() {
        maxPlayers = parseInt(document.getElementById('player-count').value);
        document.getElementById('max-count').innerText = maxPlayers;
        const qrEl = document.getElementById("qrcode-lobby");
        qrEl.innerHTML = "";
        const url = `${location.href.split('?')[0]}?host=${myId}`;
        new QRCode(qrEl, { text: url, width: 128, height: 128 });
        document.getElementById('room-url-input').value = url;
        showScreen('host-lobby');
    }

    function copyUrl(inputId) {
        const copyText = document.getElementById(inputId);
        copyText.select();
        navigator.clipboard.writeText(copyText.value).then(() => alert("URLをコピーしました！"));
    }

    function updatePlayerList() {
        const list = document.getElementById('player-list');
        list.innerHTML = Object.values(players).map(p => `<li>${p.name} (Pt: ${p.score})</li>`).join('');
        document.getElementById('joined-count').innerText = Object.keys(players).length;
    }

    // --- Phase 1: Start Q ---
    function startGame(qIndex) {
        currentQ = questions[qIndex];
        Object.keys(players).forEach(pid => {
            players[pid].fakeAnswer = ''; players[pid].vote = ''; players[pid].status = 'waiting';
        });
        broadcast({ type: 'START_INPUT', q: currentQ.q });
        
        if(judgeConn) judgeConn.send({ type: 'JUDGE_INIT_Q', q: currentQ.q, a: currentQ.a });

        document.getElementById('host-wait-q-text').innerText = currentQ.q;
        updateHostWaitingStatus();
        showScreen('host-waiting-phase');
    }

    function updateHostWaitingStatus() {
        const submitted = Object.values(players).filter(p => p.status !== 'waiting').length;
        document.getElementById('input-done-count').innerText = `${submitted} / ${Object.keys(players).length}`;
        const list = document.getElementById('input-status-list');
        list.innerHTML = Object.values(players).map(p => {
            let badge = `<span class="status-badge badge-wait">回答中...</span>`;
            if (p.status !== 'waiting') badge = `<span class="status-badge badge-done">提出済み</span>`;
            if (p.status === 'correct') badge = `<span class="status-badge badge-correct">正解！ (+1pt)</span>`;
            return `<div class="input-status-row"><span>${p.name}</span> ${badge}</div>`;
        }).join('');
    }

    // --- Phase 2: From Judge Decision ---
    function processBatchDecision(decisions) {
        let correctNames = [];
        Object.keys(decisions).forEach(pid => {
            const decision = decisions[pid];
            if(players[pid]) {
                if(decision === 'CORRECT') {
                    players[pid].status = 'correct';
                    players[pid].score += 1;
                    correctNames.push(players[pid].name);
                } else {
                    players[pid].status = 'approved';
                }
            }
        });
        updateHostWaitingStatus();
        startVotingPhase(correctNames);
    }

    function startVotingPhase(correctNames) {
        let options = [{ text: currentQ.a, owner: 'SYSTEM' }];
        Object.keys(players).forEach(pid => {
            if (players[pid].status === 'approved') {
                options.push({ text: players[pid].fakeAnswer, owner: pid });
            }
        });
        options = shuffle(options);
        currentQ.currentOptions = options;

        Object.keys(connections).forEach(cid => {
            if (connections[cid] === judgeConn) return; 
            if (players[cid] && players[cid].status === 'correct') {
                connections[cid].send({ type: 'WAIT_VOTE_CORRECT' });
            } else if (players[cid]) {
                connections[cid].send({ type: 'START_VOTE', options: options.map(o => o.text) });
            }
        });

        document.getElementById('vote-q-text').innerText = currentQ.q;
        document.getElementById('vote-done-count').innerText = "0";
        document.getElementById('voting-status-msg').classList.remove('hidden');
        document.getElementById('btn-show-result').classList.add('hidden');
        renderHostVoteOptions();
        showScreen('host-vote-phase');
    }

    function renderHostVoteOptions(showVotes = false) {
        const options = currentQ.currentOptions;
        const list = document.getElementById('options-display');
        list.innerHTML = options.map((o, i) => {
            let voteTags = "";
            if (showVotes) {
                Object.keys(players).forEach(pid => {
                    if (players[pid].vote !== '' && parseInt(players[pid].vote) === i) {
                        voteTags += `<span class="voter-tag">${players[pid].name}</span>`;
                    }
                });
            }
            return `<li class="opt-row">${i+1}. ${o.text} ${voteTags}</li>`;
        }).join('');
    }

    function checkAllVotesReceived() {
        const voters = Object.keys(players).filter(pid => players[pid].status === 'approved');
        const done = voters.filter(pid => players[pid].vote !== '').length;
        document.getElementById('vote-done-count').innerText = `${done} / ${voters.length}`;
        if ((done === voters.length && voters.length > 0) || voters.length === 0) {
            document.getElementById('voting-status-msg').classList.add('hidden');
            document.getElementById('btn-show-result').classList.remove('hidden');
            renderHostVoteOptions(true);
        }
    }

    function calcResults() {
        const options = currentQ.currentOptions;
        let detailLog = "";
        Object.keys(players).forEach(pid => {
            if(players[pid].status === 'approved' && players[pid].vote !== '') {
                const p = players[pid];
                const votedIndex = parseInt(p.vote);
                const votedOption = options[votedIndex];
                if (votedOption.owner === 'SYSTEM') {
                    p.score += 1;
                } else {
                    if (votedOption.owner !== pid) {
                        const liarId = votedOption.owner;
                        if(players[liarId]) players[liarId].score += 1;
                    }
                }
            }
        });

        options.forEach((opt, i) => {
            let authorName = "";
            let liClass = "";
            if (opt.owner === 'SYSTEM') {
                authorName = "★正解"; liClass = "real-answer-box";
            } else {
                authorName = players[opt.owner] ? `作者: ${players[opt.owner].name}` : "Unknown";
            }
            let voters = [];
            Object.keys(players).forEach(pid => {
                if (players[pid].vote !== '' && parseInt(players[pid].vote) === i) voters.push(players[pid].name);
            });
            let votersText = voters.length > 0 ? `→ 投票: ${voters.join(', ')}` : "";
            detailLog += `<li class="${liClass}">
                <div style="font-size:18px; font-weight:bold;">${opt.text}</div>
                <div class="author-tag">${authorName} ${votersText}</div>
            </li>`;
        });

        const earlyCorrects = Object.values(players).filter(p => p.status === 'correct');
        if (earlyCorrects.length > 0) {
            const names = earlyCorrects.map(p => p.name).join(', ');
            detailLog += `<li style="background:#f1c40f; color:#000; margin-top:20px;">
                <div style="font-weight:bold;">選択肢作成前に正解した天才</div>
                <div>${names} (+1pt)</div>
            </li>`;
        }

        document.getElementById('real-answer-display').innerText = `正解: ${currentQ.a}`;
        document.getElementById('options-detail-list').innerHTML = detailLog;
        updatePlayerList(); 
        const totalLog = Object.values(players).sort((a,b)=>b.score - a.score).map(p => 
            `<li class="score-box"><span>${p.name}</span> <span style="font-size:20px; font-weight:bold;">${p.score}pt</span></li>`
        ).join('');
        document.getElementById('total-scores').innerHTML = `<ul>${totalLog}</ul>`;
        broadcast({ type: 'SHOW_RESULT' });
        showScreen('host-result');
    }

    function backToLobby() {
        showScreen('host-lobby');
        broadcast({ type: 'BACK_TO_LOBBY' });
    }

    // ================= CLIENT LOGIC =================

    function initClient(hostId, roleParam) {
        showScreen('client-connecting');
        peer = new Peer();
        peer.on('open', (id) => {
            myId = id;
            if(roleParam === 'judge') {
                myRole = 'judge';
                // Wait until open before connecting
                connectToHost(hostId, 'JUDGE', 'judge');
            } else {
                myRole = 'player';
                showScreen('client-login');
            }
        });
    }

    function connectToHost(hostId, name, role) {
        hostConn = peer.connect(hostId);
        hostConn.on('open', () => { 
            console.log("Connected to Host"); 
            hostConn.send({ type: 'JOIN', name: name, role: role });
            if(role === 'judge') {
                showScreen('client-judge-panel');
            }
        });
        hostConn.on('data', (data) => { handleClientData(data); });
        
        hostConn.on('error', (err) => alert("接続エラー: " + err));
    }

    function joinGame(role) {
        const name = document.getElementById('my-name').value;
        if (!name) return alert("名前を入力してください");
        
        const urlParams = new URLSearchParams(window.location.search);
        const hostId = urlParams.get('host');
        connectToHost(hostId, name, 'player');
        showScreen('client-wait');
    }

    function handleClientData(data) {
        if (data.type === 'BACK_TO_LOBBY') {
            if(myRole === 'player') {
                showScreen('client-wait');
                document.getElementById('client-wait-msg').innerText = "ホストが問題を選ぶのを待っています";
            } else {
                document.getElementById('judge-answer-list').innerHTML = "<p>待機中...</p>";
                document.getElementById('judge-q-text').innerText = "";
                document.getElementById('judge-a-text').innerText = "";
                judgeLocalData = {};
            }
        }

        // --- Judge Logic ---
        if (myRole === 'judge') {
            if (data.type === 'JUDGE_CONNECTED') {
                document.getElementById('judge-status').innerText = "● ホスト接続済み";
                document.getElementById('judge-answer-list').innerHTML = "<p>問題選択待ち...</p>";
            }
            if (data.type === 'JUDGE_INIT_Q') {
                document.getElementById('judge-q-text').innerText = data.q;
                document.getElementById('judge-a-text').innerText = data.a;
                document.getElementById('judge-answer-list').innerHTML = ""; 
                judgeLocalData = {}; 
            }
            if (data.type === 'JUDGE_NEW_ANSWER') {
                judgeLocalData[data.playerId] = 'APPROVED';
                addJudgeEntry(data);
            }
            return;
        }

        // --- Player Logic ---
        if (data.type === 'START_INPUT') {
            document.getElementById('cli-q-text').innerText = data.q;
            document.getElementById('fake-answer').value = "";
            document.getElementById('client-input').querySelector('button').disabled = false;
            document.getElementById('client-input').querySelector('button').innerText = "送信";
            showScreen('client-input');
        } else if (data.type === 'START_VOTE') {
            renderClientOptions(data.options);
            showScreen('client-vote');
            document.getElementById('cli-options').classList.remove('hidden');
            document.getElementById('cli-vote-wait').classList.add('hidden');
        } else if (data.type === 'WAIT_VOTE_CORRECT') {
            showScreen('client-vote');
            document.getElementById('cli-options').classList.add('hidden');
            document.getElementById('cli-vote-wait').classList.remove('hidden');
        } else if (data.type === 'SHOW_RESULT') {
            document.getElementById('cli-result-msg').innerText = "親画面で結果を確認してください！";
            showScreen('client-result');
        }
    }

    // --- Judge UI Methods ---
    function addJudgeEntry(data) {
        const list = document.getElementById('judge-answer-list');
        if(list.innerHTML.includes('待機中') || list.innerHTML.includes('待ち')) list.innerHTML = "";

        if(document.getElementById(`judge-row-${data.playerId}`)) return;

        const div = document.createElement('div');
        div.id = `judge-row-${data.playerId}`;
        div.style.borderBottom = "1px solid #555";
        div.style.padding = "10px";
        div.innerHTML = `
            <div style="font-weight:bold; font-size:14px; margin-bottom:5px;">${data.playerName}</div>
            <div style="background:#444; padding:8px; border-radius:4px; font-size:16px;">${data.answer}</div>
            <div class="judge-toggle">
                <button class="selected-adopt" onclick="setDecision('${data.playerId}', 'APPROVED', this)">採用</button>
                <button onclick="setDecision('${data.playerId}', 'CORRECT', this)">正解</button>
            </div>
        `;
        list.appendChild(div);
    }

    function setDecision(pId, decision, btn) {
        judgeLocalData[pId] = decision;
        const buttons = btn.parentNode.querySelectorAll('button');
        buttons.forEach(b => {
            b.classList.remove('selected-adopt', 'selected-correct');
        });
        
        if (decision === 'APPROVED') btn.classList.add('selected-adopt');
        else btn.classList.add('selected-correct');
    }

    function publishAndStartVote() {
        if(Object.keys(judgeLocalData).length === 0) {
            alert("まだ回答がありません"); return;
        }
        if(!confirm("決定して出題しますか？")) return;
        hostConn.send({ type: 'JUDGE_BATCH_DECISION', decisions: judgeLocalData });
        alert("出題しました！");
    }

    // --- Player UI Methods ---
    function submitFakeAnswer() {
        const ans = document.getElementById('fake-answer').value;
        if (!ans) return;
        hostConn.send({ type: 'FAKE_ANSWER', answer: ans });
        const btn = document.getElementById('client-input').querySelector('button');
        btn.innerText = "送信完了！画面で待機...";
        btn.disabled = true;
    }

    function renderClientOptions(options) {
        const container = document.getElementById('cli-options');
        container.innerHTML = options.map((opt, i) => 
            `<button class="btn-opt" onclick="submitVote(${i})">${opt}</button>`
        ).join('');
    }

    function submitVote(index) {
        hostConn.send({ type: 'VOTE', vote: index });
        document.getElementById('client-vote').innerHTML = "<h2>投票完了！</h2><p>集計中...</p>";
    }

    // ================= UTILS =================
    function broadcast(data) {
        Object.values(connections).forEach(conn => conn.send(data));
    }
    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }
</script>
</body>
</html>
