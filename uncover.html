<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QUIZ ROYALE V10.0</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Black+Ops+One&family=M+PLUS+Rounded+1c:wght@400;700&family=Roboto:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* --- RESET & VARIABLES --- */
        :root {
            --bg: #121212; --panel: #1e1e1e; --text: #ffffff;
            --accent: #00e5ff; --danger: #ff4081;
            --pt-1: #42a5f5; --pt-2: #66bb6a; --pt-3: #ffee58; --pt-4: #ffa726; --pt-5: #ef5350;
        }
        * { box-sizing: border-box; touch-action: manipulation; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'M PLUS Rounded 1c', sans-serif; overflow: hidden; height: 100vh; width: 100vw; }
        .hidden { display: none !important; }
        
        /* --- LAYOUT UTILS --- */
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1; transition: opacity 0.3s; }

        /* --- TYPOGRAPHY --- */
        h1 { font-family: 'Black Ops One', cursive; font-size: 60px; margin: 0; text-transform: uppercase; letter-spacing: 2px; text-shadow: 0 0 10px rgba(255,255,255,0.5); }
        h2 { font-family: 'M PLUS Rounded 1c', sans-serif; font-size: 24px; margin: 10px 0 20px; color: #aaa; }

        /* --- BUTTONS & INPUTS --- */
        button { cursor: pointer; border: none; outline: none; font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: bold; transition: 0.2s; user-select: none; }
        button:active { transform: scale(0.96); }
        input[type="text"], input[type="number"], textarea { background: #2a2a2a; border: 2px solid #444; color: #fff; padding: 12px; border-radius: 8px; font-size: 18px; width: 100%; text-align: center; }
        input:focus { border-color: var(--accent); outline: none; }

        /* --- HOST UI --- */
        #host-app .btn-main { padding: 20px 60px; font-size: 28px; border-radius: 50px; background: linear-gradient(135deg, #333, #555); color: #fff; border: 2px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        #host-app .btn-sub { padding: 10px 20px; font-size: 14px; background: transparent; color: #888; border: 1px solid #444; border-radius: 4px; margin-top: 10px; }
        
        .settings-panel { width: 90%; max-width: 1000px; height: 85vh; background: var(--panel); border: 1px solid #333; border-radius: 12px; display: flex; overflow: hidden; }
        .settings-sidebar { width: 250px; background: #181818; border-right: 1px solid #333; display: flex; flex-direction: column; }
        .settings-content { flex: 1; padding: 30px; overflow-y: auto; }

        /* --- PLAYER UI (MOBILE) --- */
        #player-app { background: #000; width: 100%; height: 100%; overflow-y: auto; display: flex; flex-direction: column; align-items: center; }
        .mobile-container { width: 100%; max-width: 480px; padding: 20px; display: flex; flex-direction: column; gap: 20px; height: 100%; }
        
        .p-status-bar { display: flex; justify-content: space-between; align-items: center; background: #222; padding: 15px 20px; border-radius: 12px; border: 1px solid #444; font-size: 18px; font-weight: bold; }
        
        .p-pt-grid { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 20px; }
        .btn-pt { flex: 1; aspect-ratio: 1; border-radius: 8px; font-size: 24px; font-family: 'Black Ops One'; color: #000; opacity: 0.4; transition: 0.2s; border: 2px solid transparent; }
        .btn-pt.selected { opacity: 1; transform: scale(1.1); border-color: #fff; box-shadow: 0 0 15px rgba(255,255,255,0.3); }

        .btn-submit { width: 100%; padding: 18px; font-size: 22px; border-radius: 12px; background: var(--accent); color: #000; font-weight: 900; margin-top: 10px; }
        .btn-submit:disabled { background: #444; color: #888; }

        /* --- MODAL --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); backdrop-filter: blur(5px); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: #222; padding: 30px; width: 85%; max-width: 400px; border-radius: 20px; border: 2px solid #fff; text-align: center; }

        /* --- GAME VISUALS --- */
        .q-list-container { width: 90%; max-width: 1400px; height: 70vh; display: flex; flex-direction: column; justify-content: center; gap: 10px; }
        .q-bar { display: flex; align-items: center; background: #222; border: 1px solid #444; border-radius: 8px; overflow: hidden; flex: 1; transition: 0.3s; }
        .q-num { width: 80px; height: 100%; display: flex; align-items: center; justify-content: center; font-family: 'Black Ops One'; font-size: 32px; color: #000; }
        .q-text { flex: 1; padding: 0 20px; font-size: 28px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: bold; }
        .q-bar.solved { opacity: 0.2; filter: grayscale(1); text-decoration: line-through; }

        .timer { position: absolute; top: 20px; right: 30px; font-size: 60px; font-family: 'Black Ops One'; color: #fff; text-shadow: 0 0 10px #fff; }
        .ranking-wrapper { width: 100%; display: flex; flex-direction: column; align-items: center; padding-top: 50px; }
        .ranking-row { width: 80%; max-width: 800px; display: flex; align-items: center; background: #111; border-bottom: 1px solid #333; padding: 15px; margin-bottom: 5px; font-size: 24px; transition: 0.3s; opacity: 0.5; }
        .ranking-row.active { background: #333; opacity: 1; transform: scale(1.05); border-left: 5px solid #fff; }
        
        /* COLORS */
        .c-1 { background-color: var(--pt-1); } .c-2 { background-color: var(--pt-2); } .c-3 { background-color: var(--pt-3); } .c-4 { background-color: var(--pt-4); } .c-5 { background-color: var(--pt-5); }
    </style>
</head>
<body>

    <div id="host-app">
        <div id="screen-title" class="screen">
            <h1>QUIZ ROYALE</h1>
            <h2 style="font-size:20px; letter-spacing:5px;">V10.0 STABLE</h2>
            <button class="btn-main" onclick="Host.goToLobby()">GAME START</button>
            <div style="margin-top:20px;">
                <button class="btn-sub" onclick="Host.goToSettings()">Ë®≠ÂÆö / „Éá„Éº„ÇøÁÆ°ÁêÜ</button>
            </div>
        </div>

        <div id="screen-lobby" class="screen hidden">
            <h2 style="font-family:'Black Ops One'; font-size:40px; color:#fff;">ENTRY LOBBY</h2>
            <div style="background:#222; padding:40px; border-radius:20px; border:2px solid #444; text-align:center;">
                <div id="qrcode" style="background:#fff; padding:20px; display:inline-block; border-radius:10px;"></div>
                <p style="margin-top:20px; color:#ccc;">ÂõûÁ≠îÁî®URL</p>
                <div style="margin-top:30px; font-size:24px; font-weight:bold;">
                    ÂèÇÂä†‰∫∫Êï∞: <span id="host-player-count" style="font-size:40px; color:var(--accent);">0</span> ‰∫∫
                </div>
            </div>
            <div style="margin-top:30px; display:flex; gap:20px;">
                <button class="btn-sub" onclick="Host.showScreen('screen-title')">Êàª„Çã</button>
                <button class="btn-main" style="font-size:20px;" onclick="Host.goToSelect()">ÂïèÈ°åÈÅ∏Êäû„Å∏ÈÄ≤„ÇÄ ‚û°</button>
            </div>
        </div>

        <div id="screen-select" class="screen hidden">
            <h2 style="font-family:'Black Ops One'; font-size:32px;">SELECT MISSION</h2>
            <div id="host-set-list" style="display:flex; flex-wrap:wrap; gap:20px; justify-content:center; max-width:800px;"></div>
            <button class="btn-sub" style="position:absolute; bottom:30px;" onclick="Host.goToLobby()">„É≠„Éì„Éº„Å∏Êàª„Çã</button>
        </div>

        <div id="screen-game" class="screen hidden">
            <div class="timer" id="game-timer">30</div>
            <div style="position:absolute; top:20px; left:30px; font-size:24px; color:#888;" id="game-genre">GENRE</div>
            <div id="host-q-list" class="q-list-container"></div>
            <div id="overlay-count" class="screen hidden" style="background:rgba(0,0,0,0.95); z-index:10; font-size:200px; font-family:'Black Ops One'; color:var(--accent);">3</div>
            <div id="overlay-timeup" class="screen hidden" style="background:rgba(0,0,0,0.8); z-index:10; font-size:100px; font-family:'Black Ops One'; color:#fff; text-shadow:0 0 20px var(--danger);">TIME UP!</div>
            <div style="position:absolute; bottom:20px; color:#555;">[ESC] ‰∏≠Êñ≠ / [SPACE] ÈõÜË®à„Å∏</div>
        </div>

        <div id="screen-judge" class="screen hidden">
            <div style="position:absolute; top:0; width:100%; background:#222; padding:20px; text-align:center; border-bottom:2px solid #444; font-size:28px;">
                <span id="j-pt" style="font-family:'Black Ops One'; margin-right:10px;"></span>
                <span id="j-text"></span>
            </div>
            <div class="ranking-wrapper" id="j-rank-list"></div>
            <div id="j-controls" style="position:absolute; bottom:0; width:100%; padding:30px; background:#222; display:flex; justify-content:center; gap:50px; transform:translateY(100%); transition:0.3s;">
                <button style="width:100px; height:100px; border-radius:50%; font-size:40px; font-weight:bold; background:#2e7d32; color:#fff;" onclick="Host.judge(true)">O</button>
                <button style="width:100px; height:100px; border-radius:50%; font-size:40px; font-weight:bold; background:#c62828; color:#fff;" onclick="Host.judge(false)">X</button>
            </div>
            <div id="j-msg" style="margin-top:20px; color:#888;">[SPACE] Ê¨°„ÇíË°®Á§∫ / [ESC] ÁµÇ‰∫Ü</div>
        </div>

        <div id="screen-settings" class="screen hidden">
            <div class="settings-panel">
                <div class="settings-sidebar">
                    <div style="padding:15px; border-bottom:1px solid #333; font-weight:bold;">ÂïèÈ°å„Çª„ÉÉ„Éà‰∏ÄË¶ß</div>
                    <div id="setting-list" style="flex:1; overflow-y:auto;"></div>
                    <button class="btn-sub" style="margin:10px; width:90%;" onclick="Host.createNewSet()">Ôºã Êñ∞Ë¶è‰ΩúÊàê</button>
                </div>
                <div class="settings-content">
                    <h3 style="border-bottom:1px solid #333; padding-bottom:10px;">Á∑®ÈõÜ</h3>
                    <div style="margin-bottom:20px; display:grid; grid-template-columns:1fr 1fr; gap:20px;">
                        <div><label>„Çø„Ç§„Éà„É´</label><input type="text" id="conf-title"></div>
                        <div><label>Âà∂ÈôêÊôÇÈñì(Áßí)</label><input type="number" id="conf-time" value="30"></div>
                    </div>
                    <div style="margin-bottom:20px; border:1px solid #333; padding:10px; border-radius:8px;">
                        <div style="font-size:12px; color:#aaa; margin-bottom:5px;">Èü≥Èáè & „Éá„Éº„ÇøÁÆ°ÁêÜ</div>
                        <div style="display:flex; gap:20px; align-items:center;">
                            <span>BGM</span><input type="range" id="vol-bgm" min="0" max="100" value="50">
                            <span>SE</span><input type="range" id="vol-se" min="0" max="100" value="50">
                        </div>
                        <div style="margin-top:10px; display:flex; gap:10px;">
                            <input type="file" id="file-bgm" accept="audio/*" style="font-size:12px;">
                            <input type="file" id="file-se" accept="audio/*" style="font-size:12px;">
                        </div>
                        <div style="margin-top:15px; display:flex; gap:10px; border-top:1px solid #444; padding-top:10px;">
                            <button class="btn-sub" onclick="Host.exportData()">üì§ „Éá„Éº„ÇøÊõ∏„ÅçÂá∫„Åó (Copy)</button>
                            <button class="btn-sub" onclick="Host.importData()">üì• „Éá„Éº„ÇøË™≠„ÅøËæº„Åø (Paste)</button>
                        </div>
                    </div>

                    <div id="conf-questions" style="max-height:300px; overflow-y:auto; border:1px solid #333; padding:10px; border-radius:8px;">
                        </div>

                    <div style="margin-top:20px; text-align:right;">
                        <button class="btn-sub" onclick="Host.showScreen('screen-title')">Êàª„Çã</button>
                        <button class="btn-main" style="font-size:18px; padding:10px 40px;" onclick="Host.saveSet()">‰øùÂ≠ò</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="player-app" class="hidden">
        <div id="p-screen-login" class="screen">
            <div class="mobile-container" style="justify-content:center;">
                <h1 style="font-size:40px; color:var(--accent);">ENTRY</h1>
                <p style="color:#888; margin-bottom:20px;">ÂêçÂâç„ÇíÂÖ•Âäõ„Åó„Å¶ÂèÇÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑ</p>
                <input type="text" id="p-name" placeholder="Name" style="padding:15px; border-color:var(--accent);">
                <button class="btn-submit" onclick="Player.login()">JOIN GAME</button>
            </div>
        </div>

        <div id="p-screen-main" class="screen hidden">
            <div class="mobile-container">
                <div class="p-status-bar">
                    <span id="p-disp-name">Player</span>
                    <span style="color:var(--accent);"><span id="p-score">0</span> pts</span>
                </div>
                <div id="p-wait" style="flex:1; display:flex; flex-direction:column; justify-content:center; align-items:center; color:#666;">
                    <div style="font-size:40px; margin-bottom:20px;">‚è≥</div>
                    <div id="p-wait-text">WAITING FOR HOST...</div>
                </div>
                <div id="p-game" class="hidden" style="flex:1; display:flex; flex-direction:column;">
                    <h3 style="margin:0 0 10px 0; color:#aaa;">SELECT POINT</h3>
                    <div class="p-pt-grid">
                        <button class="btn-pt c-1" onclick="Player.select(1)" id="p-btn-1">1</button>
                        <button class="btn-pt c-2" onclick="Player.select(2)" id="p-btn-2">2</button>
                        <button class="btn-pt c-3" onclick="Player.select(3)" id="p-btn-3">3</button>
                        <button class="btn-pt c-4" onclick="Player.select(4)" id="p-btn-4">4</button>
                        <button class="btn-pt c-5" onclick="Player.select(5)" id="p-btn-5">5</button>
                    </div>
                    <h3 style="margin:20px 0 10px 0; color:#aaa;">YOUR ANSWER</h3>
                    <input type="text" id="p-ans" placeholder="Á≠î„Åà„ÇíÂÖ•Âäõ..." style="padding:20px; font-size:24px; font-weight:bold;">
                    <div style="margin-top:auto;">
                        <button class="btn-submit" onclick="Player.confirm()">SEND ANSWER</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="p-modal" class="modal-overlay">
            <div class="modal-box">
                <div style="font-size:14px; color:#aaa;">CONFIRMATION</div>
                <div style="font-size:40px; font-family:'Black Ops One'; margin:10px 0; color:var(--accent);"><span id="m-pt">1</span>pt</div>
                <div id="m-text" style="font-size:28px; font-weight:bold; margin-bottom:20px; word-break:break-all;">Answer</div>
                <div style="display:flex; gap:10px;">
                    <button class="btn-sub" style="flex:1; border:1px solid #666; color:#ccc;" onclick="document.getElementById('p-modal').style.display='none'">CANCEL</button>
                    <button class="btn-submit" style="flex:1; margin:0;" onclick="Player.send()">SEND</button>
                </div>
            </div>
        </div>
    </div>

    <audio id="bgm" loop></audio>
    <audio id="se"></audio>

<script>
/* --- CONSTANTS --- */
const CHANNEL = 'quiz_royale_v10';
const STORAGE_KEY = 'QUIZ_ROYALE_MASTER_V10'; // NEW KEY

/* --- DATA MIGRATION LOGIC --- */
function migrateData() {
    let data = localStorage.getItem(STORAGE_KEY);
    if (data) return JSON.parse(data);

    // Try V9
    let old = localStorage.getItem('quiz_royale_master_v9');
    if (!old) old = localStorage.getItem('quiz_royale_sets_v5'); // Older key

    if (old) {
        console.log("Migrating data from previous version...");
        const parsed = JSON.parse(old);
        // Normalize structure
        const sets = parsed.sets || parsed; // Handle different structures
        const newData = { sets: Array.isArray(sets) ? sets : [], config: {} };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(newData));
        return newData;
    }
    
    return { sets: [{ title:"„Çµ„É≥„Éó„É´", time:30, qs:["Q1", "Q2", "Q3", "Q4", "Q5"] }], config: {} };
}

/* --- STATE --- */
const DB = {
    state: { phase:'LOBBY', set:null },
    players: {}, answers: [], solved: [],
    
    broadcast: () => {
        if(Net.isHost) Net.conns.forEach(c => c.send({ type:'STATE', db:DB }));
    }
};

/* --- NETWORK --- */
const Net = {
    peer: null, conn: null, conns: [], isHost: false,
    initHost: () => {
        Net.isHost = true;
        Net.peer = new Peer();
        Net.peer.on('open', id => {
            const url = location.href.split('?')[0] + "?role=player&host=" + id;
            new QRCode(document.getElementById('qrcode'), { text:url, width:150, height:150 });
        });
        Net.peer.on('connection', c => {
            Net.conns.push(c);
            c.on('data', d => Host.handleData(d, c.peer));
            c.on('close', () => { Net.conns = Net.conns.filter(x=>x!==c); Host.refreshCount(); });
            c.send({ type:'STATE', db:DB });
        });
    },
    initPlayer: (hid) => {
        Net.peer = new Peer();
        Net.peer.on('open', id => {
            Net.conn = Net.peer.connect(hid);
            Net.conn.on('data', d => Player.handleData(d));
            Net.conn.on('close', () => { alert("Êé•Á∂ö„ÅåÂàá„Çå„Åæ„Åó„Åü"); location.reload(); });
        });
    },
    sendHost: (d) => { if(Net.conn) Net.conn.send(d); }
};

/* --- SOUND --- */
const Sound = {
    bgmVol: 0.5, seVol: 0.5,
    init: () => {
        if(document.getElementById('vol-bgm')) {
            document.getElementById('vol-bgm').oninput = e => { Sound.bgmVol = e.target.value/100; document.getElementById('bgm').volume = Sound.bgmVol; };
            document.getElementById('vol-se').oninput = e => { Sound.seVol = e.target.value/100; };
            document.getElementById('file-bgm').onchange = e => { const f=e.target.files[0]; if(f) document.getElementById('bgm').src = URL.createObjectURL(f); };
            document.getElementById('file-se').onchange = e => { const f=e.target.files[0]; if(f) document.getElementById('se').src = URL.createObjectURL(f); };
        }
    },
    playBGM: () => { const a=document.getElementById('bgm'); a.volume=Sound.bgmVol; if(a.src) a.play().catch(()=>{}); },
    stopBGM: () => { const a=document.getElementById('bgm'); a.pause(); a.currentTime=0; },
    playSE: (type) => {
        if(type==='timeup'){ const a=document.getElementById('se'); if(a.src){ a.volume=Sound.seVol; a.play(); return; } }
        const ctx=new(window.AudioContext||window.webkitAudioContext)(); const o=ctx.createOscillator(); const g=ctx.createGain();
        g.gain.value = 0.3 * Sound.seVol;
        if(type==='count'){ o.frequency.setValueAtTime(800, ctx.currentTime); o.frequency.exponentialRampToValueAtTime(0.01, ctx.currentTime+0.1); o.start(); o.stop(ctx.currentTime+0.1); }
        else if(type==='timeup'){ o.type='sawtooth'; o.frequency.setValueAtTime(800, ctx.currentTime); o.frequency.linearRampToValueAtTime(200, ctx.currentTime+0.5); g.gain.linearRampToValueAtTime(0, ctx.currentTime+0.5); o.start(); o.stop(ctx.currentTime+0.5); }
        o.connect(g); g.connect(ctx.destination);
    }
};

/* --- HOST LOGIC --- */
const Host = {
    data: { sets: [] }, editIdx: -1, timer: null, judgeIdx: 0, sortedAns: [],
    
    init: () => {
        if(params.get('role') === 'player') {
            document.getElementById('host-app').classList.add('hidden');
            document.getElementById('player-app').classList.remove('hidden');
            const hid = params.get('host');
            if(!hid) return alert("„Éõ„Çπ„ÉàID„Å™„Åó");
            Player.init(hid); return;
        }
        
        Host.data = migrateData();
        Net.initHost();
        Sound.init();
        
        document.addEventListener('keydown', e => {
            if(e.code==='Escape' && DB.state.phase!=='LOBBY') Host.escapeGame();
            if(e.code==='Space') Host.handleSpace();
        });
        
        // Initial Input Render
        Host.renderInputFields();
    },

    handleData: (d, pid) => {
        if(d.type === 'LOGIN') {
            DB.players[pid] = { name:d.name, score:0 };
            Host.refreshCount(); DB.broadcast();
        } else if(d.type === 'ANSWER') {
            if(DB.state.phase === 'ACTIVE' && !DB.answers.find(a=>a.pid===pid)) {
                DB.answers.push({ pid, name:d.name, pt:d.pt, text:d.text, time:Date.now() });
                DB.broadcast();
            }
        }
    },
    refreshCount: () => { document.getElementById('host-player-count').innerText = Object.keys(DB.players).length; },
    handleSpace: () => {
        if(DB.state.phase === 'TIMEUP') Host.startJudging();
        else if(DB.state.phase === 'JUDGE') Host.revealNext();
    },

    /* UI NAV */
    showScreen: (id) => { document.querySelectorAll('.screen').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); },
    goToLobby: () => { Host.showScreen('screen-lobby'); DB.state.phase='LOBBY'; DB.broadcast(); },
    goToSelect: () => { 
        Host.showScreen('screen-select'); 
        const l = document.getElementById('host-set-list'); l.innerHTML="";
        Host.data.sets.forEach((s,i) => {
            const b=document.createElement('button'); b.className="btn-main"; b.innerText=s.title; b.style.fontSize="20px";
            b.onclick=()=>Host.startGame(i); l.appendChild(b);
        });
    },

    /* SETTINGS */
    goToSettings: () => { Host.showScreen('screen-settings'); Host.renderList(); Host.createNewSet(); },
    renderList: () => {
        const l = document.getElementById('setting-list'); l.innerHTML="";
        Host.data.sets.forEach((s,i) => {
            const d=document.createElement('div'); d.style.cssText="padding:10px; border-bottom:1px solid #333; cursor:pointer; display:flex; justify-content:space-between;";
            if(i===Host.editIdx) d.style.background="#333";
            d.innerHTML = `<span>${s.title}</span> <button class="btn-sub" style="margin:0; padding:2px;" onclick="event.stopPropagation();Host.delSet(${i})">√ó</button>`;
            d.onclick=()=>Host.loadSet(i); l.appendChild(d);
        });
    },
    renderInputFields: (vals=[]) => {
        const area = document.getElementById('conf-questions'); area.innerHTML="";
        for(let i=0; i<5; i++) { // Fixed 5
            const val = vals[i] || "";
            const cls = `c-${i+1}`;
            area.innerHTML += `<div style="display:flex; gap:10px; margin-bottom:5px;"><span class="q-num ${cls}" style="width:40px; font-size:20px; border-radius:4px;">${i+1}</span><input type="text" value="${val}" style="flex:1;"></div>`;
        }
    },
    createNewSet: () => { Host.editIdx=-1; Host.renderList(); document.getElementById('conf-title').value=""; Host.renderInputFields(); },
    loadSet: (i) => {
        Host.editIdx=i; Host.renderList(); const s=Host.data.sets[i];
        document.getElementById('conf-title').value=s.title; document.getElementById('conf-time').value=s.time;
        Host.renderInputFields(s.qs);
    },
    saveSet: () => {
        const t=document.getElementById('conf-title').value; if(!t)return;
        const qs=[]; document.getElementById('conf-questions').querySelectorAll('input').forEach(i=>qs.push(i.value));
        const ns={ title:t, time:parseInt(document.getElementById('conf-time').value), qs:qs };
        if(Host.editIdx<0) Host.data.sets.push(ns); else Host.data.sets[Host.editIdx]=ns;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(Host.data)); alert("‰øùÂ≠ò„Åó„Åæ„Åó„Åü"); Host.renderList();
    },
    delSet: (i) => { if(confirm("ÂâäÈô§„Åó„Åæ„Åô„ÅãÔºü")){ Host.data.sets.splice(i,1); localStorage.setItem(STORAGE_KEY,JSON.stringify(Host.data)); Host.createNewSet(); } },
    
    exportData: () => { navigator.clipboard.writeText(JSON.stringify(Host.data)); alert("„ÇØ„É™„ÉÉ„Éó„Éú„Éº„Éâ„Å´„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü"); },
    importData: () => { 
        const s = prompt("„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ"); 
        if(s) { try{ Host.data = JSON.parse(s); localStorage.setItem(STORAGE_KEY, s); Host.renderList(); alert("Ë™≠„ÅøËæº„ÅøÂÆå‰∫Ü"); }catch(e){alert("„Ç®„É©„Éº");} }
    },

    /* GAME */
    startGame: (i) => {
        const s = Host.data.sets[i]; DB.state.set=s; DB.state.phase='COUNTDOWN'; DB.answers=[]; DB.solved=[false,false,false,false,false,false];
        DB.broadcast(); Host.showScreen('screen-game');
        
        document.getElementById('game-genre').innerText=s.title;
        document.getElementById('game-timer').innerText=s.time;
        const l=document.getElementById('host-q-list'); l.innerHTML="";
        s.qs.forEach((q,idx)=>{
            l.innerHTML+=`<div class="q-bar" id="bar-${idx}"><div class="q-num c-${idx+1}">${idx+1}</div><div class="q-text">${q}</div></div>`;
        });

        const ov=document.getElementById('overlay-count'); ov.classList.remove('hidden'); let c=3; ov.innerText=c; Sound.playSE('count');
        const iv=setInterval(()=>{
            c--; if(c>0){ ov.innerText=c; Sound.playSE('count'); }
            else { clearInterval(iv); ov.classList.add('hidden'); Host.runGame(s.time); }
        },1000);
        Host.timer = iv;
    },
    runGame: (sec) => {
        DB.state.phase='ACTIVE'; DB.broadcast(); Sound.playBGM();
        let t=sec; const el=document.getElementById('game-timer');
        Host.timer=setInterval(()=>{ t--; el.innerText=t; if(t<=0)Host.timeUp(); },1000);
    },
    timeUp: () => {
        clearInterval(Host.timer); Sound.stopBGM(); Sound.playSE('timeup');
        DB.state.phase='TIMEUP'; DB.broadcast();
        document.getElementById('overlay-timeup').classList.remove('hidden');
    },
    escapeGame: () => {
        clearInterval(Host.timer); Sound.stopBGM();
        document.getElementById('overlay-count').classList.add('hidden');
        document.getElementById('overlay-timeup').classList.add('hidden');
        Host.goToSelect();
    },

    /* JUDGE */
    startJudging: () => {
        DB.state.phase='JUDGE'; DB.broadcast(); Host.showScreen('screen-judge');
        Host.sortedAns = [...DB.answers].sort((a,b)=>a.time-b.time); Host.judgeIdx=-1;
        const l=document.getElementById('j-rank-list'); l.innerHTML="";
        Host.sortedAns.forEach((a,i)=>{
            l.innerHTML+=`<div class="ranking-row" id="row-${i}"><div style="width:50px;">#${i+1}</div><div style="width:200px;">${a.name}</div><div class="hidden" id="det-${i}" style="display:flex;gap:10px;align-items:center;"><span class="c-${a.pt}" style="padding:0 10px;border-radius:5px;color:#000;font-weight:bold;">${a.pt}pt</span><span>${a.text}</span><span id="res-${i}"></span></div></div>`;
        });
    },
    revealNext: () => {
        Host.judgeIdx++; if(Host.judgeIdx>=Host.sortedAns.length){ Host.escapeGame(); return; }
        const i=Host.judgeIdx; const a=Host.sortedAns[i];
        document.querySelectorAll('.ranking-row').forEach(r=>r.classList.remove('active'));
        document.getElementById(`row-${i}`).classList.add('active');
        document.getElementById(`det-${i}`).classList.remove('hidden');
        
        document.getElementById('j-pt').innerText=a.pt+"pt";
        document.getElementById('j-text').innerText=DB.state.set.qs[a.pt-1];
        
        if(DB.solved[a.pt]) alert("‚ö†Ô∏è Êó¢„Å´Ê≠£Ëß£„ÅåÂá∫„Å¶„ÅÑ„Åæ„ÅôÔºÅ");
        document.getElementById('j-controls').style.transform="translateY(0)";
    },
    judge: (ok) => {
        const a=Host.sortedAns[Host.judgeIdx]; const el=document.getElementById(`res-${Host.judgeIdx}`);
        if(ok){ 
            if(!DB.players[a.pid]) DB.players[a.pid]={name:a.name, score:0};
            DB.players[a.pid].score += parseInt(a.pt); DB.solved[a.pt]=true;
            el.innerHTML="‚≠ï"; el.style.color="#4f4";
        } else { el.innerHTML="‚ùå"; el.style.color="#f44"; }
        DB.broadcast();
        document.getElementById('j-controls').style.transform="translateY(100%)";
    }
};

/* --- PLAYER LOGIC --- */
const Player = {
    id: null, name: null, sel: null,
    
    init: (hid) => {
        Player.id = sessionStorage.getItem('pid') || 'p_'+Date.now(); sessionStorage.setItem('pid', Player.id);
        Player.name = sessionStorage.getItem('pname');
        Net.initPlayer(hid);
        if(Player.name) Player.show('p-screen-main');
    },
    handleData: (d) => {
        if(d.type==='STATE') {
            const db = d.db; const ph=db.state.phase;
            if(db.players[Player.id]) {
                document.getElementById('p-disp-name').innerText=db.players[Player.id].name;
                document.getElementById('p-score').innerText=db.players[Player.id].score;
            }
            const wm=document.getElementById('p-wait'); const gm=document.getElementById('p-game');
            if(ph==='ACTIVE') {
                const my=db.answers.find(a=>a.pid===Player.id);
                if(my) { wm.classList.remove('hidden'); gm.classList.add('hidden'); document.getElementById('p-wait-text').innerText="ÂõûÁ≠îÈÄÅ‰ø°Ê∏à„Åø"; }
                else { wm.classList.add('hidden'); gm.classList.remove('hidden'); }
            } else {
                wm.classList.remove('hidden'); gm.classList.add('hidden');
                document.getElementById('p-wait-text').innerText = (ph==='TIMEUP') ? "TIME UP!" : "WAITING...";
                if(ph==='LOBBY'||ph==='COUNTDOWN') { Player.sel=null; document.getElementById('p-ans').value=""; document.querySelectorAll('.btn-pt').forEach(b=>b.classList.remove('selected')); }
            }
        }
    },
    show: (id) => { document.querySelectorAll('#player-app .screen').forEach(e=>e.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); },
    login: () => {
        const n=document.getElementById('p-name').value; if(!n)return;
        Player.name=n; sessionStorage.setItem('pname',n);
        Net.sendHost({type:'LOGIN', name:n}); Player.show('p-screen-main');
    },
    select: (p) => {
        Player.sel=p; document.querySelectorAll('.btn-pt').forEach(b=>b.classList.remove('selected'));
        document.getElementById(`p-btn-${p}`).classList.add('selected');
    },
    confirm: () => {
        const v=document.getElementById('p-ans').value; if(!Player.sel||!v)return;
        document.getElementById('m-pt').innerText=Player.sel; document.getElementById('m-text').innerText=v;
        document.getElementById('p-modal').style.display='flex';
    },
    send: () => {
        Net.sendHost({type:'ANSWER', name:Player.name, pt:Player.sel, text:document.getElementById('p-ans').value});
        document.getElementById('p-modal').style.display='none';
    }
};

Host.init();
</script>
</body>
</html>
