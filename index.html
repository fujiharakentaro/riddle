<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ArUco Camera (Mobile)</title>
    <style>
        body { margin: 0; padding: 0; background-color: #222; color: white; display: flex; flex-direction: column; align-items: center; font-family: sans-serif; }
        h2 { margin: 10px; font-size: 1.2rem; }
        
        /* æ˜ åƒè¡¨ç¤ºã‚¨ãƒªã‚¢ */
        .container { position: relative; width: 100%; max-width: 640px; }
        #outputCanvas { width: 100%; height: auto; border: 2px solid #666; background: #000; }
        #inputVideo { display: none; }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆãƒœã‚¿ãƒ³ã®è£…é£¾ */
        #startBtn {
            padding: 15px 30px;
            font-size: 18px;
            background-color: #00d2ff;
            color: #000;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0,210,255, 0.4);
        }
        #startBtn:disabled { background-color: #555; color: #888; cursor: not-allowed; box-shadow: none; }
        
        #status { margin: 10px; color: yellow; font-size: 0.9rem; text-align: center; }
    </style>
</head>
<body>

    <h2>ArUco Marker Detector</h2>
    <div id="status">æº–å‚™ä¸­... OpenCVã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™</div>
    
    <button id="startBtn" disabled onclick="startCamera()">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹</button>

    <div class="container">
        <video id="inputVideo" playsinline muted></video>
        <canvas id="outputCanvas"></canvas>
    </div>

    <script async src="https://docs.opencv.org/4.8.0/opencv.js" onload="onOpenCvReady();"></script>

    <script>
        let video = document.getElementById('inputVideo');
        let canvas = document.getElementById('outputCanvas');
        let ctx = canvas.getContext('2d');
        let status = document.getElementById('status');
        let startBtn = document.getElementById('startBtn');
        
        let stream = null;
        let cap = null;
        let src = null;
        let dictionary = null;
        let parameter = null;
        let isStreaming = false;

        // 1. OpenCVèª­ã¿è¾¼ã¿å®Œäº†
        function onOpenCvReady() {
            status.innerHTML = "æº–å‚™å®Œäº†ï¼ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„";
            startBtn.disabled = false; // ãƒœã‚¿ãƒ³ã‚’æŠ¼ã›ã‚‹ã‚ˆã†ã«ã™ã‚‹
            startBtn.innerText = "ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ã™ã‚‹";
        }

        // 2. ãƒœã‚¿ãƒ³ãŒæŠ¼ã•ã‚ŒãŸã‚‰ã‚«ãƒ¡ãƒ©èµ·å‹•
        async function startCamera() {
            startBtn.style.display = 'none'; // ãƒœã‚¿ãƒ³ã‚’æ¶ˆã™
            status.innerHTML = "ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã‚’æ±‚ã‚ã¦ã„ã¾ã™...";

            try {
                // ã‚¹ãƒãƒ›ã®ã€Œå¤–ã‚«ãƒ¡ãƒ©(environment)ã€ã‚’å„ªå…ˆæŒ‡å®š
                const constraints = {
                    video: {
                        facingMode: 'environment', 
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    },
                    audio: false
                };

                stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                // æ˜ åƒãŒæµã‚Œå§‹ã‚ãŸã‚‰OpenCVå‡¦ç†é–‹å§‹
                video.onloadedmetadata = () => {
                    video.play();
                    initOpenCV();
                };
            } catch (err) {
                status.innerHTML = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err.name;
                alert("ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒå¿…è¦ã§ã™ã€‚ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
                console.error(err);
                startBtn.style.display = 'block'; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ãƒœã‚¿ãƒ³ã‚’æˆ»ã™
            }
        }

        // 3. å‡¦ç†é–‹å§‹
        function initOpenCV() {
            status.innerHTML = "èªè­˜ä¸­...";
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            
            cap = new cv.VideoCapture(video);
            src = new cv.Mat(video.videoHeight, video.videoWidth, cv.CV_8UC4);
            dictionary = new cv.aruco_Dictionary(cv.aruco.DICT_4X4_50);
            parameter = new cv.aruco_DetectorParameters();

            isStreaming = true;
            processVideo();
        }

        // 4. ãƒ«ãƒ¼ãƒ—å‡¦ç†
        function processVideo() {
            if (!isStreaming) return;

            try {
                cap.read(src);

                let corners = new cv.MatVector();
                let ids = new cv.Mat();
                let rejected = new cv.MatVector();

                // æ¤œå‡ºå®Ÿè¡Œ
                cv.aruco.detectMarkers(src, dictionary, corners, ids, parameter, rejected);

                // æç”»
                if (ids.rows > 0) {
                    cv.aruco.drawDetectedMarkers(src, corners, ids);
                    status.innerHTML = `ãƒãƒ¼ã‚«ãƒ¼æ¤œçŸ¥! ID: ${ids.data32S[0]}`; // æœ€åˆã«è¦‹ã¤ã‘ãŸIDã‚’è¡¨ç¤º
                } else {
                    status.innerHTML = "èªè­˜ä¸­...";
                }

                cv.imshow('outputCanvas', src);

                // ãƒ¡ãƒ¢ãƒªè§£æ”¾
                corners.delete();
                ids.delete();
                rejected.delete();

                requestAnimationFrame(processVideo);
            } catch (err) {
                console.error(err);
            }
        }
    </script>
</body>
</html>
