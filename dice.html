<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>POLYHEDRON QUIZ V16.4</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { 
            --bg: #222222; 
            --text: #eee; 
            --panel: #333; 
            --border: #444; 
            --accent: #00d2ff; 
            --danger: #ff4444;
            --gold: #ffd700;
            --success: #2ecc71;
        }
        body { margin: 0; overflow: hidden; background-color: var(--bg); font-family: 'Helvetica Neue', Arial, sans-serif; color: var(--text); }

        .hidden { display: none !important; }
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: none; flex-direction: column; align-items: center; justify-content: center;
            background: var(--bg); transition: opacity 0.5s; overflow-y: auto;
        }
        .screen.active { display: flex; z-index: 10; }

        h1 { color: #fff; letter-spacing: 4px; margin-bottom: 30px; font-size: 32px; border-bottom: 2px solid #555; padding-bottom: 10px; }

        /* UI Parts */
        .btn {
            background: #444; color: #fff; border: 1px solid #666; padding: 10px 20px;
            cursor: pointer; font-size: 16px; border-radius: 4px; margin: 5px;
        }
        .btn:hover { background: #555; border-color: var(--accent); }
        .btn-add { background: var(--accent); color: #000; border: none; font-weight: bold; }
        .btn-sm { padding: 2px 8px; font-size: 12px; min-width: 30px; }
        
        input[type="text"], input[type="number"], input[type="password"] {
            padding: 10px; background: #222; border: 1px solid #555; color: #fff; border-radius: 4px; font-size: 16px;
        }

        /* --- 1. HOST: Title & Lobby --- */
        #question-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px; width: 80%; max-width: 900px; max-height: 50vh; overflow-y: auto; padding: 20px;
        }
        .q-btn {
            background: #2b2b2b; border: 1px solid #555; border-radius: 8px; height: 100px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s; color: #eee; text-align: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); position: relative;
        }
        .q-btn:hover { border-color: var(--accent); transform: translateY(-3px); background: #383838; }
        .q-num { font-size: 24px; font-weight: bold; color: var(--accent); }
        
        /* Lobby Info */
        #host-info { margin-top: 20px; text-align: center; padding: 20px; background: #333; border-radius: 8px; width: 80%; max-width: 600px;}
        #qr-area { background: #fff; padding: 10px; display: inline-block; border-radius: 8px; margin: 10px; }
        .url-box { font-family: monospace; background: #000; padding: 10px; border: 1px solid var(--accent); color: var(--accent); cursor: pointer; user-select: all; word-break: break-all; }
        #player-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin-top: 10px; }
        .p-chip { background: #444; padding: 5px 10px; border-radius: 15px; border: 1px solid #666; font-size: 14px; }

        /* --- 2. HOST: Game Screen --- */
        #game-ui { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; z-index: 5; }
        #canvas-container { width: 100%; height: 100%; position: absolute; top:0; left:0; z-index: 1; }
        #timer-display { position: absolute; top: 20px; right: 20px; font-size: 60px; font-weight: bold; color: var(--accent); text-shadow: 0 0 10px var(--accent); }
        #back-btn { position: absolute; top: 20px; left: 20px; pointer-events: auto; z-index: 20; }
        
        #countdown-display {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            font-size: 150px; font-weight: 900; color: #fff;
            text-shadow: 0 0 20px var(--accent); display: none; z-index: 30;
        }

        /* --- 3. HOST: Result Screen --- */
        #result-screen { 
            display: flex; flex-direction: row; width: 100%; height: 100%; position: absolute; top: 0; left: 0; z-index: 20; 
            background: linear-gradient(90deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 50%, rgba(0,0,0,0.95) 50%, rgba(0,0,0,0.95) 100%);
            pointer-events: none; 
        }
        #res-left { flex: 1; position: relative; } 
        #res-right { flex: 1; padding: 20px; overflow-y: hidden; display: flex; flex-direction: column; pointer-events: auto; border-left: 2px solid #444; background: rgba(0,0,0,0.8); }
        
        #seek-bar-container { position: absolute; bottom: 0; left: 0; width: 100%; height: 10px; background: #333; z-index: 25; pointer-events: auto;}
        #seek-bar { height: 100%; background: var(--accent); width: 0%; transition: width 0.1s linear; }
        
        .rank-row {
            display: flex; align-items: center; justify-content: space-between;
            background: linear-gradient(90deg, #333, #444); margin-bottom: 10px; padding: 15px;
            border-radius: 8px; color: #fff; font-size: 20px; font-weight: bold;
            transform: translateX(100%); transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            opacity: 0; border-left: 5px solid #666;
        }
        .rank-row.show { transform: translateX(0); opacity: 1; }
        .rank-row.correct { border-left-color: var(--accent); background: linear-gradient(90deg, #004455, #006688); }
        .rank-row.incorrect { border-left-color: var(--danger); background: linear-gradient(90deg, #552222, #883333); }
        .r-name { flex: 1; margin-left: 10px; }
        .r-score { color: var(--gold); }
        .r-ans { font-size: 0.8em; color: #aaa; margin-right: 15px; }

        /* --- CLIENT APP --- */
        #client-app { width: 100%; height: 100%; display: none; flex-direction: column; align-items: center; justify-content: center; }
        #c-login { text-align: center; }
        #c-game { display: none; text-align: center; width: 90%; }
        #c-status { font-size: 24px; margin-bottom: 20px; color: #aaa; }
        #c-input { width: 80%; padding: 15px; font-size: 20px; text-align: center; border-radius: 8px; border: 2px solid #555; background: #222; color: #fff; margin-bottom: 20px; }
        #c-btn-submit { width: 80%; padding: 15px; font-size: 20px; background: var(--accent); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }
        #c-btn-submit:disabled { background: #555; color: #888; cursor: not-allowed; }
        #conn-indicator { position: fixed; top: 10px; right: 10px; width: 15px; height: 15px; border-radius: 50%; background: #555; border: 2px solid #fff; }
        #conn-indicator.on { background: var(--success); box-shadow: 0 0 10px var(--success); }

        /* --- Settings --- */
        .settings-container { width: 90%; max-width: 600px; background: var(--panel); padding: 30px; border-radius: 12px; display: flex; flex-direction: column; gap: 20px; }
        .list-area { max-height: 250px; overflow-y: auto; border: 1px solid #444; background: #222; }
        .list-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #333; align-items: center; }
        .config-area { background: #2b2b2b; padding: 15px; border-radius: 4px; }
        
        .prob-timer-input { width: 50px; padding: 5px; font-size: 14px; text-align: right; margin-right: 5px; }
        .turn-config { background: #222; padding: 10px; border: 1px dashed #666; margin-top: 10px; }
        .turn-config label { display: block; font-size: 12px; color: #aaa; margin-top: 5px; }
        .turn-config input { width: 90%; font-size: 14px; }
        .ans-input { width: 150px; padding: 5px; font-size: 14px; background: #444; border: 1px solid #666; color: #fff; margin-left: 5px;}
    </style>
</head>
<body>

    <div id="host-app" class="hidden">
        <div id="screen-title" class="screen active">
            <h1>POLYHEDRON QUIZ V16.4</h1>
            <div style="margin-top: 50px;">
                <button class="btn" style="font-size:24px; padding:20px 50px;" onclick="Host.showLobby()">„Çπ„Çø„Éº„Éà</button>
            </div>
            <div style="margin-top: 20px;">
                <button class="btn" onclick="Host.showSettings()">Ë®≠ÂÆö</button>
            </div>
        </div>

        <div id="screen-lobby" class="screen">
            <h1>LOBBY</h1>
            <div id="host-info">
                <div>ÂèÇÂä†Áî®URL („ÇØ„É™„ÉÉ„ÇØ„Åß„Ç≥„Éî„Éº)</div>
                <div id="host-url" class="url-box" onclick="Host.copyUrl()">---</div>
                <div id="qr-area"></div>
                <div style="margin-top:10px;">ÂèÇÂä†ËÄÖ: <span id="p-count" style="color:var(--accent); font-weight:bold;">0</span>‰∫∫</div>
                <div id="player-list"></div>
            </div>
            <div style="margin-top:30px;">
                <button class="btn" style="font-size:24px; padding:20px 50px; background:var(--accent); color:#000; border:none;" onclick="Host.showProblemSelect()">„Ç≤„Éº„É†„Çπ„Çø„Éº„Éà</button>
                <br>
                <button class="btn" onclick="Host.showTitle()">Êàª„Çã</button>
            </div>
        </div>

        <div id="screen-prob-select" class="screen">
            <h1>SELECT PROBLEM</h1>
            <div id="question-grid"></div>
            <button class="btn" style="margin-top:30px;" onclick="Host.showLobby()">Êàª„Çã</button>
        </div>

        <div id="screen-settings" class="screen">
            <div class="settings-container">
                <h2>Ë®≠ÂÆö & ÂïèÈ°åÁÆ°ÁêÜ</h2>
                <div class="list-area" id="word-list"></div>
                <div style="display:flex; gap:10px; align-items:flex-end;">
                    <div style="flex:1;">
                        <input type="text" id="inp-word" placeholder="Ë°®Á§∫ÂçòË™û (SPACEÂå∫Âàá„Çä)" style="width:100%; margin-bottom:5px;">
                        <input type="text" id="inp-ans" placeholder="Ê≠£Ëß£ („Ç´„É≥„ÉûÂå∫Âàá„Çä, Á©∫Ê¨Ñ„Å™„ÇâË°®Á§∫„Å®Âêå„Åò)" style="width:100%;">
                    </div>
                    <button class="btn-add" style="height:80px;" onclick="Host.addWord()">ËøΩÂä†</button>
                </div>
                <div class="config-area">
                    <label>‚è± Âü∫Êú¨Âà∂ÈôêÊôÇÈñì(Áßí): <input type="number" id="time-limit" value="30" style="width:60px;" onchange="Host.saveData()"></label><br><br>
                    <label>üöÄ ÂõûËª¢„Çπ„Éî„Éº„Éâ: <input type="range" id="speed-slider" min="0" max="300" value="130" oninput="Host.updateSpeed(this.value)"> <span id="speed-val">130</span>%</label>
                    
                    <div class="turn-config">
                        <strong style="color:var(--gold);">üåê „Éç„ÉÉ„Éà„ÉØ„Éº„ÇØË®≠ÂÆö (5GÂØæÁ≠ñ)</strong>
                        <p style="font-size:11px; margin:5px 0;">5G/4G„Å®WiFi„ÅßÁπã„Åå„Çâ„Å™„ÅÑÂ†¥Âêà„ÄÅTURN„Çµ„Éº„Éê„Éº„ÇíË®≠ÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ</p>
                        <label>TURN URL</label>
                        <input type="text" id="turn-url" placeholder="turn:your.turn.server:3478" onchange="Host.saveData()">
                        <label>Username</label>
                        <input type="text" id="turn-user" placeholder="username" onchange="Host.saveData()">
                        <label>Password</label>
                        <input type="password" id="turn-pass" placeholder="password" onchange="Host.saveData()">
                    </div>
                </div>
                <button class="btn" onclick="Host.showTitle()">Êàª„Çã</button>
            </div>
        </div>

        <div id="game-ui">
            <button id="back-btn" class="btn" onclick="Host.backToTitle()">„Çø„Ç§„Éà„É´„Å∏</button>
            <div id="timer-display"></div>
            <div id="countdown-display">3</div>
        </div>
        <div id="canvas-container"></div>

        <div id="result-screen" class="hidden">
            <div id="res-left"></div>
            <div id="res-right">
                <h2 style="text-align:center; color:#fff; border-bottom:1px solid #555;">RANKING</h2>
                <div id="ranking-list"></div>
                <button class="btn" style="margin-top:auto;" onclick="Host.backToSelect()">ÂïèÈ°åÈÅ∏Êäû„Å∏</button>
            </div>
            <div id="seek-bar-container"><div id="seek-bar"></div></div>
        </div>
    </div>

    <div id="client-app" class="hidden">
        <div id="conn-indicator" title="Êé•Á∂öÁä∂ÊÖã"></div>
        <div id="c-login" class="screen active">
            <h1>ENTRY</h1>
            <input type="text" id="c-name" placeholder="ÂêçÂâç„ÇíÂÖ•Âäõ"><br><br>
            <button class="btn btn-add" onclick="Client.join()">ÂèÇÂä†„Åô„Çã</button>
        </div>
        <div id="c-game" class="screen hidden">
            <div id="c-status">ÂïèÈ°åÂá∫È°å„Åæ„Åß„ÅäÂæÖ„Å°„Åè„Å†„Åï„ÅÑ</div>
            <input type="text" id="c-input" placeholder="Ëß£Á≠î„ÇíÂÖ•Âäõ" disabled>
            <button id="c-btn-submit" onclick="Client.submitAnswer()" disabled>ÈÄÅ‰ø°</button>
        </div>
    </div>

    <audio id="se-correct" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="></audio> <audio id="se-wrong" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA="></audio> 

<script>
/* ================= COMMON UTILS ================= */
const DEFAULT_ICE_SERVERS = [
    { urls: 'stun:stun.l.google.com:19302' },
    { urls: 'stun:stun1.l.google.com:19302' },
    { urls: 'stun:stun2.l.google.com:19302' },
    { urls: 'stun:stun3.l.google.com:19302' },
    { urls: 'stun:stun4.l.google.com:19302' }
];

const AudioCtx = window.AudioContext || window.webkitAudioContext;
const actx = new AudioCtx();
function playTone(freq, type, dur) {
    const osc = actx.createOscillator();
    const gain = actx.createGain();
    osc.type = type;
    osc.frequency.value = freq;
    osc.connect(gain);
    gain.connect(actx.destination);
    osc.start();
    gain.gain.exponentialRampToValueAtTime(0.00001, actx.currentTime + dur);
    osc.stop(actx.currentTime + dur);
}
function playCorrectSE() { playTone(880, 'sine', 0.1); setTimeout(()=>playTone(1760, 'sine', 0.4), 100); }
function playWrongSE() { playTone(150, 'sawtooth', 0.4); }
function playCountSE(final=false) { 
    if(final) playTone(880, 'triangle', 0.6); 
    else playTone(440, 'triangle', 0.2); 
}

/* ================= HOST LOGIC ================= */
const Host = {
    peer: null, conns: {}, players: {}, answers: [],
    // problems: [{text: "DISPLAY", answers:["ANS1", "ANS2"], time: 30}, ...]
    problems: [], 
    config: { speed: 130, timeLimit: 30, turnUrl: "", turnUser: "", turnPass: "" },
    currentProblem: null, startTime: 0, timerId: null, currentLimit: 30,
    replayTimer: null,
    
    init: () => {
        // V16_4Áî®„Å´„Ç≠„ÉºÂ§âÊõ¥
        const savedP = localStorage.getItem('polyDataV16_4');
        if(savedP) {
            const data = JSON.parse(savedP);
            Host.problems = data.problems || [];
            Host.config = { ...Host.config, ...data.config }; 
        } else {
            Host.problems = [
                {text: "RANDOM", answers:["RANDOM"], time: 30},
                {text: "CUBE66 TETRA4", answers:["CUBE66 TETRA4"], time: 30},
                {text: "ICOSAHEDRON20", answers:["ICOSAHEDRON20"], time: 30}
            ];
        }
        
        document.getElementById('time-limit').value = Host.config.timeLimit;
        document.getElementById('speed-slider').value = Host.config.speed;
        document.getElementById('speed-val').innerText = Host.config.speed;
        document.getElementById('turn-url').value = Host.config.turnUrl || "";
        document.getElementById('turn-user').value = Host.config.turnUser || "";
        document.getElementById('turn-pass').value = Host.config.turnPass || "";

        const iceConfig = [...DEFAULT_ICE_SERVERS];
        if(Host.config.turnUrl) {
            iceConfig.push({
                urls: Host.config.turnUrl,
                username: Host.config.turnUser,
                credential: Host.config.turnPass
            });
        }

        Host.peer = new Peer({ config: { iceServers: iceConfig } });
        
        Host.peer.on('open', id => {
            const url = location.href.split('?')[0] + '?host=' + id;
            new QRCode(document.getElementById('qr-area'), { text: url, width: 128, height: 128 });
            document.getElementById('host-url').innerText = url;
        });
        Host.peer.on('connection', conn => {
            Host.conns[conn.peer] = conn;
            conn.on('data', data => Host.handleData(conn.peer, data));
            conn.on('close', () => {
                delete Host.players[conn.peer];
                delete Host.conns[conn.peer];
                Host.updatePlayerList();
            });
        });
        Host.peer.on('error', err => {
            console.error(err);
            alert("ÈÄö‰ø°„Ç®„É©„Éº: " + err.type + "\nË®≠ÂÆö„Åã„ÇâTURN„Çµ„Éº„Éê„Éº„ÇíÁ¢∫Ë™ç„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
        });

        document.getElementById('host-app').classList.remove('hidden'); 
        Host.renderProbList();
        Host.showTitle();
    },

    handleData: (id, data) => {
        if(data.type === 'JOIN') {
            Host.players[id] = { name: data.name, score: 0 };
            Host.updatePlayerList();
        } else if(data.type === 'ANSWER') {
            if(!Host.answers.find(a => a.id === id)) {
                const timeOffset = (Date.now() - Host.startTime) / 1000;
                Host.answers.push({ id: id, name: Host.players[id].name, ans: data.text, timeOffset: timeOffset });
            }
        }
    },

    updatePlayerList: () => {
        document.getElementById('p-count').innerText = Object.keys(Host.players).length;
        document.getElementById('player-list').innerHTML = Object.values(Host.players).map(p => `<div class="p-chip">${p.name}</div>`).join('');
    },

    copyUrl: () => {
        const text = document.getElementById('host-url').innerText;
        navigator.clipboard.writeText(text).then(() => alert('URL„Çí„Ç≥„Éî„Éº„Åó„Åæ„Åó„Åü'));
    },

    // --- Screens ---
    showTitle: () => {
        document.getElementById('screen-title').classList.add('active');
        document.getElementById('screen-lobby').classList.remove('active');
        document.getElementById('screen-prob-select').classList.remove('active');
        document.getElementById('screen-settings').classList.remove('active');
        document.getElementById('game-ui').style.display = 'none';
        document.getElementById('result-screen').classList.add('hidden');
        document.getElementById('canvas-container').style.zIndex = 1;
        Three.stop();
        Host.broadcast({ type: 'STATUS', text: 'ÂæÖÊ©ü‰∏≠...' });
    },
    
    showLobby: () => {
        document.getElementById('screen-title').classList.remove('active');
        document.getElementById('screen-prob-select').classList.remove('active');
        document.getElementById('screen-lobby').classList.add('active');
    },

    showProblemSelect: () => {
        document.getElementById('screen-lobby').classList.remove('active');
        document.getElementById('screen-prob-select').classList.add('active');
        document.getElementById('result-screen').classList.add('hidden');
        Host.renderProbBtns();
    },

    showSettings: () => {
        document.getElementById('screen-title').classList.remove('active');
        document.getElementById('screen-settings').classList.add('active');
        Host.renderProbList();
    },

    // --- Game ---
    startGame: (idx) => {
        Host.currentProblem = Host.problems[idx];
        Host.answers = [];
        
        document.getElementById('screen-prob-select').classList.remove('active');
        document.getElementById('game-ui').style.display = 'block';
        document.getElementById('timer-display').innerText = "";
        
        Three.stop(); 
        
        let count = 3;
        const cdEl = document.getElementById('countdown-display');
        cdEl.style.display = 'block';
        cdEl.innerText = count;
        playCountSE();

        const cdTimer = setInterval(() => {
            count--;
            if (count > 0) {
                cdEl.innerText = count;
                playCountSE();
            } else {
                clearInterval(cdTimer);
                cdEl.style.display = 'none';
                playCountSE(true);
                Host.startActualGame();
            }
        }, 1000);
    },
    
    startActualGame: () => {
        Three.init(Host.currentProblem.text, Host.config.speed / 100);
        Three.captureState();

        let limit = Host.currentProblem.time;
        if (!limit || limit <= 0) limit = parseInt(document.getElementById('time-limit').value);
        Host.currentLimit = limit;

        document.getElementById('timer-display').innerText = limit;
        
        Host.broadcast({ type: 'START' });
        Host.startTime = Date.now();
        
        let timeLeft = limit;
        Host.timerId = setInterval(() => {
            timeLeft--;
            document.getElementById('timer-display').innerText = timeLeft;
            if(timeLeft <= 0) Host.finishGame();
        }, 1000);
    },

    finishGame: () => {
        clearInterval(Host.timerId);
        document.getElementById('timer-display').innerText = "TIME UP";
        Host.broadcast({ type: 'END' });
        setTimeout(() => { Host.showResult(); }, 2000);
    },
    
    backToTitle: () => {
        clearInterval(Host.timerId);
        if(Host.replayTimer) clearInterval(Host.replayTimer);
        Host.showTitle();
    },

    backToSelect: () => {
        clearInterval(Host.timerId);
        if(Host.replayTimer) clearInterval(Host.replayTimer);
        Host.showProblemSelect();
        Host.broadcast({ type: 'STATUS', text: 'ÂïèÈ°åÈÅ∏Êäû‰∏≠...' });
    },

    // --- Result & Replay ---
    showResult: () => {
        document.getElementById('result-screen').classList.remove('hidden');
        document.getElementById('ranking-list').innerHTML = "";
        
        Three.setupReplay(); 

        const limit = Host.currentLimit;
        const REPLAY_TIME = 30; 
        const speedFactor = limit / REPLAY_TIME;
        Three.speed = (Host.config.speed / 100) * speedFactor;

        // Grading: Check against all possible answers
        // Fallback: if answers array is empty or undefined, use problem text (normalized)
        let validAnswers = [];
        if(Host.currentProblem.answers && Host.currentProblem.answers.length > 0) {
            validAnswers = Host.currentProblem.answers.map(a => a.trim().toUpperCase());
        } else {
            validAnswers = [Host.currentProblem.text.trim().toUpperCase()];
        }

        Host.answers.forEach(a => {
            const userAns = a.ans.trim().toUpperCase();
            a.isCorrect = validAnswers.includes(userAns);
        });
        Host.answers.sort((a,b) => a.timeOffset - b.timeOffset);

        let correctRank = 0;
        Host.answers.forEach(a => {
            if(a.isCorrect) {
                correctRank++;
                if(correctRank === 1) a.points = 5;
                else if(correctRank === 2) a.points = 4;
                else if(correctRank === 3) a.points = 3;
                else if(correctRank === 4) a.points = 2;
                else a.points = 1;
            } else { a.points = 0; }
        });

        const bar = document.getElementById('seek-bar');
        const list = document.getElementById('ranking-list');
        
        let replayStartTime = Date.now();
        let answerIndex = 0;

        Host.replayTimer = setInterval(() => {
            const realElapsed = (Date.now() - replayStartTime) / 1000;
            const virtualElapsed = realElapsed * speedFactor;
            const progress = Math.min((realElapsed / REPLAY_TIME) * 100, 100);
            bar.style.width = progress + "%";

            while(answerIndex < Host.answers.length) {
                const ans = Host.answers[answerIndex];
                if(virtualElapsed >= ans.timeOffset) {
                    const div = document.createElement('div');
                    div.className = `rank-row ${ans.isCorrect ? 'correct' : 'incorrect'}`;
                    div.innerHTML = `<span class="r-name">${ans.name}</span><span class="r-ans">${ans.ans}</span><span class="r-score">+${ans.points}pt</span>`;
                    list.appendChild(div);
                    div.offsetWidth; div.classList.add('show');
                    if(ans.isCorrect) playCorrectSE(); else playWrongSE();
                    answerIndex++;
                } else { break; }
            }
            if(realElapsed >= REPLAY_TIME + 1) clearInterval(Host.replayTimer);
        }, 50);
    },

    // --- Helpers ---
    renderProbBtns: () => {
        const grid = document.getElementById('question-grid');
        grid.innerHTML = "";
        Host.problems.forEach((p, i) => {
            const btn = document.createElement('div');
            btn.className = 'q-btn';
            btn.innerHTML = `<div class="q-num">Q.${i+1}</div>`; 
            btn.onclick = () => Host.startGame(i);
            grid.appendChild(btn);
        });
    },
    
    renderProbList: () => {
        const l = document.getElementById('word-list');
        l.innerHTML = Host.problems.map((p,i) => `
            <div class="list-item">
                <div style="flex:1;">
                    <div style="font-size:12px; color:#aaa;">Q.${i+1}</div>
                    <div class="item-word">${p.text}</div>
                    <div style="font-size:10px; color:#0f0;">Ê≠£Ëß£: ${p.answers ? p.answers.join(', ') : p.text}</div>
                </div>
                <div style="display:flex; align-items:center;">
                    ‚è± <input type="number" class="prob-timer-input" value="${p.time || ''}" placeholder="De" onchange="Host.updateProbTime(${i}, this.value)">
                    <button class="btn btn-sm" onclick="Host.moveProb(${i}, -1)">‚ñ≤</button>
                    <button class="btn btn-sm" onclick="Host.moveProb(${i}, 1)">‚ñº</button>
                    <button class="btn btn-add" style="background:#cc0000; padding:2px 10px; font-size:12px;" onclick="Host.delProb(${i})">√ó</button>
                </div>
            </div>
        `).join('');
    },

    moveProb: (idx, dir) => {
        if(idx + dir < 0 || idx + dir >= Host.problems.length) return;
        [Host.problems[idx], Host.problems[idx+dir]] = [Host.problems[idx+dir], Host.problems[idx]];
        Host.saveData();
        Host.renderProbList();
    },

    addWord: () => {
        const v = document.getElementById('inp-word').value.trim().toUpperCase();
        const aVal = document.getElementById('inp-ans').value.trim().toUpperCase();
        const defTime = parseInt(document.getElementById('time-limit').value) || 30;
        
        if(v) { 
            // Split answer by comma, remove whitespace
            let ansList = [];
            if(aVal) {
                ansList = aVal.split(',').map(s => s.trim()).filter(s => s.length > 0);
            } else {
                ansList = [v]; // Default to display text
            }

            Host.problems.push({text: v, answers: ansList, time: defTime}); 
            Host.saveData(); 
            Host.renderProbList(); 
            document.getElementById('inp-word').value = ""; 
            document.getElementById('inp-ans').value = ""; 
        }
    },
    updateProbTime: (idx, val) => {
        Host.problems[idx].time = parseInt(val) || 0;
        Host.saveData();
    },
    delProb: (i) => { Host.problems.splice(i,1); Host.saveData(); Host.renderProbList(); },
    
    saveData: () => {
        Host.config.timeLimit = parseInt(document.getElementById('time-limit').value);
        Host.config.turnUrl = document.getElementById('turn-url').value;
        Host.config.turnUser = document.getElementById('turn-user').value;
        Host.config.turnPass = document.getElementById('turn-pass').value;
        
        localStorage.setItem('polyDataV16_4', JSON.stringify({
            problems: Host.problems,
            config: Host.config
        }));
    },
    
    updateSpeed: (v) => { document.getElementById('speed-val').innerText = v; Host.config.speed = parseInt(v); Host.saveData(); },
    broadcast: (data) => { for(let id in Host.conns) Host.conns[id].send(data); }
};

/* ================= CLIENT LOGIC ================= */
const Client = {
    peer: null, conn: null, name: "",
    init: (hostId) => {
        document.getElementById('host-app').classList.add('hidden');
        const cApp = document.getElementById('client-app');
        cApp.classList.remove('hidden');
        cApp.style.display = 'flex';
        document.getElementById('c-login').classList.add('active');
        document.getElementById('c-game').classList.remove('active');
        
        Client.peer = new Peer({ config: { iceServers: DEFAULT_ICE_SERVERS } });
        
        Client.peer.on('open', () => {
            Client.conn = Client.peer.connect(hostId);
            Client.conn.on('open', () => { 
                console.log("Connected"); 
                document.getElementById('conn-indicator').classList.add('on');
            });
            Client.conn.on('data', data => Client.handleData(data));
            Client.conn.on('close', () => {
                document.getElementById('conn-indicator').classList.remove('on');
                alert("„Éõ„Çπ„Éà„Å®„ÅÆÊé•Á∂ö„ÅåÂàá„Çå„Åæ„Åó„Åü");
            });
        });
    },

    join: () => {
        const n = document.getElementById('c-name').value;
        if(!n) return;
        Client.name = n;
        Client.conn.send({ type: 'JOIN', name: n });
        document.getElementById('c-login').classList.remove('active');
        document.getElementById('c-login').style.display = 'none';
        document.getElementById('c-game').classList.add('active');
        document.getElementById('c-game').style.display = 'flex';
        document.getElementById('c-game').classList.remove('hidden');
    },

    handleData: (data) => {
        const status = document.getElementById('c-status');
        const input = document.getElementById('c-input');
        const btn = document.getElementById('c-btn-submit');

        if(data.type === 'START') {
            status.innerText = "Ëß£Á≠îÂèó‰ªò‰∏≠ÔºÅ";
            status.style.color = "#00d2ff";
            input.disabled = false; input.value = ""; btn.disabled = false; input.focus();
        } else if(data.type === 'END') {
            status.innerText = "ÁµÇ‰∫ÜÔºÅÁµêÊûúÁô∫Ë°®ÂæÖ„Å°...";
            status.style.color = "#ff4444";
            input.disabled = true; btn.disabled = true;
        } else if(data.type === 'STATUS') {
            status.innerText = data.text;
        }
    },

    submitAnswer: () => {
        const text = document.getElementById('c-input').value;
        if(!text) return;
        Client.conn.send({ type: 'ANSWER', text: text });
        document.getElementById('c-status').innerText = "ÈÄÅ‰ø°Ê∏à„Åø„ÄÇÂæÖÊ©ü‰∏≠...";
        document.getElementById('c-input').disabled = true;
        document.getElementById('c-btn-submit').disabled = true;
    }
};

/* ================= THREE.JS LOGIC ================= */
const Three = {
    scene: null, camera: null, renderer: null, reqId: null, meshes: [], speed: 1.0, currentZ: 15,
    initialStates: [],
    
    init: (text, speed) => {
        Three.stop();
        Three.speed = speed;
        const container = document.getElementById('canvas-container');
        Three.scene = new THREE.Scene(); Three.scene.background = new THREE.Color(0x222222);
        Three.camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 1000); 
        Three.camera.position.z = 15; Three.currentZ = 15;
        Three.renderer = new THREE.WebGLRenderer({ antialias: true }); Three.renderer.setSize(window.innerWidth, window.innerHeight); container.appendChild(Three.renderer.domElement);
        const light = new THREE.DirectionalLight(0xffffff, 1); light.position.set(5, 10, 7); Three.scene.add(light); Three.scene.add(new THREE.AmbientLight(0xffffff, 0.5));
        
        const words = text.trim().split(/\s+/);
        const spacing = 8;
        const startX = -((words.length - 1) * spacing) / 2;
        
        words.forEach((w, i) => {
            const mesh = Three.createPerfectPolyhedron(w.split(''), w.length);
            mesh.position.x = startX + i * spacing;
            mesh.userData = { rx: (Math.random()*0.01 + 0.005) * (Math.random()<0.5?1:-1), ry: (Math.random()*0.01 + 0.005) * (Math.random()<0.5?1:-1) };
            Three.scene.add(mesh); Three.meshes.push(mesh);
        });
        if(words.length > 2) { Three.currentZ = 15 + (words.length-2)*5; Three.camera.position.z = Three.currentZ; }
        Three.animate();
    },

    captureState: () => {
        Three.initialStates = Three.meshes.map(m => ({ x: m.rotation.x, y: m.rotation.y, z: m.rotation.z }));
    },
    
    setupReplay: () => {
        Three.meshes.forEach((m, i) => {
            if(Three.initialStates[i]) {
                m.rotation.set(Three.initialStates[i].x, Three.initialStates[i].y, Three.initialStates[i].z);
            }
        });
        if(Three.camera) {
            Three.camera.position.x = 5; 
            Three.camera.position.z = Three.currentZ * 1.4; 
        }
    },
    
    createPerfectPolyhedron: (chars, count) => {
        for (let i = chars.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [chars[i], chars[j]] = [chars[j], chars[i]]; }

        let baseGeometry;
        const r = 3.0;

        switch (count) {
            case 4:  baseGeometry = new THREE.TetrahedronGeometry(r); break;
            case 6:  baseGeometry = new THREE.BoxGeometry(r*1.2, r*1.2, r*1.2); break;
            case 8:  baseGeometry = new THREE.OctahedronGeometry(r); break;
            case 12: baseGeometry = new THREE.DodecahedronGeometry(r); break;
            case 20: baseGeometry = new THREE.IcosahedronGeometry(r); break;
            default: baseGeometry = new THREE.SphereGeometry(r, 16, 16);
        }

        if (count === 12) {
            const mats = [];
            for(let i=0; i<chars.length; i++) mats.push(new THREE.MeshStandardMaterial({ map: Three.createTextTexture(chars[i], count, 0), color: 0xeeeeee }));
            return new THREE.Mesh(baseGeometry, mats);
        }

        let geometry = baseGeometry.toNonIndexed();
        geometry.computeVertexNormals();

        const posAttribute = geometry.attributes.position;
        const normAttribute = geometry.attributes.normal;
        const vertexCount = posAttribute.count;
        const verticesPerFace = vertexCount / count;

        geometry.clearGroups();
        const uvAttribute = geometry.attributes.uv;

        for (let i = 0; i < count; i++) {
            geometry.addGroup(i * verticesPerFace, verticesPerFace, i);

            const firstVIndex = i * verticesPerFace;
            const nx = normAttribute.getX(firstVIndex);
            const ny = normAttribute.getY(firstVIndex);
            const nz = normAttribute.getZ(firstVIndex);
            const normal = new THREE.Vector3(nx, ny, nz).normalize();

            const v0 = new THREE.Vector3(posAttribute.getX(firstVIndex), posAttribute.getY(firstVIndex), posAttribute.getZ(firstVIndex));
            const v1 = new THREE.Vector3(posAttribute.getX(firstVIndex+1), posAttribute.getY(firstVIndex+1), posAttribute.getZ(firstVIndex+1));
            const tangent = new THREE.Vector3().subVectors(v1, v0).normalize();
            const bitangent = new THREE.Vector3().crossVectors(normal, tangent).normalize();

            const scale = (count === 4 || count === 8 || count === 20) ? 0.25 : 0.35;

            for (let v = 0; v < verticesPerFace; v++) {
                const vi = firstVIndex + v;
                const pos = new THREE.Vector3(
                    posAttribute.getX(vi),
                    posAttribute.getY(vi),
                    posAttribute.getZ(vi)
                );
                
                let u = pos.dot(tangent) * scale + 0.5;
                let v_coord = pos.dot(bitangent) * scale + 0.5;
                uvAttribute.setXY(vi, u, v_coord);
            }
        }
        geometry.attributes.uv.needsUpdate = true;

        const materials = [];
        let symmetryOrder = 4;
        if (count === 4 || count === 8 || count === 20) symmetryOrder = 3;

        for (let i = 0; i < count; i++) {
            const rotationIndex = Math.floor(Math.random() * symmetryOrder);
            const rotationAngle = rotationIndex * (Math.PI * 2 / symmetryOrder);

            materials.push(new THREE.MeshStandardMaterial({
                map: Three.createTextTexture(chars[i], count, rotationAngle),
                color: 0xeeeeee, 
                roughness: 1.0,
                metalness: 0.0,
                side: THREE.FrontSide
            }));
        }

        return new THREE.Mesh(geometry, materials);
    },
    
    createTextTexture: (char, count, rotationAngle) => {
        const size = 512;
        const canvas = document.createElement('canvas');
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');

        ctx.fillStyle = '#eeeeee';
        ctx.fillRect(0, 0, size, size);
        
        ctx.save();
        ctx.translate(size/2, size/2);
        ctx.rotate(rotationAngle);

        ctx.fillStyle = '#000000';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        
        let yOffset = 0;
        let fontSize = 380;

        if (count === 4 || count === 8) {
            fontSize = 220;
            yOffset = 10;
        } else if (count === 20) {
            fontSize = 170;
            yOffset = 15;
        } else if (count === 6) {
            fontSize = 420;
            yOffset = 0;
        } else if (count === 12) {
            fontSize = 280;
            yOffset = 0;
        }

        ctx.font = `bold ${fontSize}px sans-serif`; 
        ctx.fillText(char, 0, 0 + yOffset);

        ctx.restore();

        const tex = new THREE.CanvasTexture(canvas);
        tex.minFilter = THREE.LinearFilter;
        tex.center.set(0.5, 0.5); 
        return tex;
    },

    animate: () => {
        Three.reqId = requestAnimationFrame(Three.animate);
        Three.meshes.forEach(m => { 
            m.rotation.x += m.userData.rx * Three.speed; 
            m.rotation.y += m.userData.ry * Three.speed; 
        });
        Three.renderer.render(Three.scene, Three.camera);
    },
    
    stop: () => {
        if(Three.reqId) cancelAnimationFrame(Three.reqId);
        const el = document.getElementById('canvas-container');
        while(el.firstChild) el.removeChild(el.firstChild);
        Three.meshes = [];
        Three.initialStates = [];
    }
};

const params = new URLSearchParams(location.search);
if(params.get('host')) Client.init(params.get('host'));
else Host.init();

</script>
</body>
</html>
