<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>クイズ：光文字の灯火 V6.0</title>
    <style>
        :root {
            --bg-color: #111;
            --text-color: #ddd;
            --accent-color: #aaa;
            --panel-bg: #222;
            --border-color: #444;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: "Yu Mincho", "Hiragino Mincho ProN", serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        /* --- 画面管理 --- */
        .screen {
            display: none;
            width: 100%;
            height: 100%;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            position: absolute;
            top: 0;
            left: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .screen.active {
            display: flex;
        }

        h1, h2 {
            font-weight: normal;
            border-bottom: 1px solid #555;
            padding-bottom: 10px;
            margin-bottom: 30px;
            text-align: center;
        }

        /* --- 共通パーツ --- */
        button {
            background: var(--panel-bg);
            color: #fff;
            border: 1px solid #666;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            transition: 0.2s;
            font-family: inherit;
            font-size: 1rem;
        }
        button:hover {
            background: #444;
            border-color: #fff;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        input[type="text"], input[type="number"], input[type="color"] {
            background: #333;
            color: #fff;
            border: 1px solid #555;
            padding: 5px;
        }

        /* --- タイトル画面 --- */
        .title-menu {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .big-btn {
            font-size: 1.5rem;
            padding: 15px 40px;
            min-width: 200px;
        }

        /* --- 設定画面 --- */
        #settings-container {
            width: 90%;
            max-width: 800px;
            background: var(--panel-bg);
            padding: 20px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 80vh;
            overflow-y: auto;
        }

        .setting-section {
            margin-bottom: 30px;
            border-bottom: 1px dashed #444;
            padding-bottom: 20px;
        }

        /* 問題リスト */
        #question-list-container {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #444;
            margin-bottom: 10px;
            background: #000;
        }
        .q-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            border-bottom: 1px solid #333;
        }
        .q-item:last-child { border-bottom: none; }
        
        .q-text-view { 
            flex-grow: 1; text-align: left; padding-left: 10px; 
            white-space: pre-wrap; font-size: 0.9rem;
        }
        
        .q-edit-area {
            flex-grow: 1; display: flex; gap: 5px; margin-right: 10px;
        }
        .q-edit-input {
            flex-grow: 1;
            background: #222; color: #fff; border: 1px solid #88ff88;
            font-family: inherit; font-size: 0.9rem; padding: 5px;
            resize: none;
        }
        .q-edit-size {
            width: 50px;
            background: #222; color: #fff; border: 1px solid #88ff88;
            text-align: center;
        }

        .q-controls button {
            padding: 2px 8px;
            font-size: 0.8rem;
            margin: 0 2px;
        }

        /* 光源リスト */
        #light-list-display {
            margin-top: 15px;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        .light-tag {
            display: inline-flex;
            align-items: center;
            background: #333;
            border: 1px solid #555;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.9rem;
            border-left-width: 5px;
        }
        .light-del-btn {
            margin-left: 8px;
            cursor: pointer;
            color: #ff6666;
            font-weight: bold;
            font-family: sans-serif;
        }
        .light-del-btn:hover { color: #ff0000; }

        /* スライダー制御 */
        .range-control {
            margin-top: 15px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .range-control input[type="range"] {
            flex-grow: 1;
        }

        /* --- 問題選択画面 --- */
        #level-select-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            width: 80%;
            max-width: 800px;
            max-height: 50vh; 
            overflow-y: auto;
            justify-content: center;
            align-content: flex-start;
        }
        .level-btn {
            width: 120px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
            background: #222;
            border: 1px solid #555;
        }
        
        .mode-switch-label {
            cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 1rem;
        }
        .mode-switch-label input[type="checkbox"] {
            transform: scale(1.5);
        }

        /* --- ゲーム画面（暗闇） --- */
        #darkness-stage {
            background-color: #000;
            width: 95%;
            max-width: 1000px;
            height: 60vh; 
            padding: 20px;
            margin: 20px 0;
            border: 4px double #333;
            position: relative;
            overflow: auto;
            display: grid;
            justify-content: center;
            align-content: center;
            gap: 2px; /* 隙間を詰める */
        }

        .char-box {
            width: 1.2em;
            height: 1.2em;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            color: transparent;
            transition: all 1.0s ease;
            user-select: none;
            background-clip: text;
            -webkit-background-clip: text;
            background-image: none;
        }

        .test-mode .char-box:not(.source):not(.reveal) {
            color: #222 !important;
            text-shadow: none !important;
            opacity: 1 !important;
        }

        .char-box.source {
            color: var(--char-color);
            text-shadow: 0 0 20px var(--char-color), 0 0 40px var(--char-color);
        }

        .char-box.reveal {
            color: #fff !important;
            text-shadow: none !important;
            opacity: 1 !important;
            background-image: none !important;
        }

        #game-controls {
            margin-top: 10px;
            display: flex;
            gap: 20px;
        }

        #new-q-input {
            height: 40px; 
        }

    </style>
</head>
<body>

    <div id="screen-title" class="screen active">
        <h1>光文字の灯火 V6.0</h1>
        <div class="title-menu">
            <button class="big-btn" onclick="goToLevelSelect()">ゲームスタート</button>
            <button class="big-btn" onclick="goToSettings()">設定</button>
        </div>
    </div>

    <div id="screen-settings" class="screen">
        <h2>設定・問題編集</h2>
        <div id="settings-container">
            <div class="setting-section">
                <h3>問題リスト</h3>
                <div id="question-list-container"></div>
                
                <div style="display:flex; gap:5px; margin-top:10px; align-items: flex-start;">
                    <textarea id="new-q-input" placeholder="新しい問題を入力 (改行で2行になります)" style="flex-grow:1; background:#333; color:#fff; border:1px solid #555; padding:5px; font-family:inherit; resize: vertical;"></textarea>
                    <div style="display:flex; flex-direction:column; gap:2px;">
                        <span style="font-size:0.8rem;">サイズ</span>
                        <input type="number" id="new-q-size" value="4" step="0.5" min="1" style="width:50px;">
                    </div>
                    <button onclick="addNewQuestion()" style="height: 50px;">追加</button>
                </div>
            </div>

            <div class="setting-section">
                <h3>光源文字の設定</h3>
                <p style="font-size:0.8rem; color:#888;">単語（例：花火）でも登録可能。長い単語が優先されます。</p>
                
                <div style="display:flex; gap:5px; flex-wrap:wrap; align-items:center;">
                    <input type="text" id="light-char" placeholder="文字/単語" size="8">
                    <input type="color" id="light-color" value="#ffffff">
                    <button onclick="addLightSetting()">登録/更新</button>
                </div>

                <div class="range-control">
                    <label for="light-range-input">光の届く範囲(0〜1文字):</label>
                    <input type="range" id="light-range-input" min="0" max="1" step="0.05" value="0.25" oninput="updateRangeDisplay()">
                    <span id="light-range-val">0.25</span>
                </div>
                <p style="font-size:0.8rem; color:#888;">斜め方向は距離(√2)分だけ減衰します</p>

                <div id="light-list-display"></div>
            </div>

            <div class="setting-section">
                <h3>その他の設定</h3>
                <label class="mode-switch-label">
                    <input type="checkbox" id="test-mode-toggle" onchange="saveData()">
                    テストモード（ゲーム中にうっすら文字を表示）
                </label>
            </div>
        </div>
        <button onclick="goToTitle()">タイトルに戻る</button>
    </div>

    <div id="screen-levels" class="screen">
        <h2>問題選択</h2>
        <div id="level-select-grid"></div>
        <div style="margin-top:20px;">
            <button onclick="goToTitle()">タイトルに戻る</button>
        </div>
    </div>

    <div id="screen-game" class="screen">
        <h2 id="q-number-display">第 X 問</h2>
        <div id="darkness-stage"></div>
        <div id="game-controls">
            <button onclick="showAnswer()">正解を表示</button>
            <button onclick="goToLevelSelect()">問題選択へ</button>
        </div>
    </div>

    <script>
        // --- デフォルトデータ ---
        const DEFAULT_QUESTIONS = [
            { text: "日光東照宮", size: 4 },
            { text: "一寸先は\n闇", size: 4 },
            { text: "焼肉定食\n食べ放題", size: 3.5 },
            { text: "花鳥風月", size: 5 },
            { text: "豪華絢爛", size: 5 }
        ];
        
        // データ保存キー（固定）
        const STORAGE_KEY = 'lightQuiz_Permanent_V6';

        // 状態変数
        let questions = [];
        let lightDatabase = {};
        let editingIndex = -1;
        let currentQuestionIndex = 0;
        let lightReach = 0.25; // 0.0 ~ 1.0

        // --- 初期化 ---
        window.onload = () => {
            loadData(); 
            renderQuestionList();
            renderLightList();
            updateRangeDisplay();
        };

        // --- データ永続化 (Save/Load) ---
        function saveData() {
            const data = {
                questions: questions,
                lightDatabase: lightDatabase,
                lightReach: document.getElementById('light-range-input').value,
                isTestMode: document.getElementById('test-mode-toggle').checked
            };
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        function loadData() {
            const json = localStorage.getItem(STORAGE_KEY);
            if (json) {
                try {
                    const data = JSON.parse(json);
                    questions = data.questions || DEFAULT_QUESTIONS;
                    lightDatabase = data.lightDatabase || {};
                    lightReach = parseFloat(data.lightReach);
                    if(isNaN(lightReach)) lightReach = 0.25;
                    
                    document.getElementById('light-range-input').value = lightReach;
                    document.getElementById('test-mode-toggle').checked = !!data.isTestMode;
                } catch (e) {
                    resetToDefault();
                }
            } else {
                resetToDefault();
            }
        }

        function resetToDefault() {
            questions = JSON.parse(JSON.stringify(DEFAULT_QUESTIONS));
            lightDatabase = {};
            lightReach = 0.25;
            document.getElementById('light-range-input').value = 0.25;
            document.getElementById('test-mode-toggle').checked = false;
            saveData();
        }

        function updateRangeDisplay() {
            const val = document.getElementById('light-range-input').value;
            document.getElementById('light-range-val').textContent = val;
            lightReach = parseFloat(val);
            saveData();
        }

        // --- 画面遷移関数 ---
        function switchScreen(screenId) {
            document.querySelectorAll('.screen').forEach(el => el.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        function goToTitle() { switchScreen('screen-title'); }
        function goToSettings() { switchScreen('screen-settings'); }
        
        function goToLevelSelect() {
            const grid = document.getElementById('level-select-grid');
            grid.innerHTML = '';
            
            questions.forEach((q, index) => {
                const btn = document.createElement('button');
                btn.className = 'level-btn';
                btn.textContent = `第${index + 1}問`;
                btn.onclick = () => startGame(index);
                grid.appendChild(btn);
            });
            switchScreen('screen-levels');
        }

        // --- 設定画面ロジック ---
        function renderQuestionList() {
            const container = document.getElementById('question-list-container');
            container.innerHTML = '';
            
            questions.forEach((q, index) => {
                const item = document.createElement('div');
                item.className = 'q-item';
                
                if (index === editingIndex) {
                    const editArea = document.createElement('div');
                    editArea.className = 'q-edit-area';

                    const input = document.createElement('textarea');
                    input.className = 'q-edit-input';
                    input.value = q.text;
                    input.rows = q.text.split('\n').length;
                    
                    const sizeInput = document.createElement('input');
                    sizeInput.type = 'number';
                    sizeInput.className = 'q-edit-size';
                    sizeInput.value = q.size;
                    sizeInput.step = 0.5;
                    sizeInput.min = 1;

                    editArea.append(input, sizeInput);
                    
                    const controls = document.createElement('div');
                    controls.className = 'q-controls';
                    
                    const btnSave = document.createElement('button');
                    btnSave.textContent = '完了';
                    btnSave.onclick = () => saveEdit(index, input.value, sizeInput.value);
                    
                    controls.appendChild(btnSave);
                    item.append(editArea, controls);

                } else {
                    const text = document.createElement('span');
                    text.className = 'q-text-view';
                    text.innerHTML = `${index + 1}. ${q.text.replace(/\n/g, '↵')} <small style="color:#888;">(サイズ:${q.size}rem)</small>`;
                    
                    const controls = document.createElement('div');
                    controls.className = 'q-controls';
                    
                    const btnUp = document.createElement('button'); btnUp.textContent = '↑'; btnUp.onclick = () => moveQuestion(index, -1);
                    const btnDown = document.createElement('button'); btnDown.textContent = '↓'; btnDown.onclick = () => moveQuestion(index, 1);
                    const btnEdit = document.createElement('button'); btnEdit.textContent = '編集'; btnEdit.onclick = () => startEdit(index);
                    const btnDel = document.createElement('button'); btnDel.textContent = '削除'; btnDel.onclick = () => deleteQuestion(index);

                    controls.append(btnUp, btnDown, btnEdit, btnDel);
                    item.append(text, controls);
                }
                
                container.appendChild(item);
            });
        }

        function addNewQuestion() {
            const input = document.getElementById('new-q-input');
            const sizeInput = document.getElementById('new-q-size');
            const val = input.value.trim();
            const size = parseFloat(sizeInput.value) || 4;

            if (val) {
                questions.push({ text: val, size: size });
                input.value = '';
                saveData(); 
                renderQuestionList();
            }
        }

        function deleteQuestion(index) {
            questions.splice(index, 1);
            if (editingIndex === index) editingIndex = -1;
            else if (editingIndex > index) editingIndex--;
            saveData(); 
            renderQuestionList();
        }

        function moveQuestion(index, direction) {
            editingIndex = -1;
            if (direction === -1 && index > 0) {
                [questions[index], questions[index - 1]] = [questions[index - 1], questions[index]];
            } else if (direction === 1 && index < questions.length - 1) {
                [questions[index], questions[index + 1]] = [questions[index + 1], questions[index]];
            }
            saveData(); 
            renderQuestionList();
        }

        function startEdit(index) {
            editingIndex = index;
            renderQuestionList();
        }

        function saveEdit(index, newVal, newSize) {
            if (newVal.trim() !== "") {
                questions[index].text = newVal.trim();
                questions[index].size = parseFloat(newSize) || 4;
                saveData(); 
            }
            editingIndex = -1;
            renderQuestionList();
        }

        function addLightSetting() {
            const char = document.getElementById('light-char').value.trim();
            // powerはV6では距離計算に使うため基本不要だが、データ構造維持のため10固定
            const power = 10; 
            const color = document.getElementById('light-color').value;
            if(!char) return;
            lightDatabase[char] = { power, color };
            saveData(); 
            renderLightList();
            document.getElementById('light-char').value = '';
        }

        function deleteLightSetting(char) {
            delete lightDatabase[char];
            saveData(); 
            renderLightList();
        }

        function renderLightList() {
            const container = document.getElementById('light-list-display');
            container.innerHTML = ''; 

            const keys = Object.keys(lightDatabase).sort((a,b) => b.length - a.length || a.localeCompare(b));

            keys.forEach(char => {
                const data = lightDatabase[char];
                const tag = document.createElement('div');
                tag.className = 'light-tag';
                tag.style.borderLeftColor = data.color;
                
                const label = document.createElement('span');
                label.innerHTML = `<strong>${char}</strong>`;
                
                const delBtn = document.createElement('span');
                delBtn.className = 'light-del-btn';
                delBtn.textContent = '×';
                delBtn.onclick = () => deleteLightSetting(char);

                tag.appendChild(label);
                tag.appendChild(delBtn);
                container.appendChild(tag);
            });
        }

        // --- ゲームロジック (距離減衰対応) ---

        function startGame(index) {
            currentQuestionIndex = index;
            document.getElementById('q-number-display').textContent = `第 ${index + 1} 問`;
            
            const stage = document.getElementById('darkness-stage');
            stage.innerHTML = ''; 

            const isTestMode = document.getElementById('test-mode-toggle').checked;
            if (isTestMode) stage.classList.add('test-mode');
            else stage.classList.remove('test-mode');

            const qObj = questions[index];
            const rawText = qObj.text;
            const fontSize = qObj.size; 

            const rows = rawText.split('\n');
            const rowCount = rows.length;
            const colCount = Math.max(...rows.map(r => r.length));

            stage.style.gridTemplateColumns = `repeat(${colCount}, auto)`;

            // グリッド初期化
            let lightMap = [];
            for(let y=0; y<rowCount; y++) {
                let rowData = [];
                for(let x=0; x<colCount; x++) {
                    const char = rows[y][x] || null; 
                    rowData.push({
                        char: char,
                        isSource: false,
                        color: '#ffffff',
                        incomingLights: [] 
                    });
                }
                lightMap.push(rowData);
            }

            // 光源判定
            const keywords = Object.keys(lightDatabase).sort((a, b) => b.length - a.length);

            for(let y=0; y<rowCount; y++) {
                const lineStr = rows[y];
                let usedFlags = new Array(lineStr.length).fill(false);

                keywords.forEach(keyword => {
                    let pos = lineStr.indexOf(keyword);
                    while (pos !== -1) {
                        let isFree = true;
                        for(let k=0; k<keyword.length; k++) {
                            if(usedFlags[pos + k]) isFree = false;
                        }
                        if(isFree) {
                            const data = lightDatabase[keyword];
                            for(let k=0; k<keyword.length; k++) {
                                const x = pos + k;
                                usedFlags[x] = true;
                                lightMap[y][x].isSource = true;
                                lightMap[y][x].color = data.color;
                            }
                        }
                        pos = lineStr.indexOf(keyword, pos + 1);
                    }
                });
            }

            // 光の伝播 (距離・方向計算)
            const DIRECTIONS = [
                { dx: 0, dy: -1, type: 'top' },    
                { dx: 0, dy: 1,  type: 'bottom' },
                { dx: -1, dy: 0, type: 'left' },
                { dx: 1, dy: 0,  type: 'right' },
                { dx: -1, dy: -1, type: 'topLeft' },
                { dx: 1, dy: -1,  type: 'topRight' },
                { dx: -1, dy: 1,  type: 'bottomLeft' },
                { dx: 1, dy: 1,   type: 'bottomRight' }
            ];

            // 対角線距離の定数
            const DIAG_DIST = 1.414; 

            for(let y=0; y<rowCount; y++) {
                for(let x=0; x<colCount; x++) {
                    const cell = lightMap[y][x];
                    if (!cell.isSource) continue; 

                    // 光源から周囲へ光を飛ばす
                    DIRECTIONS.forEach(dir => {
                        const tx = x + dir.dx;
                        const ty = y + dir.dy;

                        if (tx >= 0 && tx < colCount && ty >= 0 && ty < rowCount) {
                            const target = lightMap[ty][tx];
                            if (!target.isSource && target.char) {
                                
                                // 表示される長さ(%)の計算
                                let visibleRatio = 0;
                                
                                if (dir.dx === 0 || dir.dy === 0) {
                                    // 上下左右: 距離1
                                    // 設定値そのまま (例: 0.5なら50%見える)
                                    visibleRatio = lightReach;
                                } else {
                                    // 斜め: 距離√2 (約1.414)
                                    // 見える長さ = 設定値 - (距離 - 1)
                                    // つまり lightReach - 0.414
                                    visibleRatio = lightReach - (DIAG_DIST - 1);
                                }

                                if (visibleRatio > 0) {
                                    target.incomingLights.push({
                                        direction: getOppositeDirName(dir.type), 
                                        color: cell.color,
                                        ratio: Math.min(visibleRatio, 1.0), // 最大100%
                                        isDiagonal: (dir.dx !== 0 && dir.dy !== 0)
                                    });
                                }
                            }
                        }
                    });
                }
            }

            // DOM生成
            for(let y=0; y<rowCount; y++) {
                for(let x=0; x<colCount; x++) {
                    const cell = lightMap[y][x];
                    const span = document.createElement('div');
                    span.classList.add('char-box');
                    
                    span.style.fontSize = `${fontSize}rem`;

                    if (cell.char) {
                        span.textContent = cell.char;
                    } else {
                        span.textContent = "";
                        span.style.pointerEvents = "none";
                    }

                    if (cell.isSource) {
                        span.classList.add('source');
                        span.style.setProperty('--char-color', cell.color);
                        span.style.opacity = 1;

                    } else if (cell.char && cell.incomingLights.length > 0) {
                        let backgrounds = [];
                        let maxOpacity = 0;

                        cell.incomingLights.forEach(light => {
                            const c = light.color;
                            const t = 'rgba(0,0,0,0)'; 
                            const percent = Math.round(light.ratio * 100);
                            
                            // 明るさ(Opacity)は、近いほど(ratioが高いほど)明るくする
                            // ratio 0.1 -> opacity 0.2, ratio 1.0 -> opacity 1.0
                            maxOpacity = Math.max(maxOpacity, 0.1 + (light.ratio * 0.9));

                            if (!light.isDiagonal) {
                                // 線形グラデーション (近い方が色、遠い方が透明)
                                if (light.direction === 'left') { 
                                    // 左から光: 左0% -> 左P% (色), P%->透明
                                    backgrounds.push(`linear-gradient(90deg, ${c} 0%, ${t} ${percent}%)`);
                                } else if (light.direction === 'right') { 
                                    backgrounds.push(`linear-gradient(-90deg, ${c} 0%, ${t} ${percent}%)`);
                                } else if (light.direction === 'top') { 
                                    backgrounds.push(`linear-gradient(180deg, ${c} 0%, ${t} ${percent}%)`);
                                } else if (light.direction === 'bottom') { 
                                    backgrounds.push(`linear-gradient(0deg, ${c} 0%, ${t} ${percent}%)`);
                                }
                            } else {
                                // 斜め: 円形グラデーション
                                if (light.direction === 'topLeft') {
                                    backgrounds.push(`radial-gradient(circle at 0% 0%, ${c} 0%, ${t} ${percent}%)`);
                                } else if (light.direction === 'topRight') {
                                    backgrounds.push(`radial-gradient(circle at 100% 0%, ${c} 0%, ${t} ${percent}%)`);
                                } else if (light.direction === 'bottomLeft') {
                                    backgrounds.push(`radial-gradient(circle at 0% 100%, ${c} 0%, ${t} ${percent}%)`);
                                } else if (light.direction === 'bottomRight') {
                                    backgrounds.push(`radial-gradient(circle at 100% 100%, ${c} 0%, ${t} ${percent}%)`);
                                }
                            }
                        });

                        span.style.backgroundImage = backgrounds.join(',');
                        span.style.opacity = maxOpacity;

                    } else {
                        span.style.opacity = 0;
                    }

                    stage.appendChild(span);
                }
            }

            switchScreen('screen-game');
        }

        function getOppositeDirName(name) {
            switch(name) {
                case 'top': return 'bottom'; 
                case 'bottom': return 'top'; 
                case 'left': return 'right'; 
                case 'right': return 'left'; 
                case 'topLeft': return 'bottomRight';
                case 'topRight': return 'bottomLeft';
                case 'bottomLeft': return 'topRight';
                case 'bottomRight': return 'topLeft';
            }
            return '';
        }

        function showAnswer() {
            const chars = document.querySelectorAll('.char-box');
            chars.forEach(char => {
                char.classList.add('reveal');
            });
        }

    </script>
</body>
</html>
