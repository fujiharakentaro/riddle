<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>All-Star Quiz System V18</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@900&family=Anton&display=swap" rel="stylesheet">
    <style>
        :root { --col-1: #0088ff; --col-2: #ff2222; --col-3: #00cc00; --col-4: #ffcc00; }
        body { margin: 0; padding: 0; font-family: 'M PLUS Rounded 1c', sans-serif; width: 100vw; min-height: 100vh; overflow: hidden; user-select: none; background-color: #000; }
        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; flex-direction: column; }
        .full-screen { width: 100%; height: 100%; position: absolute; top: 0; left: 0; }
        
        /* 背景 (全画面共通・固定) */
        .tv-background {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: radial-gradient(white, rgba(255,255,255,.2) 2px, transparent 3px), radial-gradient(white, rgba(255,255,255,.15) 1px, transparent 2px), radial-gradient(white, rgba(255,255,255,.1) 2px, transparent 3px), linear-gradient(135deg, #00bfff 0%, #00008b 100%);
            background-size: 550px 550px, 350px 350px, 250px 250px, 100% 100%; animation: bgMove 60s linear infinite;
        }
        @keyframes bgMove { from { background-position: 0 0, 40px 60px, 130px 270px, 0 0; } to { background-position: 550px 550px, 390px 410px, 380px 820px, 0 0; } }

        /* TITLE */
        #title-view { z-index: 100; position: relative; height: 100vh; width: 100vw; }
        .title-logo-container { position: relative; margin-top: 8vh; margin-bottom: 5vh; transform: scale(1.3); text-align: center; }
        .title-logo-main {
            font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 900; font-size: 100px; line-height: 1;
            color: #ffd700; background: linear-gradient(to bottom, #fffebb 0%, #ffd700 50%, #b8860b 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(0 5px 0 #5c3a00) drop-shadow(0 0 5px #fff) drop-shadow(0 10px 20px #000);
            transform: perspective(500px) rotateX(20deg); letter-spacing: -5px; margin-top: 10px;
            -webkit-text-stroke: 2px #b8860b;
        }
        .title-logo-sub {
            position: absolute; top: -30px; left: 50%; transform: translateX(-50%) perspective(500px) rotateX(20deg);
            font-family: 'M PLUS Rounded 1c', sans-serif; font-weight: 900; font-size: 40px;
            background: linear-gradient(to right, #ff0000, #ffaa00, #ffff00, #00ff00, #00ffff, #0000ff, #ff00ff);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            filter: drop-shadow(2px 2px 0 #000) drop-shadow(0 0 10px #fff); 
            white-space: nowrap; z-index: 2; letter-spacing: 2px;
            -webkit-text-stroke: 1px #fff;
        }
        .title-btn {
            width: 400px; padding: 20px; margin: 15px; font-size: 32px; font-weight: 900; color: #fff;
            border-radius: 50px; cursor: pointer; border: 4px solid #fff;
            box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 5px 10px rgba(255,255,255,0.3);
            text-shadow: 2px 2px 4px #000; transition: 0.2s; font-family: 'Anton'; letter-spacing: 2px;
        }
        .btn-start-big { background: linear-gradient(to bottom, #ff3333, #aa0000); font-size: 40px; padding: 30px; }
        .btn-start-big:hover { transform: scale(1.05); background: linear-gradient(to bottom, #ff5555, #cc0000); }
        .btn-settings { background: linear-gradient(to bottom, #0066ff, #003399); width: 250px; font-size: 24px; }
        .btn-settings:hover { transform: scale(1.05); background: linear-gradient(to bottom, #4488ff, #0055cc); }

        /* SETUP */
        #setup-view { background: #1a1a1a; color: #fff; position: relative; height: 100vh; } 
        .setup-container { width: 950px; max-width: 95%; height: 90vh; background: #2a2a2a; border-radius: 10px; display: flex; flex-direction: column; padding: 20px; } 
        .setup-scroll { flex: 1; overflow-y: auto; padding-right: 15px; } 
        .connect-info-box { background: #000; border: 2px solid #00ff00; padding: 15px; border-radius: 10px; display: flex; align-items: center; justify-content: space-between; margin-bottom: 20px; }
        .qr-area { background: #fff; padding: 5px; border-radius: 5px; min-width: 150px; min-height: 150px; display: flex; align-items: center; justify-content: center; }
        .url-area { flex: 1; margin-left: 20px; }
        .url-input { width: 100%; background: #222; color: #0f0; border: 1px solid #00ff00; padding: 10px; font-family: monospace; font-size: 16px; margin-top: 5px; }
        input[type="text"], select { background: #111; color: #fff; border: 1px solid #555; padding: 5px; } 
        .p-card { background: #333; padding: 20px; margin-bottom: 30px; border: 2px solid #555; border-radius: 10px; position: relative; } 
        .q-card { background: #222; padding: 15px; margin-bottom: 15px; border: 1px solid #444; border-radius: 8px; } 
        .sort-card { background: linear-gradient(to bottom, #332200, #221100); border: 2px solid #ffd700; padding: 15px; margin-top: 15px; border-radius: 8px; }
        .btn { padding: 8px 16px; border-radius: 5px; cursor: pointer; border: none; font-weight: bold; color: #fff; } 
        .btn-blue { background: #0066ff; } .btn-red { background: #cc0000; } .btn-green { background: #00aa00; }
        .opt-cell { background: #111; padding: 5px; border: 1px solid #333; }

        /* HOST GAME */
        #host-view { display: flex; padding: 20px; box-sizing: border-box; position: relative; height: 100vh; }
        #period-select-view { background: rgba(0,0,0,0.9); z-index: 800; }
        .period-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; width: 90%; max-height: 70%; overflow-y: auto; padding: 20px; }
        .period-btn { background: linear-gradient(to bottom, #cc8800, #884400); border: 3px solid #ffcc00; border-radius: 15px; padding: 30px 20px; color: #fff; font-size: 28px; font-weight: 900; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.5); text-align: center; font-family: 'Anton'; letter-spacing: 2px; }
        
        /* Game Layout */
        .layout-text { flex-direction: column; width: 100%; height: 100%; }
        .q-container { width: 90%; height: 22%; margin: 20px auto 30px auto; position: relative; background: linear-gradient(to right, #3a0088, #5500aa, #3a0088); border-radius: 15px; padding: 5px; border: 2px solid #aaa; display: flex; align-items: center; box-shadow: 0 10px 20px rgba(0,0,0,0.5), inset 0 0 10px rgba(255,255,255,0.3); }
        .q-icon { font-family: 'Anton'; font-size: 80px; color: #00ffff; text-shadow: 3px 3px 0 #004444, 0 0 10px #00ffff; margin: 0 20px; transform: skewX(-10deg); }
        .q-text-box { flex: 1; background: #fff; border-radius: 10px; padding: 10px; height: 80%; display: flex; align-items: center; justify-content: center; }
        .q-text-content { color: #000066; font-size: 3.5vw; font-weight: 900; text-align: center; line-height: 1.2; }
        .options-area { width: 85%; margin: 0 auto; display: flex; flex-direction: column; gap: 15px; }
        .option-panel { width: 100%; height: 90px; background: linear-gradient(to bottom, #222, #000); border-radius: 45px; border: 2px solid #555; display: flex; align-items: center; padding: 0 10px; position: relative; }
        .opt-num { width: 60px; height: 60px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-family: 'Anton'; font-size: 36px; color: #fff; border: 3px solid #fff; margin-right: 20px; flex-shrink: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); box-shadow: 0 3px 5px rgba(0,0,0,0.5), inset 0 5px 10px rgba(255,255,255,0.4); }
        .opt-val { color: #fff; font-size: 3vw; font-weight: 900; text-shadow: 0 0 5px #00f; flex: 1; }
        .opt-img { height: 100%; width: auto; max-width: 100%; object-fit: contain; }
        .vote-count { position: absolute; right: 30px; font-family: 'Anton'; font-size: 50px; color: #ffd700; text-shadow: 2px 2px 0 #000; opacity: 0; }

        .col-1 { background: radial-gradient(circle at 30% 30%, #44aaff, var(--col-1)); border-color: #fff; } .col-2 { background: radial-gradient(circle at 30% 30%, #ff6666, var(--col-2)); border-color: #fff; } .col-3 { background: radial-gradient(circle at 30% 30%, #66ff66, var(--col-3)); border-color: #fff; } .col-4 { background: radial-gradient(circle at 30% 30%, #ffff66, var(--col-4)); border-color: #fff; }
        .border-1 { border-color: var(--col-1)!important; } .border-2 { border-color: var(--col-2)!important; } .border-3 { border-color: var(--col-3)!important; } .border-4 { border-color: var(--col-4)!important; }
        .dimmed { filter: grayscale(100%) brightness(0.3); opacity: 0.6; } .highlighted { animation: flash 0.4s infinite alternate; z-index: 20; box-shadow: 0 0 50px #fff; border-color: #fff !important; }
        @keyframes flash { from { filter: brightness(100%); } to { filter: brightness(150%); } }
        
        #timer-display { position: absolute; bottom: 30px; right: 30px; width: 130px; height: 130px; border-radius: 50%; background: radial-gradient(circle at 30% 30%, #555, #000); border: 6px solid #fff; box-shadow: 0 0 30px #f00; display: flex; justify-content: center; align-items: center; z-index: 100; }
        #timer-text { font-family: 'Anton'; font-size: 70px; color: #ff0000; text-shadow: 0 0 10px #ff0000; }

        /* Sort Result View */
        #sort-result-view { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index: 60; display:flex; align-items:center; justify-content:center; }
        .sort-compare-container { display:flex; gap: 50px; }
        .champ-ans-col { display: flex; flex-direction: column; gap: 20px; align-items: center; transition: 0.5s; }
        .correct-ans-col { display: flex; flex-direction: column; gap: 20px; }
        .sort-bubble { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; display:flex; justify-content:center; align-items:center; font-family:'Anton'; font-size: 40px; color:#fff; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .sort-row-correct { display: flex; align-items: center; gap: 20px; opacity: 0; transform: translateX(50px); transition: 0.5s; }
        .sort-row-correct.visible { opacity: 1; transform: translateX(0); }
        .sort-text-box { background: linear-gradient(to right, #003399, #0066ff); border: 2px solid #fff; border-radius: 40px; padding: 10px 30px; color: #fff; font-size: 28px; font-weight: 900; width: 400px; }
        .dimmed-all { filter: grayscale(100%) brightness(0.3); opacity: 0.5; }

        /* Period End & Ranking */
        #period-end-view { background: rgba(0,0,0,0.95); z-index: 200; color: #fff; text-align: center; }
        .champ-box { background: linear-gradient(to right, #b8860b, #ffd700); padding: 30px 50px; border-radius: 20px; border: 5px solid #fff; box-shadow: 0 0 50px #ffd700; animation: popIn 1s; display:inline-block; }
        #ranking-modal { background: rgba(0,0,0,0.95); z-index: 200; } .ranking-board { display: flex; width: 95%; max-width: 1000px; height: 80%; background: linear-gradient(to right, #0033cc, #0066ff); border: 4px solid #4488ff; border-radius: 20px; padding: 20px; position: relative; } .ranking-sidebar { width: 100px; margin-right: 15px; background: linear-gradient(to bottom, #00eeff 0%, #0088ff 50%, #0044aa 100%); border-radius: 15px; border: 3px solid #fff; display: flex; align-items: center; justify-content: center; } .side-text { writing-mode: vertical-rl; text-orientation: upright; font-weight: 900; font-size: 42px; color: #002266; letter-spacing: 5px; } .rank-list-area { flex: 1; display: flex; flex-direction: column; gap: 8px; overflow-y: hidden; justify-content: center; } .rank-row { height: 65px; background: linear-gradient(to bottom, #0055aa, #002288); border: 2px solid #66aaff; border-radius: 10px; display: flex; align-items: center; padding: 0 15px; color: #fff; font-size: 32px; font-weight: 800; animation: slideRank 0.5s ease-out forwards; } @keyframes slideRank { from { opacity: 0; transform: translateX(50px); } to { opacity: 1; transform: translateX(0); } } .rank-num { width: 60px; text-align: right; margin-right: 20px; font-family: 'Anton'; } .rank-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .rank-score-box { background: #000033; border: 2px solid #4488ff; border-radius: 5px; padding: 0 15px; min-width: 100px; text-align: right; font-family: 'Anton'; font-size: 38px; color: #ffdd00; }

        /* --- CLIENT --- */
        #client-view { background: #000; position: relative; height: 100vh; }
        .tv-background-client { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; background: linear-gradient(135deg, #001133 0%, #000000 100%); }
        #client-score { position: fixed; top: 0; left: 0; width: 100%; background: linear-gradient(to bottom, #222, #000); color: #ffd700; text-align: center; padding: 15px; font-size: 24px; font-weight: 900; z-index: 100; border-bottom: 2px solid #ffd700; box-shadow: 0 0 20px rgba(255,215,0,0.3); box-sizing: border-box; }
        
        #client-pad { 
            position: absolute; top: 50%; left: 0; width: 100%; transform: translateY(-50%);
            display: flex; flex-direction: row; justify-content: space-evenly; align-items: center;
            padding: 10px; box-sizing: border-box;
        }
        .ans-btn { 
            width: 20vw; height: 20vw; max-width: 120px; max-height: 120px;
            border: 4px solid rgba(255,255,255,0.3); border-radius: 50%; 
            font-family: 'Anton'; font-size: 40px; color: #fff; 
            display: flex; justify-content: center; align-items: center; 
            box-shadow: 0 5px 10px rgba(0,0,0,0.5), inset 0 5px 10px rgba(255,255,255,0.2); 
            transition: 0.1s; text-shadow: 2px 2px 0 rgba(0,0,0,0.5);
        }
        .ans-btn:active { transform: scale(0.95); filter: brightness(1.2); border-color: #fff; }
        .btn-1 { background: radial-gradient(circle at 30% 30%, #44aaff, var(--col-1)); } 
        .btn-2 { background: radial-gradient(circle at 30% 30%, #ff6666, var(--col-2)); } 
        .btn-3 { background: radial-gradient(circle at 30% 30%, #66ff66, var(--col-3)); } 
        .btn-4 { background: radial-gradient(circle at 30% 30%, #ffff66, var(--col-4)); }
        
        .ans-btn.disabled { opacity: 0.2; pointer-events: none; filter: grayscale(100%); }
        .ans-btn.selected { border-color: #fff; box-shadow: 0 0 30px #fff; transform: scale(1.1); z-index: 10; filter: brightness(1.2); pointer-events: none; }
        .ans-btn.sort-selected::after { content: attr(data-order); position: absolute; color: #fff; font-size: 40px; z-index: 10; font-family: 'Anton'; text-shadow: 0 0 10px #000; }
        .ans-btn.sort-selected { filter: brightness(0.5); pointer-events: none; position: relative; border-color: #888; }

        /* Client Overlays */
        #client-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 50; background: rgba(0,0,0,0.9); color: #fff; display: flex; flex-direction: column; justify-content: center; align-items: center; }
        .client-msg-main { font-size: 32px; font-weight: bold; color: #fff; text-shadow: 0 0 10px #0af; margin-bottom: 20px;}
        
        /* Static Result Text */
        #result-text { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-10deg); font-family: 'M PLUS Rounded 1c'; font-weight: 900; font-size: 100px; white-space: nowrap; z-index: 200; pointer-events: none; text-shadow: 2px 2px 0 #000; padding: 20px; border-radius: 20px; border: 8px solid #fff; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .res-win { color: #ffd700; background: rgba(255, 0, 0, 0.9); border-color: #fff; text-shadow: 0 0 20px #ffff00; }
        .res-lose { color: #ccc; background: rgba(50, 50, 50, 0.9); border-color: #888; transform: translate(-50%, -50%) rotate(5deg); }

    </style>
</head>
<body>

<div class="tv-background"></div>

<div id="title-view" class="screen flex-center tv-background">
    <div class="title-logo-container">
        <div class="title-logo-sub">オールスター</div>
        <div class="title-logo-main">感謝祭</div>
    </div>
    <button class="title-btn btn-start-big" onclick="goPeriodSelect()">START</button>
    <button class="title-btn btn-settings" onclick="startSetup()">SETTINGS</button>
</div>

<div id="setup-view" class="screen flex-center">
    <div class="setup-container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px;"><h2>設定</h2><button class="btn" onclick="goTitle()">戻る</button></div>
        <div class="connect-info-box">
            <div class="qr-area"><div id="qrcode-setup"><div style='font-size:12px;color:#000;'>QR生成中...</div></div></div>
            <div class="url-area">
                <div style="font-weight:bold; color:#0f0;">参加者用URL:</div>
                <input type="text" class="url-input" id="host-url" readonly onclick="this.select()">
            </div>
        </div>
        <div class="setup-scroll">
            <div style="margin-bottom:20px; border-bottom:1px solid #555; padding-bottom:10px;">
                <h3 style="color:#fb0;">音響 (BGM/SE)</h3>
                出題:<input type="file" accept="audio/*" onchange="loadAudio('q_open',this)"> シンキング:<input type="file" accept="audio/*" onchange="loadAudio('thinking',this)"> 集計:<input type="file" accept="audio/*" onchange="loadAudio('votes',this)"> 正解:<input type="file" accept="audio/*" onchange="loadAudio('correct',this)">
            </div>
            <h3 style="color:#fb0;">ピリオド構成</h3>
            <div id="p-list"></div>
            <button class="btn btn-blue" onclick="addPeriod()" style="width:100%; margin-top:10px; padding:15px; font-size:18px;">＋ ピリオドを追加</button>
        </div>
    </div>
</div>

<div id="host-view" class="screen hidden">
    <div id="period-select-view" class="full-screen hidden flex-center">
        <h1 style="color:#fff; text-shadow:2px 2px 5px #000; font-size:50px;">ピリオド選択</h1>
        <div class="period-grid" id="period-grid"></div>
        <button class="btn" onclick="goTitle()" style="margin-top:30px; padding:15px 30px; font-size:20px;">タイトルへ戻る</button>
    </div>

    <div id="game-layout" class="layout-text">
        <div class="q-container" id="q-area-l"><div class="q-icon">Q</div><div class="q-text-box"><div class="q-text-content" id="q-text"></div></div></div>
        <div class="options-area" id="opt-area">
            <div id="opt-1" class="option-panel border-1"><div class="opt-num col-1">1</div><div class="opt-val opt-img-box" id="val-1"></div><div class="vote-count" id="vote-1">0</div></div>
            <div id="opt-2" class="option-panel border-2"><div class="opt-num col-2">2</div><div class="opt-val opt-img-box" id="val-2"></div><div class="vote-count" id="vote-2">0</div></div>
            <div id="opt-3" class="option-panel border-3"><div class="opt-num col-3">3</div><div class="opt-val opt-img-box" id="val-3"></div><div class="vote-count" id="vote-3">0</div></div>
            <div id="opt-4" class="option-panel border-4"><div class="opt-num col-4">4</div><div class="opt-val opt-img-box" id="val-4"></div><div class="vote-count" id="vote-4">0</div></div>
        </div>
    </div>
    
    <div id="sort-result-view" class="hidden">
        <h2 style="position:absolute; top:20px; color:#fff;">正解発表</h2>
        <div class="sort-compare-container">
            <div class="champ-ans-col" id="champ-ans-col">
                <div style="color:#ffd700; font-weight:bold; font-size:30px; margin-bottom:20px;">CHAMPION</div>
            </div>
            <div class="correct-ans-col" id="correct-ans-col">
                <div style="color:#00ffff; font-weight:bold; font-size:30px; margin-bottom:20px;">ANSWER</div>
            </div>
        </div>
    </div>

    <div id="timer-display" class="hidden"><div id="timer-text">10</div></div>

    <div id="period-end-view" class="full-screen hidden flex-center">
        <h1 style="font-size:80px; color:#fb0; text-shadow:0 0 20px #fb0;">ピリオド終了!</h1>
        <div style="font-size:40px; margin:30px;">今ピリオドのチャンピオンは...</div>
        <div id="champ-name" class="champ-box hidden" style="font-size:60px; font-weight:900; color:#000;"></div>
        <div style="margin-top:50px; color:#aaa; font-size:24px;">Spaceキーで山分けクイズへ</div>
    </div>
    
    <div id="ranking-modal" class="full-screen hidden flex-center">
        <div class="ranking-board"><div class="ranking-sidebar"><div class="side-text">ランキング</div></div><div class="rank-list-area" id="rank-list"></div></div>
        <div class="ranking-footer" style="margin-top:20px;color:#aaa;font-size:20px;">Spaceキーで次へ</div>
    </div>
</div>

<div id="client-login" class="screen hidden flex-center" style="background:#111;">
    <div style="background:#333; padding:40px; border-radius:20px; width:80%; text-align:center;">
        <h2 style="color:#fb0;">ENTRY</h2><input type="text" id="user-name" placeholder="Name" style="font-size:24px; text-align:center; padding:15px; margin-bottom:20px; width:80%;">
        <button class="btn btn-blue" id="join-btn" onclick="joinGame()" style="width:100%; padding:20px; font-size:20px;" disabled>接続待機中...</button>
    </div>
</div>
<div id="client-view" class="screen hidden">
    <div class="tv-background-client"></div>
    <div id="client-score">現在の得点: 0点</div>
    
    <div id="client-pad" class="hidden">
        <button class="ans-btn btn-1" id="cbtn-1" onclick="sendAnswer('1')">1</button>
        <button class="ans-btn btn-2" id="cbtn-2" onclick="sendAnswer('2')">2</button>
        <button class="ans-btn btn-3" id="cbtn-3" onclick="sendAnswer('3')">3</button>
        <button class="ans-btn btn-4" id="cbtn-4" onclick="sendAnswer('4')">4</button>
    </div>

    <div id="client-overlay" class="client-overlay">
        <div class="client-msg-main" id="cli-msg-main">出題をお待ちください</div>
    </div>
    
    <div id="result-text" class="hidden"></div>
</div>

<script>
    // Data Structure
    let periods = [{
        title: "第1ピリオド",
        questions: [{q:"日本一高い山は？",correct:"1",options:{1:{type:'text',val:'富士山'},2:{type:'text',val:'北岳'},3:{type:'text',val:'奥穂高岳'},4:{type:'text',val:'間ノ岳'}}}],
        sortingQ: {q:"次の出来事を古い順に並べよ", order:["2","4","1","3"], options:{1:{type:'text',val:'明治維新'},2:{type:'text',val:'関ヶ原の戦い'},3:{type:'text',val:'第二次世界大戦終結'},4:{type:'text',val:'ペリー来航'}}}
    }];
    let audioFiles={q_open:null,thinking:null,votes:null,correct:null};
    
    // System State
    let peer, conn, conns={}, myId;
    let currentPIdx=0, currentQIdx=0, hostState=0; 
    let answers={}, participants={}, scores={}, periodScores={}, clientStartTime=0, bgmAudio=null;
    let isSorting=false, clientSortAns=[], champSortAns=null, lastChoice=null;

    // Init
    window.onload = () => {
        const u = new URLSearchParams(window.location.search);
        if(u.get('host')) { showScreen('client-login'); setTimeout(()=>initClient(u.get('host')), 500); } 
        else { showScreen('title-view'); setTimeout(initHost, 500); }
        document.addEventListener('keydown', e => { 
            if(e.code==='Escape') goTitle();
            if(!document.getElementById('host-view').classList.contains('hidden') && e.code==='Space'){ e.preventDefault(); nextPhase(); }
        });
    };
    function showScreen(id){ document.querySelectorAll('.screen').forEach(el=>el.classList.add('hidden')); document.getElementById(id).classList.remove('hidden'); if(['host-view','setup-view'].includes(id)) document.getElementById(id).style.display='flex'; }
    function goTitle(){ stopAudio(); showScreen('title-view'); resetHost(); }
    function goPeriodSelect(){ showScreen('host-view'); hostState=0; nextPhase(); }
    function resetHost(){ document.getElementById('period-select-view').classList.add('hidden'); document.getElementById('period-end-view').classList.add('hidden'); document.getElementById('ranking-modal').classList.add('hidden'); document.getElementById('sort-result-view').classList.add('hidden');}

    // Audio
    function loadAudio(k,i){if(i.files[0])audioFiles[k]=URL.createObjectURL(i.files[0]);}
    function playAudio(k,loop=false){if(!audioFiles[k])return;if(bgmAudio){bgmAudio.pause();bgmAudio=null;}const a=new Audio(audioFiles[k]);a.loop=loop;a.play().catch(()=>{});if(loop)bgmAudio=a;}
    function stopAudio(){if(bgmAudio){bgmAudio.pause();bgmAudio=null;}}

    // Setup
    function startSetup(){ renderPList(); showScreen('setup-view'); }
    function initHost(){
        if(peer) return;
        document.getElementById("qrcode-setup").innerHTML="<div style='color:#000;font-size:12px;'>接続中...</div>";
        peer=new Peer();
        peer.on('open', id=>{
            myId=id; const url = location.href.split('?')[0] + '?host=' + id;
            document.getElementById('host-url').value = url;
            document.getElementById("qrcode-setup").innerHTML="";
            new QRCode(document.getElementById("qrcode-setup"), {text:url, width:150, height:150});
        });
        peer.on('connection',c=>{
            c.on('open',()=>{ conns[c.peer]=c; c.on('data',d=>{
                if(d.type==='LOGIN'){ participants[c.peer]=d.name; scores[c.peer]=0; }
                if(d.type==='ANSWER' && (hostState===4||hostState===10) && !answers[c.peer]) answers[c.peer]=d;
            }); c.on('close',()=>{delete conns[c.peer];}); });
        });
    }
    // Editor
    function renderPList(){
        const l=document.getElementById('p-list'); l.innerHTML="";
        periods.forEach((p,pi)=>{
            const pd=document.createElement('div'); pd.className='p-card';
            pd.innerHTML=`<div style="display:flex;justify-content:space-between;margin-bottom:10px;"><input type="text" value="${p.title}" onchange="periods[${pi}].title=this.value" style="font-size:20px;font-weight:bold;width:60%;"><button class="btn btn-red" onclick="delP(${pi})">ピリオド削除</button></div><div id="p-${pi}-qs"></div><button class="btn btn-green" onclick="addQ(${pi})">＋ 問題追加</button><div class="sort-card"><span class="sort-header">山分けクイズ設定</span><input type="text" value="${p.sortingQ.q}" onchange="periods[${pi}].sortingQ.q=this.value" placeholder="問題文" style="margin-bottom:10px;"><div class="opt-grid">${[1,2,3,4].map(k=>renderSortOpt(pi, k, p.sortingQ.options[k])).join('')}</div><div style="margin-top:10px; color:#ffd700;">正解順 (例: 4,2,1,3): <input type="text" value="${p.sortingQ.order.join(',')}" onchange="periods[${pi}].sortingQ.order=this.value.split(',')" style="width:150px; background:#443300; color:#fff; font-weight:bold;"></div></div>`;
            l.appendChild(pd); renderQList(pi);
        });
    }
    function renderSortOpt(pi, k, opt) { return `<div class="opt-cell"><span style="font-size:12px;color:#aaa;">選択肢${k}</span> <label style="font-size:10px"><input type="radio" name="st-${pi}-${k}" ${opt.type=='text'?'checked':''} onchange="setSortType(${pi},${k},'text')">文</label><label style="font-size:10px"><input type="radio" name="st-${pi}-${k}" ${opt.type=='image'?'checked':''} onchange="setSortType(${pi},${k},'image')">画</label> ${opt.type=='text'?`<input type="text" value="${opt.val}" onchange="upSortOv(${pi},${k},this.value)">`:`<input type="file" accept="image/*" style="font-size:10px;" onchange="upSortImg(this,${pi},${k})">${opt.val?`<img src="${opt.val}" style="height:20px;">`:''}`}</div>`; }
    function renderQList(pi){ const ql=document.getElementById(`p-${pi}-qs`); ql.innerHTML=""; periods[pi].questions.forEach((q,qi)=>{ const qd=document.createElement('div'); qd.className='q-card'; qd.innerHTML=`<div style="display:flex;justify-content:space-between;"><b>Q${qi+1}</b><button class="btn btn-red" style="padding:5px;" onclick="delQ(${pi},${qi})">削除</button></div><input type="text" value="${q.q}" onchange="periods[${pi}].questions[${qi}].q=this.value" placeholder="問題文"><div style="display:grid;grid-template-columns:1fr 1fr;gap:5px;margin-top:5px;">${[1,2,3,4].map(k=>`<div><span style="font-size:12px;color:#aaa;">${k}</span> <label><input type="radio" name="t-${pi}-${qi}-${k}" ${q.options[k].type=='text'?'checked':''} onchange="setT(${pi},${qi},${k},'text')">文</label><label><input type="radio" name="t-${pi}-${qi}-${k}" ${q.options[k].type=='image'?'checked':''} onchange="setT(${pi},${qi},${k},'image')">画</label> ${q.options[k].type=='text'?`<input type="text" value="${q.options[k].val}" onchange="upOv(${pi},${qi},${k},this.value)">`:`<input type="file" accept="image/*" style="font-size:10px;" onchange="upImg(this,${pi},${qi},${k})">${q.options[k].val?`<img src="${q.options[k].val}" style="height:20px;">`:''}`}</div>`).join('')}</div><div style="margin-top:5px;">正解: <select onchange="periods[${pi}].questions[${qi}].correct=this.value">${[1,2,3,4].map(k=>`<option value="${k}" ${q.correct==k?'selected':''}>${k}</option>`).join('')}</select></div>`; ql.appendChild(qd); }); }
    // Updaters
    function addPeriod(){periods.push({title:`第${periods.length+1}ピリオド`,questions:[],sortingQ:{q:"",order:[],options:{1:{type:'text',val:''},2:{type:'text',val:''},3:{type:'text',val:''},4:{type:'text',val:''}}}});renderPList();} function delP(pi){periods.splice(pi,1);renderPList();}
    function addQ(pi){periods[pi].questions.push({q:"",correct:"1",options:{1:{type:'text',val:''},2:{type:'text',val:''},3:{type:'text',val:''},4:{type:'text',val:''}}});renderQList(pi);} function delQ(pi,qi){periods[pi].questions.splice(qi,1);renderQList(pi);}
    function setT(pi,qi,k,t){periods[pi].questions[qi].options[k].type=t;periods[pi].questions[qi].options[k].val="";renderQList(pi);} function upOv(pi,qi,k,v){periods[pi].questions[qi].options[k].val=v;} function upImg(el,pi,qi,k){if(el.files[0]){const r=new FileReader();r.onload=e=>{periods[pi].questions[qi].options[k].val=e.target.result;renderQList(pi);};r.readAsDataURL(el.files[0]);}}
    function setSortType(pi,k,t){periods[pi].sortingQ.options[k].type=t;periods[pi].sortingQ.options[k].val="";renderPList();} function upSortOv(pi,k,v){periods[pi].sortingQ.options[k].val=v;} function upSortImg(el,pi,k){if(el.files[0]){const r=new FileReader();r.onload=e=>{periods[pi].sortingQ.options[k].val=e.target.result;renderPList();};r.readAsDataURL(el.files[0]);}}

    // --- Host Flow ---
    function renderPSel(){ const g=document.getElementById('period-grid'); g.innerHTML=""; periods.forEach((p,i)=>{ g.innerHTML+=`<div class="period-btn" onclick="selectP(${i})">${p.title}<br><span style="font-size:16px">${p.questions.length}問</span></div>`; }); document.getElementById('period-select-view').classList.remove('hidden'); }
    function selectP(i){ currentPIdx=i; currentQIdx=-1; periodScores={}; for(let id in participants)periodScores[id]=0; document.getElementById('period-select-view').classList.add('hidden'); hostState=1; nextPhase(); }

    function nextPhase(){
        const P=periods[currentPIdx]; const Q=P.questions[currentQIdx];
        try {
            switch(hostState){
                case 0: renderPSel(); break; // P-Sel
                case 1: // Next Q
                    currentQIdx++; isSorting=false;
                    if(currentQIdx>=P.questions.length){ hostState=7; nextPhase(); return; }
                    resetDisp(); hostState=2; broadcast({type:'STANDBY', msg:'問題の出題をお待ちください'}); break;
                case 2: // Open & Start Immediate
                    displayQ(Q); playAudio('q_open'); playAudio('thinking',true); startTimer(10);
                    broadcast({type:'START', sort:false}); hostState=4; break;
                case 4: stopTimer(); break; // Timeup
                case 5: showVotes(); playAudio('votes'); hostState=6; break; // Votes
                case 6: // Correct
                    showCorrect(Q.correct); calcScores(Q.correct); playAudio('correct'); 
                    broadcast({type:'RESULT', correct:Q.correct}); // Send result
                    hostState=130; break; 
                case 130: showRank(Q.correct); hostState=140; break; // Speed Rank (Safely)
                case 140: document.getElementById('ranking-modal').classList.add('hidden'); hostState=1; nextPhase(); break; // Loop
                case 7: // P-End
                    document.getElementById('period-end-view').classList.remove('hidden');
                    let champId = "none";
                    if(Object.keys(periodScores).length > 0) champId = Object.keys(periodScores).reduce((a,b)=>periodScores[a]>periodScores[b]?a:b, Object.keys(periodScores)[0]);
                    document.getElementById('champ-name').innerText = participants[champId] || "該当なし";
                    champSortAns = null; // Reset
                    setTimeout(()=>document.getElementById('champ-name').classList.remove('hidden'), 1000);
                    hostState=8; break;
                case 8: // Sort Open & Start
                    document.getElementById('period-end-view').classList.add('hidden'); resetDisp(); isSorting=true;
                    displayQ(P.sortingQ); playAudio('q_open'); playAudio('thinking',true); startTimer(30);
                    broadcast({type:'START', sort:true}); hostState=10; break;
                case 10: stopTimer(); break; // Sort Stop
                case 11: // Sort Reveal Prep
                    let cid = "none";
                    if(Object.keys(periodScores).length > 0) cid = Object.keys(periodScores).reduce((a,b)=>periodScores[a]>periodScores[b]?a:b, Object.keys(periodScores)[0]);
                    champSortAns = (answers[cid] && answers[cid].choice) ? answers[cid].choice : ["?","?","?","?"];
                    renderSortResultLayout(champSortAns, P.sortingQ); hostState=12; break; 
                case 12: case 13: case 14: case 15: // Reveal steps
                    revealSortRow(hostState-12, P.sortingQ.order, champSortAns); playAudio('votes'); hostState++;
                    if(hostState>15){ 
                        calcSortScores(P.sortingQ.order); 
                        broadcast({type:'RESULT', correct:P.sortingQ.order});
                        hostState=131; 
                    } break;
                case 131: showRank(null, true); hostState=141; break; // Overall Rank
                case 141: document.getElementById('ranking-modal').classList.add('hidden'); hostState=0; nextPhase(); break;
            }
        } catch(e) {
            console.error("State Error:", e);
            alert("エラーが発生しましたが続行します");
            document.getElementById('ranking-modal').classList.add('hidden');
            hostState=0;
        }
    }
    function broadcast(m){for(let k in conns)conns[k].send(m);}
    
    function resetDisp(){
        document.getElementById('q-text').innerText=""; document.getElementById('sort-result-view').classList.add('hidden');
        for(let k=1;k<=4;k++){ const p=document.getElementById('opt-'+k); p.classList.remove('dimmed','highlighted'); document.getElementById('val-'+k).innerHTML=""; document.getElementById('vote-'+k).style.opacity=0; }
        document.getElementById('timer-display').classList.add('hidden'); answers={}; stopAudio();
    }
    function displayQ(q){
        document.getElementById('q-text').innerText=q.q;
        for(let k=1;k<=4;k++){
            const el=document.getElementById('val-'+k); el.className = 'opt-val';
            if(q.options[k].type==='image' && !isSorting) el.innerHTML=`<img src="${q.options[k].val}" class="opt-img">`; else el.innerText=q.options[k].val;
        }
    }
    let tId; function startTimer(sec){
        const el=document.getElementById('timer-display'); el.classList.remove('hidden'); let t=sec; const s=Date.now();
        tId=setInterval(()=>{ t=sec-(Date.now()-s)/1000; if(t<=0){t=0;stopTimer();} document.getElementById('timer-text').innerText=Math.floor(t); },50);
    }
    function stopTimer(){ clearInterval(tId); document.getElementById('timer-display').classList.add('hidden'); broadcast({type:'TIMEUP'}); stopAudio(); hostState++; }
    
    function showVotes(){ for(let k=1;k<=4;k++) document.getElementById('vote-'+k).innerText = Object.values(answers).filter(a=>a.choice==k).length; for(let k=1;k<=4;k++) document.getElementById('vote-'+k).style.opacity=1; }
    function showCorrect(c){ for(let k=1;k<=4;k++){ const p=document.getElementById('opt-'+k); if(k==c) p.classList.add('highlighted'); else p.classList.add('dimmed'); } }
    
    function renderSortResultLayout(champAns, q){
        document.getElementById('sort-result-view').classList.remove('hidden');
        const cCol = document.getElementById('champ-ans-col'); cCol.innerHTML='<div style="color:#ffd700; font-weight:bold; font-size:30px; margin-bottom:20px;">CHAMPION</div>'; cCol.className = 'champ-ans-col';
        const rCol = document.getElementById('correct-ans-col'); rCol.innerHTML='<div style="color:#00ffff; font-weight:bold; font-size:30px; margin-bottom:20px;">ANSWER</div>';
        
        champAns.forEach(k => {
            const color = k==1?'var(--col-1)':k==2?'var(--col-2)':k==3?'var(--col-3)':'var(--col-4)';
            cCol.innerHTML += `<div class="sort-bubble" style="background:${color}">${k}</div>`;
        });
        q.order.forEach((k, i) => {
            const txt = q.options[k].type=='text' ? q.options[k].val : `選択肢${k}`;
            const color = k==1?'var(--col-1)':k==2?'var(--col-2)':k==3?'var(--col-3)':'var(--col-4)';
            rCol.innerHTML += `<div class="sort-row-correct" id="sort-row-${i}"><div class="sort-bubble" style="background:${color}">${k}</div><div class="sort-text-box">${txt}</div></div>`;
        });
    }
    function revealSortRow(idx, correctOrder, champAns){
        document.getElementById(`sort-row-${idx}`).classList.add('visible');
        if(correctOrder[idx] !== champAns[idx]) document.getElementById('champ-ans-col').classList.add('dimmed-all');
    }

    function calcScores(c){ for(let id in answers) if(answers[id].choice==c){ scores[id]++; periodScores[id]++; } broadcastScores(); }
    function calcSortScores(ord){ for(let id in answers) if(JSON.stringify(answers[id].choice)===JSON.stringify(ord)) scores[id]+=5; broadcastScores(); } 
    function broadcastScores(){ for(let id in conns) conns[id].send({type:'SCORE', score:scores[id]}); }
    
    function showRank(correctAnswer, isOverall = false){
        const l=document.getElementById('rank-list'); l.innerHTML="";
        let w = [];
        
        try {
            if (isOverall) {
                // Overall Rank
                w = Object.keys(scores).map(id=>({n:participants[id]||"Unknown", v:scores[id]})).sort((a,b)=>b.v-a.v);
            } else {
                // Speed Rank
                for(let id in answers) {
                    if(participants[id] && answers[id].choice == correctAnswer) { 
                        let t = 99.99;
                        if(answers[id].time !== undefined && answers[id].time !== null) {
                             t = parseFloat(answers[id].time);
                        }
                        if(isNaN(t)) t = 99.99;
                        w.push({n:participants[id], v:t});
                    }
                }
                w.sort((a,b)=>a.v-b.v);
            }
        } catch(e) { console.log("Rank Error", e); }

        if(!w.length) l.innerHTML="<div style='text-align:center;font-size:40px;color:#fff;'>該当者なし</div>";
        else w.slice(0,10).forEach((p,i)=>{ 
            let val = isOverall ? `${p.v}P` : `${p.v.toFixed(2)}s`;
            l.innerHTML+=`<div class="rank-row" style="animation-delay:${i*0.1}s"><div class="rank-num">${i+1}</div><div class="rank-name">${p.n}</div><div class="rank-score-box">${val}</div></div>`; 
        });
        
        document.querySelector('.side-text').innerText = isOverall ? "総合成績" : "スピード順";
        document.getElementById('ranking-modal').classList.remove('hidden');
    }

    // --- Client Logic ---
    function initClient(hid){
        peer=new Peer(); 
        peer.on('open',()=>{ 
            conn=peer.connect(hid); 
            conn.on('open', ()=>{ 
                const btn = document.getElementById('join-btn');
                btn.disabled = false; btn.innerText = "参加";
            });
            conn.on('data',d=>{
                if(d.type==='SCORE') document.getElementById('client-score').innerText=`現在の得点: ${d.score}点`;
                if(d.type==='STANDBY'){ updateClientUI('standby', d.msg); }
                if(d.type==='START'){ isSorting=d.sort; resetClientSort(); updateClientUI('active'); }
                if(d.type==='TIMEUP'){ updateClientUI('locked'); }
                if(d.type==='RESULT'){ showClientResult(d.correct); }
            });
        });
    }
    function joinGame(){ 
        const n=document.getElementById('user-name').value; if(!n)return; 
        if(!conn || !conn.open) return alert("接続中...少々お待ちください");
        conn.send({type:'LOGIN', name:n}); showScreen('client-view'); 
    }
    
    function updateClientUI(state, msg="") {
        const overlay = document.getElementById('client-overlay');
        const pad = document.getElementById('client-pad');
        const main = document.getElementById('cli-msg-main');
        const resText = document.getElementById('result-text');
        resText.classList.add('hidden'); // Clear result text
        
        if (state === 'active') {
            overlay.classList.add('hidden');
            pad.classList.remove('hidden');
            document.querySelectorAll('.ans-btn').forEach(b=>{
                b.classList.remove('disabled', 'selected', 'sort-selected');
                b.style.pointerEvents = 'auto';
            });
            lastChoice = null;
        } else if (state === 'standby') {
            overlay.classList.remove('hidden');
            pad.classList.add('hidden');
            main.innerText = msg;
        } else if (state === 'locked') {
            // Keep buttons visible but locked
        }
    }

    function sendAnswer(c){
        if(isSorting){
            if(clientSortAns.includes(c)) return;
            clientSortAns.push(c);
            const btn = document.querySelector(`#cbtn-${c}`);
            btn.classList.add('sort-selected');
            btn.setAttribute('data-order', clientSortAns.length);
            if(clientSortAns.length===4) sendSortAnswer();
        } else {
            // Calculate time taken
            const t = (Date.now() - clientStartTime) / 1000;
            conn.send({type:'ANSWER', choice:c, time:t});
            lastChoice = c;
            // Visual Lock
            document.querySelectorAll('.ans-btn').forEach(b=>{
                b.style.pointerEvents = 'none';
                if(b.id === `cbtn-${c}`) b.classList.add('selected');
                else b.classList.add('disabled');
            });
        }
    }
    function resetClientSort(){ clientSortAns=[]; }
    function sendSortAnswer(){ 
        const t = (Date.now() - clientStartTime) / 1000;
        conn.send({type:'ANSWER', choice:clientSortAns, time:t}); 
        lastChoice = JSON.stringify(clientSortAns);
    }
    
    function showClientResult(correct) {
        const txt = document.getElementById('result-text');
        let isCorrect = false;
        
        // Ensure buttons stay visible
        document.getElementById('client-pad').classList.remove('hidden');

        if(isSorting) {
            if(JSON.stringify(clientSortAns) === JSON.stringify(correct)) isCorrect = true;
        } else {
            if(lastChoice === correct) isCorrect = true;
        }
        
        if(isCorrect) {
            txt.innerText = "正解";
            txt.className = "res-win";
        } else {
            txt.innerText = "不正解";
            txt.className = "res-lose";
        }
        txt.classList.remove('hidden');
    }
</script>
</body>
</html>
