<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V30</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/cv.js"></script>
    <script src="https://unpkg.com/js-aruco@0.0.1/src/aruco.js"></script>

    <style>
        body { font-family: sans-serif; background: #111; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; }
        
        /* ç”»é¢ã‚³ãƒ³ãƒ†ãƒŠåˆ‡ã‚Šæ›¿ãˆç”¨ */
        .screen { position: absolute; top:0; left:0; width:100%; height:100%; display:none; flex-direction:column; align-items:center; justify-content:center; }
        #title-screen { display: flex; background: #222; z-index: 100; }
        #game-screen { background: #000; }

        /* ã‚²ãƒ¼ãƒ ç”»é¢ */
        #canvas-container {
            position: relative; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; overflow: hidden;
        }
        canvas { display: block; width: 100%; height: 100%; object-fit: cover; }
        #proc-canvas { display: none; }

        /* UIã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between; pading: 10px; box-sizing: border-box; z-index: 10;
        }
        
        button { pointer-events: auto; cursor: pointer; border: none; outline: none; }
        .btn-float { 
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #aaa; 
            padding: 8px 16px; border-radius: 20px; font-size: 14px; margin: 10px; 
        }
        .judge-btn { 
            width: 200px; padding: 15px; font-size: 1.2rem; font-weight: bold; border-radius: 50px; 
            color: white; background: linear-gradient(to bottom, #28a745, #208030); 
            align-self: center; margin-bottom: 30px; box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }

        /* çµæœè¡¨ç¤º */
        #result-overlay {
            display:none; position:absolute; top:0; left:0; width:100%; height:100%; 
            background:rgba(0,0,0,0.9); flex-direction:column; justify-content:center; align-items:center; z-index:200;
        }
        #result-content { 
            background: #333; padding: 30px; border-radius: 15px; text-align: center; width: 80%; max-width: 300px;
            pointer-events: auto; /* ã“ã“é‡è¦ */
        }

        /* ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ãƒªã‚¹ãƒˆ */
        #title-list { width: 90%; max-width: 400px; overflow-y: auto; max-height: 60%; margin-top: 20px; }
        .level-item { 
            background: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            display: flex; justify-content: space-between; align-items: center; cursor: pointer; border: 1px solid #444;
        }
        .level-item:active { background: #444; }

        /* è¨­å®šç”»é¢ */
        #settings-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #151515; z-index: 300; transform: translateY(100%); 
            transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; 
        }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }

        /* ãã®ä»–éƒ¨å“ */
        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { min-width: 60px; height: 80px; background: #000; border: 1px solid #555; position: relative; }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        
        #status-msg { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background: rgba(40,167,69,0.9); padding: 8px 20px; border-radius: 20px; 
            font-size:14px; opacity:0; transition:opacity 0.5s; z-index:400; pointer-events: none;
        }
        #sync-area { display:none; background:#fff; padding:20px; margin-top:10px; text-align:center; border-radius:8px; color:#000; }
        #qrcode { margin: 10px auto; }
        
        video { display: none; }
    </style>
</head>
<body>

<div id="title-screen" class="screen">
    <h1 style="margin-bottom:5px; text-shadow: 0 0 10px #0af;">CARD MASTER</h1>
    <p style="color:#aaa; font-size:12px;">V30 Stable</p>
    
    <div id="title-list">
        <div style="text-align:center; color:#777; margin-top:20px;">å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>è¨­å®šã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚</div>
    </div>

    <div style="margin-top:20px;">
        <button class="btn-float" onclick="openSettings()">âš™ï¸ è¨­å®šãƒ»ä½œæˆãƒ»åŒæœŸ</button>
    </div>
</div>

<div id="game-screen" class="screen">
    <div id="canvas-container">
        <canvas id="main-canvas"></canvas>
        <canvas id="proc-canvas"></canvas>
    </div>

    <div class="ui-layer">
        <div style="display:flex; justify-content:space-between; padding:10px;">
            <button class="btn-float" onclick="goTitle()">ğŸ  ã‚¿ã‚¤ãƒˆãƒ«</button>
            <button class="btn-float" onclick="toggleDebug()">ç¯„å›²: <span id="debug-val">100%</span></button>
        </div>

        <div style="text-align:center; margin-bottom:10px; pointer-events:auto;">
            <div id="guide-text" style="background:rgba(0,0,0,0.5); display:inline-block; padding:5px 10px; border-radius:10px; font-size:12px;">
                ãƒãƒ¼ã‚«ãƒ¼(0,10,20,30)ã‚’å¯¾è§’ç·šã«é…ç½®
            </div>
            <br>
            <button id="btn-judge" class="judge-btn" onclick="judge()">åˆ¤ å®š !</button>
        </div>
    </div>
    
    <div id="result-overlay">
        <div id="result-content">
            <h2 id="res-msg" style="font-size:2.5rem; margin:0 0 20px 0;"></h2>
            <button onclick="closeResult()" style="background:#555; color:#fff; padding:10px 30px; border-radius:20px; font-size:16px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>
</div>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®šãƒ»ç™»éŒ²</h2>
        <button onclick="closeSettings()" class="btn-float" style="margin:0; background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="setting-box" style="border:1px solid #aaa;">
        <h3>ğŸ–¨ï¸ ãƒãƒ¼ã‚«ãƒ¼æº–å‚™ (å¿…é ˆ)</h3>
        <p style="font-size:12px; color:#ccc;">ArUcoãƒãƒ¼ã‚«ãƒ¼(Original)ã® ID:0, 10, 20, 30 ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚<br>â€»ç™½ã„ä½™ç™½ã‚’æ®‹ã—ã¦åˆ‡ã‚Šå–ã£ã¦ãã ã•ã„ã€‚</p>
        <button onclick="showMarkers()" style="width:100%; padding:10px; background:#e0a800; color:#000; border-radius:5px; font-weight:bold;">ãƒãƒ¼ã‚«ãƒ¼ã‚’è¡¨ç¤º</button>
    </div>

    <div class="setting-box" style="border:1px solid #007bff;">
        <h3>ğŸ“¡ ãƒ‡ãƒ¼ã‚¿åŒæœŸ</h3>
        <button onclick="startHost()" style="width:100%; padding:10px; background:#007bff; color:#fff; border-radius:5px;">QRã‚³ãƒ¼ãƒ‰ã‚’è¡¨ç¤º (PCâ†’ã‚¹ãƒãƒ›)</button>
        <div id="sync-area">
            <div id="qrcode"></div>
            <div id="sync-msg" style="font-size:12px; color:#333;">æ¥ç¶šå¾…æ©Ÿä¸­...</div>
            <button onclick="document.getElementById('sync-area').style.display='none'" style="margin-top:10px; padding:5px 10px; background:#555; color:#fff; border-radius:4px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <div class="setting-box">
        <h3>1. ã‚«ãƒ¼ãƒ‰ç™»éŒ²</h3>
        <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <label style="display:flex; align-items:center; background:#333; padding:8px; margin-bottom:5px;">
            <input type="checkbox" id="is-blank-check" style="margin-right:10px;"> ç©ºç™½(ã‚«ãƒ¼ãƒ‰ãªã—)ã¨ã—ã¦ç™»éŒ²
        </label>
        <label style="display:block; text-align:center; background:#007bff; padding:10px; border-radius:5px; margin-top:5px;">
            ğŸ“ ç”»åƒã‚’é¸æŠ
            <input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;">
        </label>
        <div class="card-list" id="reg-list" style="margin-top:10px;"></div>
    </div>

    <div class="setting-box">
        <h3>2. å•é¡Œä½œæˆ</h3>
        <input type="text" id="lvl-name" placeholder="å•é¡Œå" style="width:100%; padding:10px; margin-bottom:5px; box-sizing:border-box;">
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px;">
            <div><span style="font-size:10px;">ID:0</span><select id="sel-0" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:10</span><select id="sel-10" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:20</span><select id="sel-20" style="width:100%;"></select></div>
            <div><span style="font-size:10px;">ID:30</span><select id="sel-30" style="width:100%;"></select></div>
        </div>
        <button onclick="addLevel()" style="width:100%; padding:10px; background:#28a745; color:#fff; border-radius:5px; margin-top:10px;">ï¼‹ è¿½åŠ </button>
        <div id="level-list" style="margin-top:10px;"></div>
    </div>
    
    <div class="setting-box"><button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border-radius:5px;">âš  ãƒ‡ãƒ¼ã‚¿å…¨å‰Šé™¤</button></div>
</div>

<div id="status-msg"></div>
<video id="video-source" autoplay playsinline muted></video>

<script>
    // --- è¨­å®š ---
    const PROC_W = 100;
    const PROC_H = 140; 
    const TARGET_IDS = [0, 10, 20, 30];

    // --- å¤‰æ•° ---
    let cards = [];
    let levels = [];
    let blankData = null;
    let detectedInfo = {}; // ãƒ‡ãƒãƒƒã‚°è¡¨ç¤ºç”¨: {id: {name, score, rect}}
    let currentTarget = null;
    let marginScale = 1.0;
    let detector = null;
    let videoStream = null;
    let isGameRunning = false;

    // DOM
    const video = document.getElementById('video-source');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');
    const procCanvas = document.getElementById('proc-canvas');
    const procCtx = procCanvas.getContext('2d');

    // åˆæœŸåŒ–
    window.onload = () => {
        loadData();
        renderTitleList();
        
        // ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ã‚’è¡¨ç¤º
        showScreen('title-screen');

        // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿åŒæœŸ
        const u = new URLSearchParams(window.location.search);
        if(u.get('sync')) { openSettings(); startClient(u.get('sync')); }
    };

    function showScreen(id) {
        document.querySelectorAll('.screen').forEach(el => el.style.display = 'none');
        document.getElementById(id).style.display = 'flex';
    }

    // --- ã‚²ãƒ¼ãƒ é–‹å§‹ãƒ»çµ‚äº† ---
    function startGame(idx) {
        if(!levels[idx]) return;
        currentTarget = levels[idx];
        showScreen('game-screen');
        
        // ã‚«ãƒ¡ãƒ©èµ·å‹•
        if(!isGameRunning) {
            isGameRunning = true;
            if(typeof AR !== 'undefined') detector = new AR.Detector();
            procCanvas.width = PROC_W; procCanvas.height = PROC_H;
            startCamera();
        }
        showToast("é–‹å§‹: " + currentTarget.title);
    }

    function goTitle() {
        isGameRunning = false;
        stopCamera();
        showScreen('title-screen');
    }

    // --- ã‚«ãƒ¡ãƒ©å‡¦ç† ---
    async function startCamera() {
        try {
            const constraints = { 
                video: { 
                    facingMode: "environment", 
                    width: { ideal: 640 }, height: { ideal: 480 } // è§£åƒåº¦ã‚’æŠ‘ãˆã¦å®‰å®šåŒ–
                } 
            };
            const stream = await navigator.mediaDevices.getUserMedia(constraints);
            videoStream = stream;
            video.srcObject = stream;
            video.onloadedmetadata = () => {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                requestAnimationFrame(loop);
            };
        } catch(e) {
            alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼: " + e.message);
            goTitle();
        }
    }

    function stopCamera() {
        if(videoStream) {
            videoStream.getTracks().forEach(t => t.stop());
            videoStream = null;
        }
    }

    // --- ãƒ¡ã‚¤ãƒ³ãƒ«ãƒ¼ãƒ— ---
    let lastTime = 0;
    function loop(timestamp) {
        if(!isGameRunning) return;
        requestAnimationFrame(loop);
        
        // FPSåˆ¶å¾¡ (ç´„30fps)
        if (timestamp - lastTime < 33) return;
        lastTime = timestamp;
        
        if(video.readyState !== 4) return;

        // æç”»
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imgData = ctx.getImageData(0, 0, canvas.width, canvas.height);

        // ãƒãƒ¼ã‚«ãƒ¼æ¤œå‡º
        let markers = [];
        if(detector) markers = detector.detect(imgData);

        // ã‚°ãƒ«ãƒ¼ãƒ—åŒ–
        let markersById = {};
        TARGET_IDS.forEach(id => markersById[id] = []);
        markers.forEach(m => { if(TARGET_IDS.includes(m.id)) markersById[m.id].push(m); });

        // çµæœã‚¯ãƒªã‚¢
        detectedInfo = {};
        TARGET_IDS.forEach(id => detectedInfo[id] = { name: "?", score: 0, rect: null });

        // æç”»: èªè­˜ã—ãŸå…¨ãƒãƒ¼ã‚«ãƒ¼ã«ç·‘æ ã‚’è¡¨ç¤ºï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        markers.forEach(m => {
            drawMarkerDebug(ctx, m);
        });

        // ãƒšã‚¢ãƒªãƒ³ã‚°ã¨åˆ¤å®š
        TARGET_IDS.forEach(id => {
            const ms = markersById[id];
            if(ms.length === 2) {
                const c1 = getCenter(ms[0].corners);
                const c2 = getCenter(ms[1].corners);
                const rect = getBoundingRect(c1, c2, marginScale);

                // ç”»åƒåˆ‡ã‚Šå‡ºã— (Warp)
                const srcPoints = [rect.x, rect.y, rect.x + rect.w, rect.y, rect.x + rect.w, rect.y + rect.h, rect.x, rect.y + rect.h];
                const dstPoints = [0,0, PROC_W,0, PROC_W,PROC_H, 0,PROC_H];
                const H = getHomography(srcPoints, dstPoints);
                warpImage(imgData, procCtx, H);

                // ç‰¹å¾´æŠ½å‡ºãƒ»åˆ¤å®š
                const procData = procCtx.getImageData(0,0,PROC_W, PROC_H);
                const bin = binarize(procData);
                const feat = getFeature(bin, PROC_W, PROC_H);
                
                // åˆ¤å®šå®Ÿè¡Œ
                const res = identifyCard(feat);
                detectedInfo[id] = { name: res.name, score: res.score, rect: rect };

                // èªè­˜æ ã¨çµæœã®è¡¨ç¤º
                drawResultOverlay(ctx, rect, id, res.name, res.score);
            }
        });
    }

    // --- æç”»ç³»ï¼ˆãƒ‡ãƒãƒƒã‚°å¼·åŒ–ï¼‰ ---
    function drawMarkerDebug(ctx, m) {
        ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
        ctx.beginPath();
        m.corners.forEach((p,i)=>{ i==0?ctx.moveTo(p.x,p.y):ctx.lineTo(p.x,p.y); });
        ctx.closePath(); ctx.stroke();
        ctx.fillStyle = "#0f0"; ctx.font = "10px sans-serif";
        ctx.fillText("ID:"+m.id, m.corners[0].x, m.corners[0].y - 2);
    }

    function drawResultOverlay(ctx, r, id, name, score) {
        // èªè­˜ã‚¨ãƒªã‚¢ï¼ˆé’æ ï¼‰
        ctx.strokeStyle = "rgba(0, 255, 255, 0.8)"; ctx.lineWidth = 3;
        ctx.strokeRect(r.x, r.y, r.w, r.h);

        // çµæœãƒ†ã‚­ã‚¹ãƒˆ
        ctx.fillStyle = "cyan"; ctx.font = "bold 12px sans-serif";
        ctx.fillText(`ID:${id}`, r.x, r.y - 5);
        
        const label = (name==="") ? "ç©ºç™½" : (name==="?") ? "?" : name;
        const color = (name==="?") ? "gray" : "white";
        
        ctx.fillStyle = color; 
        ctx.shadowColor="black"; ctx.shadowBlur=3;
        ctx.font = "bold 20px sans-serif";
        const tx = r.x + r.w/2;
        const ty = r.y + r.h/2;
        ctx.textAlign = "center";
        ctx.fillText(label, tx, ty);
        
        // ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆå°ã•ã„æ–‡å­—ï¼‰
        ctx.font = "11px sans-serif";
        ctx.fillStyle = "#ddd";
        ctx.fillText(`Score: ${Math.floor(score*100)}`, tx, ty + 15);
        
        ctx.shadowBlur=0; ctx.textAlign = "start";
    }

    // --- åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ ---
    function identifyCard(feat) {
        let bestName = "?"; 
        let minDiff = 1.0;

        cards.forEach(c => {
            if(c.isBlank) return;
            const diff = compare(feat, c.data);
            if(diff < minDiff) { minDiff = diff; bestName = c.name; }
        });

        if(blankData) {
            const bDiff = compare(feat, blankData);
            if(bDiff < minDiff) { minDiff = bDiff; bestName = ""; }
        }

        // ã‚¹ã‚³ã‚¢ (1.0 - å·®åˆ†) ã«å¤‰æ›
        const score = 1.0 - minDiff;
        
        // é–¾å€¤åˆ¤å®š (0.6æœªæº€ã¯è‡ªä¿¡ãªã—ã¨ã™ã‚‹)
        if(score < 0.6) bestName = "?";

        return { name: bestName, score: score };
    }

    // --- ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ ---
    function judge() {
        if(!currentTarget) return;
        
        const targetOrder = currentTarget.order; // [ID0æ­£è§£, ID10æ­£è§£...]
        let ok = true;

        TARGET_IDS.forEach((id, idx) => {
            const detected = detectedInfo[id].name;
            const correct = targetOrder[idx];
            if(detected !== correct) ok = false;
        });

        const overlay = document.getElementById('result-overlay');
        const msg = document.getElementById('res-msg');
        
        overlay.style.display = 'flex';
        if(ok) {
            msg.innerText = "æ­£è§£!! ğŸ‰";
            msg.style.color = "#0f0";
        } else {
            msg.innerText = "ä¸æ­£è§£...";
            msg.style.color = "#f55";
        }
    }

    function closeResult() {
        document.getElementById('result-overlay').style.display = 'none';
    }

    function toggleDebug() {
        marginScale = (marginScale === 1.0) ? 1.2 : 1.0;
        document.getElementById('debug-val').innerText = Math.round(marginScale*100) + "%";
    }

    // --- å…±é€šè¨ˆç®—ãƒ»ç”»åƒå‡¦ç† (çœç•¥ãªã—) ---
    function getCenter(corners){let x=0,y=0;corners.forEach(p=>{x+=p.x;y+=p.y;});return{x:x/4,y:y/4};}
    function getBoundingRect(p1,p2,s){const minX=Math.min(p1.x,p2.x),maxX=Math.max(p1.x,p2.x),minY=Math.min(p1.y,p2.y),maxY=Math.max(p1.y,p2.y);const w=maxX-minX,h=maxY-minY,cx=minX+w/2,cy=minY+h/2,nw=w*s,nh=h*s;return{x:cx-nw/2,y:cy-nh/2,w:nw,h:nh};}
    function getHomography(src,dst){let A=[],B=[];for(let i=0;i<4;i++){let sx=src[i*2],sy=src[i*2+1],dx=dst[i*2],dy=dst[i*2+1];A.push([sx,sy,1,0,0,0,-sx*dx,-sy*dx]);A.push([0,0,0,sx,sy,1,-sx*dy,-sy*dy]);B.push(dx);B.push(dy);}return solveGaussian(A,B).concat([1.0]);}
    function solveGaussian(A,B){let n=A.length;let x=new Array(n);for(let i=0;i<n;i++){let max=Math.abs(A[i][i]),r=i;for(let k=i+1;k<n;k++)if(Math.abs(A[k][i])>max){max=Math.abs(A[k][i]);r=k;}for(let k=i;k<n;k++){let t=A[r][k];A[r][k]=A[i][k];A[i][k]=t;}let t=B[r];B[r]=B[i];B[i]=t;for(let k=i+1;k<n;k++){let c=-A[k][i]/A[i][i];for(let j=i;j<n;j++)if(i==j)A[k][j]=0;else A[k][j]+=c*A[i][j];B[k]+=c*B[i];}}for(let i=n-1;i>=0;i--){let s=0;for(let j=i+1;j<n;j++)s+=A[i][j]*x[j];x[i]=(B[i]-s)/A[i][i];}return x;}
    function invertMatrix(m){const n11=m[0],n12=m[1],n13=m[2],n21=m[3],n22=m[4],n23=m[5],n31=m[6],n32=m[7],n33=m[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(det===0)return m;const i=1/det;return[t11*i,(n31*n23-n33*n21)*i,(n32*n21-n31*n22)*i,t12*i,(n33*n11-n31*n13)*i,(n31*n12-n32*n11)*i,t13*i,(n21*n13-n23*n11)*i,(n22*n11-n21*n12)*i];}
    function warpImage(src,ctxDst,H){const w=ctxDst.canvas.width,h=ctxDst.canvas.height,dstD=ctxDst.createImageData(w,h),dd=dstD.data,srcD=src.data,sw=src.width,sh=src.height,Hi=invertMatrix(H);for(let y=0;y<h;y++)for(let x=0;x<w;x++){const u=Hi[0]*x+Hi[1]*y+Hi[2],v=Hi[3]*x+Hi[4]*y+Hi[5],s=Hi[6]*x+Hi[7]*y+Hi[8],sx=Math.floor(u/s),sy=Math.floor(v/s),di=(y*w+x)*4;if(sx>=0&&sx<sw&&sy>=0&&sy<sh){const si=(sy*sw+sx)*4;dd[di]=srcD[si];dd[di+1]=srcD[si+1];dd[di+2]=srcD[si+2];dd[di+3]=255;}else dd[di+3]=0;}ctxDst.putImageData(dstD,0,0);}
    function binarize(d){const b=new ImageData(d.width,d.height),bd=b.data,dd=d.data;for(let i=0;i<dd.length;i+=4){const v=(dd[i]+dd[i+1]+dd[i+2])/3<100?0:255;bd[i]=bd[i+1]=bd[i+2]=v;bd[i+3]=255;}return b;}
    function getFeature(b,w,h){const p=[],d=b.data,step=3;for(let y=0;y<h;y+=step)for(let x=0;x<w;x+=step)p.push(d[((y*w+x)*4)]===0?1:0);return p;}
    function compare(a,b){if(!a||!b||a.length!=b.length)return 1;let d=0,c=0;for(let i=0;i<a.length;i++){if(a[i]!=b[i])d++;c++;}return c?d/c:1;}

    // --- UI/Data ---
    function registerImage(input) {
        if(!input.files[0]) return;
        const name = document.getElementById('reg-name').value || "Card"+(cards.length+1);
        const isBlank = document.getElementById('is-blank-check').checked;
        const r = new FileReader();
        r.onload = e => {
            const img = new Image(); img.onload = () => {
                const c = document.createElement('canvas'); c.width=PROC_W; c.height=PROC_H;
                const t = c.getContext('2d'); t.drawImage(img,0,0,PROC_W,PROC_H);
                const bin = binarize(t.getImageData(0,0,PROC_W,PROC_H));
                const data = getFeature(bin,PROC_W,PROC_H);
                t.putImageData(bin,0,0);
                const thumb = c.toDataURL();
                const nc = {name,data,thumb,isBlank};
                if(isBlank){ blankData=data; cards=cards.filter(x=>!x.isBlank); cards.unshift(nc); } else cards.push(nc);
                saveData(); renderUI(); input.value=""; showToast("ç™»éŒ²: "+name);
            }; img.src=e.target.result;
        }; r.readAsDataURL(input.files[0]);
    }
    function addLevel(){ 
        const title = document.getElementById('lvl-name').value || "ç„¡é¡Œ";
        const order = TARGET_IDS.map(id => document.getElementById('sel-'+id).value);
        levels.push({title, order}); 
        saveData(); renderUI(); 
        document.getElementById('lvl-name').value="";
    }
    function renderUI() {
        const cl=document.getElementById('reg-list'); cl.innerHTML="";
        cards.forEach((c,i)=>{cl.innerHTML+=`<div class="card-thumb" style="${c.isBlank?'border:2px dashed #0f0':''}"><img src="${c.thumb}"><div style="font-size:10px; text-align:center; overflow:hidden;">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;text-align:center;cursor:pointer;color:white;" onclick="delCard(${i})">Ã—</div></div>`;});
        TARGET_IDS.forEach(id => {
            const s=document.getElementById('sel-'+id); s.innerHTML="<option value=''>- ç©ºç™½ -</option>"; 
            cards.forEach(c=>{if(!c.isBlank)s.innerHTML+=`<option value="${c.name}">${c.name}</option>`});
        });
        const ll=document.getElementById('level-list'); ll.innerHTML="";
        levels.forEach((l,i)=>{ll.innerHTML+=`<div style="background:#333;padding:10px;margin-bottom:5px;border-radius:4px;display:flex;justify-content:space-between;border:1px solid #555;"><div><b>${l.title}</b><div style="font-size:10px;color:#aaa;">${l.order.join(', ')}</div></div><button style="background:#d00;color:white;padding:5px 10px;border-radius:4px;" onclick="delLevel(${i})">å‰Šé™¤</button></div>`;});
        
        renderTitleList();
    }
    function renderTitleList() {
        const tl = document.getElementById('title-list');
        if(levels.length === 0) {
            tl.innerHTML = "<div style='text-align:center; color:#777; margin-top:20px;'>å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚<br>è¨­å®šã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„ã€‚</div>";
            return;
        }
        tl.innerHTML = "";
        levels.forEach((l, i) => {
            tl.innerHTML += `<div class="level-item" onclick="startGame(${i})"><span>${l.title}</span><span style="background:#0af; color:#000; padding:2px 8px; border-radius:10px; font-size:12px;">æŒ‘æˆ¦</span></div>`;
        });
    }

    // --- ãã®ä»– ---
    function delCard(i){if(confirm("å‰Šé™¤?")){cards.splice(i,1);saveData();renderUI();}}
    function delLevel(i){if(confirm("å‰Šé™¤?")){levels.splice(i,1);saveData();renderUI();}}
    function saveData(){localStorage.setItem('cm_v30',JSON.stringify({cards,levels,blankData}));}
    function loadData(){const d=localStorage.getItem('cm_v30');if(d){const j=JSON.parse(d);cards=j.cards||[];levels=j.levels||[];blankData=j.blankData;}}
    function resetData(){if(confirm("å…¨æ¶ˆå»?")){localStorage.clear();location.reload();}}
    function showToast(m){const e=document.getElementById('status-msg');e.innerText=m;e.style.opacity=1;setTimeout(()=>e.style.opacity=0,2000);}
    function openSettings(){document.getElementById('settings-overlay').classList.add('open');}
    function closeSettings(){document.getElementById('settings-overlay').classList.remove('open');}

    // --- ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º ---
    function showMarkers() {
        const w = window.open('','_blank');
        w.document.write(`<html><head><title>Markers</title><style>body{text-align:center; font-family:sans-serif;} img{width:150px; border:1px solid #ddd; margin:10px; image-rendering:pixelated;}</style></head><body><h2>ArUco Markers (Original)</h2><p>ç™½ã„ä½™ç™½ã‚’æ®‹ã—ã¦åˆ‡ã‚Šå–ã£ã¦ãã ã•ã„</p><div>ID:0<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=0&size=200"></div><div>ID:10<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=10&size=200"></div><div>ID:20<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=20&size=200"></div><div>ID:30<br><img src="https://chev.me/arucogen/50.svg?dict=original&id=30&size=200"></div><br><button onclick="window.print()" style="font-size:20px; padding:10px;">å°åˆ·</button></body></html>`);
    }

    // --- åŒæœŸ (PeerJS) ---
    function startHost(){
        if(typeof Peer==='undefined'){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");return;}
        if(peer) peer.destroy(); peer=new Peer();
        document.getElementById('sync-area').style.display='block';
        document.getElementById('qrcode').innerHTML="";
        document.getElementById('sync-msg').innerText="æ¥ç¶šå¾…æ©Ÿä¸­...";
        peer.on('open',id=>{ new QRCode(document.getElementById('qrcode'),{text:window.location.href.split('?')[0]+"?sync="+id,width:150,height:150}); });
        peer.on('connection',c=>{ c.on('open',()=>{ c.send({cards,levels,blankData}); document.getElementById('sync-msg').innerText="é€ä¿¡å®Œäº†!"; }); });
    }
    function startClient(id){
        if(typeof Peer==='undefined')return;
        if(peer) peer.destroy(); peer=new Peer(); showToast("åŒæœŸé–‹å§‹...");
        peer.on('open',()=>{ const c=peer.connect(id); c.on('data',d=>{ if(d.cards){ cards=d.cards; levels=d.levels; blankData=d.blankData; saveData(); renderUI(); showToast("åŒæœŸå®Œäº†!"); window.history.replaceState({},document.title,window.location.pathname); } }); });
    }
</script>
</body>
</html>
