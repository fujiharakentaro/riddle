<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Card Master V19 (Fixed)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background: #000; color: #fff; margin: 0; overflow: hidden; width: 100vw; height: 100dvh; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        
        /* ãƒ¡ã‚¤ãƒ³ç”»é¢ */
        #canvas-container {
            position: relative; width: 100%; max-width: 640px; aspect-ratio: 16 / 9; 
            background: #222; box-shadow: 0 0 20px rgba(0,255,0,0.2);
        }
        canvas { width: 100%; height: 100%; display: block; }

        /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
        .ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }
        
        button, .btn-float, .judge-btn, .file-label, .level-item { cursor: pointer; pointer-events: auto; }

        .btn-float { 
            background: rgba(0,0,0,0.6); color: #fff; border: 1px solid #fff; 
            padding: 8px 15px; border-radius: 20px; font-size: 12px; margin: 10px; 
        }
        .btn-float:hover { background: rgba(255,255,255,0.2); }

        .judge-btn { 
            width: 80%; padding: 15px; font-size: 1.5rem; font-weight: bold; border: none; border-radius: 50px; 
            color: white; background: linear-gradient(to bottom, #28a745, #208030); 
            align-self: center; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .judge-btn:hover { transform: scale(1.02); }

        /* èª¿æ•´ãƒ‘ãƒãƒ« */
        #controls { width: 90%; max-width: 600px; background: #222; padding: 10px; border-radius: 10px; margin-top: 10px; }
        .slider-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; }
        input[type=range] { width: 100%; cursor: grab; }

        /* è¨­å®šç”»é¢ */
        #settings-overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: #151515; z-index: 200; transform: translateY(100%); 
            transition: transform 0.3s; padding: 20px; overflow-y: auto; box-sizing: border-box; 
        }
        #settings-overlay.open { transform: translateY(0); }
        .setting-box { background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #444; }
        h3 { margin-top: 0; border-bottom: 1px solid #555; padding-bottom: 5px; font-size:1rem; color:#ddd; }

        .card-list { display: flex; overflow-x: auto; gap: 10px; padding: 10px 0; min-height: 80px;}
        .card-thumb { 
            min-width: 60px; height: 80px; background: #000; border: 1px solid #555; border-radius:4px;
            display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative;
        }
        .card-thumb img { width: 100%; height: 100%; object-fit: contain; }
        
        input[type="text"], select { 
            padding: 10px; width: 100%; margin-bottom: 5px; box-sizing: border-box; 
            background: #333; color: #fff; border: 1px solid #555; border-radius: 5px; 
        }

        /* å•é¡Œãƒªã‚¹ãƒˆ */
        .level-row {
            background: #333; padding: 10px; margin-bottom: 5px; border-radius: 6px; border: 1px solid #444;
            display: flex; flex-direction: column; cursor: default;
        }
        .level-row-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .btn-mini { padding: 4px 8px; font-size: 11px; border-radius: 4px; border: none; margin-left: 5px; color: #fff;}
        .btn-edit { background: #007bff; } .btn-del { background: #dc3545; }

        #result-view { 
            position: fixed; top:0; left:0; width:100%; height:100%; 
            background: rgba(0,0,0,0.9); display: none; z-index: 400; 
            flex-direction: column; justify-content: center; align-items: center; cursor: pointer;
        }
        
        #status-msg { 
            position: fixed; top: 10px; left: 50%; transform: translateX(-50%); 
            background: rgba(40,167,69,0.95); padding: 8px 20px; border-radius: 20px; 
            font-size:12px; opacity:0; transition:opacity 0.5s; z-index:300; pointer-events: none;
        }
        video { display: none; }
    </style>
</head>
<body>

<div id="canvas-container">
    <canvas id="main-canvas"></canvas>
    <div class="ui-layer">
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-float" onclick="startCam(true)">ğŸ“· å†èµ·å‹•</button>
            <button class="btn-float" onclick="openSettings()">âš™ï¸ è¨­å®š</button>
        </div>
        
        <button id="btn-back" class="btn-float" onclick="goTitle()" style="display:none; position:absolute; top:50px; left:0;">â† ã‚¿ã‚¤ãƒˆãƒ«ã¸</button>
        <button id="btn-judge" class="judge-btn" onclick="judge()" style="display:none;">åˆ¤ å®š !</button>
        
        <div id="title-ui" style="text-align:center; margin-top:15%; width:100%; height:70%; overflow-y:auto;">
            <h1 style="text-shadow:0 0 10px #000; margin-bottom:10px;">CARD MASTER</h1>
            <p style="font-size:12px; color:#ccc;">å•é¡Œã‚’é¸æŠã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆ</p>
            <div id="title-level-list" style="width:80%; margin:0 auto; padding-bottom:20px;"></div>
        </div>
    </div>
</div>

<div id="controls">
    <div class="slider-row">
        <span>ç™½é»’æ„Ÿåº¦ <span id="val-thr">90</span></span>
        <span>åˆ¤å®šã®ç”˜ã• <span id="val-tol">0.6</span></span>
    </div>
    <input type="range" min="10" max="200" value="90" oninput="updateParam('thr', this.value)">
    <input type="range" min="0.1" max="1.0" step="0.05" value="0.6" oninput="updateParam('tol', this.value)" style="margin-top:5px;">
    <div style="font-size:10px; color:#aaa; margin-top:5px; text-align:center;">
        â€»é»„è‰²ã„æ ã®ä¸­ã«ã‚«ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ãã ã•ã„ã€‚<br>
        â€»æ„Ÿåº¦ã‚’èª¿æ•´ã—ã¦çµµæŸ„ãŒãƒãƒƒã‚­ãƒªè¦‹ãˆã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ã€‚
    </div>
</div>

<div id="status-msg">ä¿å­˜ã—ã¾ã—ãŸ</div>
<video id="video-source" autoplay playsinline muted></video>

<div id="settings-overlay">
    <div style="display:flex; justify-content:space-between; margin-bottom:15px;">
        <h2>è¨­å®š</h2><button onclick="closeSettings()" class="btn-float" style="margin:0; background:#555;">é–‰ã˜ã‚‹</button>
    </div>
    
    <div class="setting-box">
        <h3>1. ç”»åƒç™»éŒ²</h3>
        <p style="font-size:12px; color:#f88; margin-bottom:5px;">â€»ä¸å…·åˆæ™‚ã¯ã€Œå…¨å‰Šé™¤ã€ã—ã¦ã‹ã‚‰å†ç™»éŒ²ã—ã¦ãã ã•ã„</p>
        
        <input type="text" id="reg-name" placeholder="ã‚«ãƒ¼ãƒ‰å (ä¾‹: â˜…, A, ç©ºç™½)">
        <div style="background:#333; padding:8px; margin-bottom:10px; border-radius:4px;">
            <label style="cursor:pointer; display:flex; align-items:center;">
                <input type="checkbox" id="is-blank-check" style="width:20px; margin-right:5px;"> 
                ã“ã‚Œã‚’ã€Œç©ºç™½ã€ã¨ã—ã¦ç™»éŒ²ã™ã‚‹
            </label>
        </div>
        
        <label class="btn-float" style="display:block; text-align:center; margin:0; background:#007bff; border:none; font-size:14px; padding:12px;">
            ğŸ“ ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ç™»éŒ²
            <input type="file" accept="image/*" onchange="registerImage(this)" style="display:none;">
        </label>
        
        <div class="card-list" id="reg-list"></div>
    </div>

    <div class="setting-box">
        <h3>2. å•é¡Œä½œæˆãƒ»ç·¨é›†</h3>
        <input type="hidden" id="edit-index" value="-1">
        <input type="text" id="lvl-name" placeholder="å•é¡Œã‚¿ã‚¤ãƒˆãƒ« (ä¾‹: ãƒ¬ãƒ™ãƒ«1)">
        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <select id="sel-0"></select><select id="sel-1"></select><select id="sel-2"></select><select id="sel-3"></select>
        </div>
        <button id="add-btn" onclick="addOrUpdateLevel()" style="width:100%; padding:12px; background:#28a745; color:#fff; border:none; border-radius:5px; font-weight:bold;">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
        <button id="cancel-btn" onclick="cancelEdit()" style="width:100%; padding:8px; background:#666; color:#fff; border:none; border-radius:5px; margin-top:5px; display:none;">ç·¨é›†ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        
        <div style="margin-top:15px; border-top:1px solid #444; padding-top:10px;">
            <div id="settings-level-list" class="level-list-container"></div>
        </div>
    </div>

    <div class="setting-box">
        <h3>ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h3>
        <button onclick="downloadHTML()" style="width:100%; padding:10px; background:#007bff; color:#fff; border:none; border-radius:5px; margin-bottom:10px;">ğŸ’¾ è¨­å®šè¾¼ã¿HTMLã‚’ä¿å­˜</button>
        <button onclick="startHost()" style="width:100%; padding:10px; background:#007bff; color:#fff; border:none; border-radius:5px; margin-bottom:10px;">ğŸ“¡ QRåŒæœŸ (PCâ†’ã‚¹ãƒãƒ›)</button>
        <button onclick="resetData()" style="width:100%; padding:10px; background:#d00; color:#fff; border:none; border-radius:5px;">âš  å…¨å‰Šé™¤ (ãƒªã‚»ãƒƒãƒˆ)</button>
        <div id="sync-area" style="display:none; background:#fff; padding:10px; margin-top:10px; text-align:center; border-radius:8px;">
            <div id="qrcode"></div><div id="sync-msg" style="color:#000; font-size:11px;">å¾…æ©Ÿä¸­...</div>
        </div>
    </div>
</div>

<div id="result-view" onclick="this.style.display='none'">
    <div id="res-msg" style="font-size:4rem; font-weight:bold;"></div>
    <div style="font-size:1.2rem; opacity:0.8;">Tap to close</div>
</div>

<script id="embedded-data" type="application/json">null</script>

<script>
    const PROC_W = 320; const PROC_H = 180;
    const SLOT_W_PCT = 0.20; const GAP_PCT = 0.05;
    const START_X = (1.0 - (SLOT_W_PCT*4 + GAP_PCT*3)) / 2;
    const SLOT_X_PCT = [START_X, START_X+SLOT_W_PCT+GAP_PCT, START_X+(SLOT_W_PCT+GAP_PCT)*2, START_X+(SLOT_W_PCT+GAP_PCT)*3];

    let cards=[], levels=[], blankData=null;
    let currentOrder=[], detected=["","","",""];
    let currentTarget=[]; // è¿½åŠ ï¼šæ˜ç¤ºçš„ã«å®šç¾©
    let isGameMode = false;
    let threshold = 90; let tolerance = 0.6;

    const video = document.getElementById('video-source');
    const canvas = document.getElementById('main-canvas');
    const ctx = canvas.getContext('2d');

    window.onload = () => {
        canvas.width = PROC_W; canvas.height = PROC_H;
        try {
            const txt = document.getElementById('embedded-data').textContent;
            if(txt && txt!=="null") { const d=JSON.parse(txt); cards=d.cards; levels=d.levels; blankData=d.blank; }
            else loadLocal();
        } catch(e){ loadLocal(); }
        
        renderUI(); startCam();
        const u = new URLSearchParams(window.location.search);
        if(u.get('sync')) startClient(u.get('sync'));
    };

    function updateParam(type, val) {
        if(type==='thr') { threshold=parseInt(val); document.getElementById('val-thr').innerText=threshold; }
        if(type==='tol') { tolerance=parseFloat(val); document.getElementById('val-tol').innerText=tolerance>=0.8?"ç„¡ç†ã‚„ã‚Š":tolerance.toFixed(2); }
    }

    async function startCam(manual=false) {
        if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
        try {
            const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } } });
            video.srcObject = s;
            video.onloadedmetadata = () => { video.play(); setInterval(loop, 100); };
            if(manual) showToast("å†èµ·å‹•ã—ã¾ã—ãŸ");
        } catch(e) { 
            navigator.mediaDevices.getUserMedia({video:true}).then(s=>{ video.srcObject=s; video.onloadedmetadata=()=>{video.play(); setInterval(loop, 100);};});
        }
    }

    function loop() {
        if(video.readyState !== 4) return;
        ctx.drawImage(video, 0, 0, PROC_W, PROC_H);
        const imgData = ctx.getImageData(0, 0, PROC_W, PROC_H);
        const bin = binarize(imgData);
        ctx.putImageData(bin, 0, 0); 
        
        ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2; ctx.fillStyle = "#0f0"; ctx.font = "10px sans-serif";
        const scanH = PROC_H * 0.4; const scanY = (PROC_H - scanH) / 2;
        let detectedNow = [];

        for(let i=0; i<4; i++) {
            const cx = SLOT_X_PCT[i] * PROC_W; 
            // ä¿®æ­£ï¼šSLOT_WIDTH_PCT ã‚’ SLOT_W_PCT ã«å¤‰æ›´
            const cw = SLOT_W_PCT * PROC_W; 
            const cutW = Math.floor(cw * 0.7); const cutX = Math.floor(cx + (cw - cutW)/2);
            ctx.strokeRect(cutX, scanY, cutW, scanH);
            
            const feat = getFeature(bin, cutX, scanY, cutW, scanH, PROC_W);
            let best = "?"; let minD = 1.0;

            cards.forEach(c => {
                if(c.isBlank) return;
                const diff = compareShift(feat, c.data, cutW, scanH, 4); 
                if(diff < minD) { minD = diff; best = c.name; }
            });
            if(blankData) {
                const bDiff = compareShift(feat, blankData, cutW, scanH, 4);
                if(bDiff < minD) { best = ""; minD = bDiff; }
            }
            if(minD > tolerance) best = "?";
            detectedNow.push(best);
            
            const disp = best==="" ? "(ç©ºç™½)" : best;
            ctx.fillText(`${disp}`, cutX, scanY + scanH + 12);
            ctx.fillText(`(${minD.toFixed(2)})`, cutX, scanY + scanH + 22);
        }
        detected = detectedNow;
    }

    // --- ç”»åƒç™»éŒ² ---
    function registerImage(input) {
        if(!input.files[0]) return;
        const name = document.getElementById('reg-name').value || "Card"+(cards.length+1);
        const isBlank = document.getElementById('is-blank-check').checked;
        const r = new FileReader();
        
        r.onload = (e) => {
            const img = new Image();
            img.onload = () => {
                const c = document.createElement('canvas');
                // ä¿®æ­£ï¼šSLOT_WIDTH_PCT ã‚’ SLOT_W_PCT ã«å¤‰æ›´
                const cw = SLOT_W_PCT * PROC_W; 
                const cutW = Math.floor(cw * 0.7); const scanH = PROC_H * 0.4;
                c.width = cutW; c.height = scanH;
                const tx = c.getContext('2d');
                tx.drawImage(img, 0, 0, cutW, scanH);
                
                const b = binarize(tx.getImageData(0,0,cutW,scanH));
                const data = getFeature(b, 0, 0, cutW, scanH, cutW);
                
                tx.putImageData(b, 0, 0); 
                const thumb = c.toDataURL();

                if(isBlank) {
                    blankData = data;
                    cards = cards.filter(x=>!x.isBlank);
                    cards.unshift({name:"ã€ç©ºç™½ã€‘"+name, data, thumb, isBlank:true});
                    showToast("ç©ºç™½ã¨ã—ã¦ç™»éŒ²ã—ã¾ã—ãŸ");
                } else {
                    cards.push({name, data, thumb, isBlank:false});
                    showToast("ç™»éŒ²ã—ã¾ã—ãŸ");
                }
                saveLocal(); renderUI();
                input.value=""; document.getElementById('reg-name').value=""; document.getElementById('is-blank-check').checked=false;
            };
            img.src = e.target.result;
        };
        r.readAsDataURL(input.files[0]);
    }

    // --- ã‚³ã‚¢é–¢æ•° ---
    function binarize(d) {
        const bin=new ImageData(d.width,d.height); const bd=bin.data; const dd=d.data;
        for(let i=0;i<dd.length;i+=4) {
            const v = (dd[i]+dd[i+1]+dd[i+2])/3 < threshold ? 0 : 255;
            bd[i]=bd[i+1]=bd[i+2]=v; bd[i+3]=255;
        }
        return bin;
    }
    
    function getFeature(b,x,y,w,h,tw) {
        const p=[]; const d=b.data; const step=2;
        for(let py=0; py<h; py+=step) for(let px=0; px<w; px+=step) {
            const idx = ((y+py)*tw + (x+px)) * 4; p.push(d[idx]===0 ? 1 : 0);
        }
        return p;
    }

    function compareShift(a, b, w, h, range) {
        if(!a || !b || a.length !== b.length) return 1.0;
        let minDiff = 1.0;
        minDiff = Math.min(minDiff, simpleCompare(a,b,0));
        for(let s=1; s<=range; s++) {
            minDiff = Math.min(minDiff, simpleCompare(a,b,s));
            minDiff = Math.min(minDiff, simpleCompare(a,b,-s));
        }
        return minDiff;
    }
    function simpleCompare(a,b,offset) {
        let diff=0; let cnt=0; const len=a.length;
        for(let i=0; i<len; i++) {
            let ai = i+offset;
            if(ai>=0 && ai<len) { if(a[ai]!==b[i]) diff++; cnt++; }
        }
        return cnt===0?1.0 : diff/cnt;
    }

    // --- UI/ãƒ¬ãƒ™ãƒ«ç®¡ç† ---
    function addOrUpdateLevel() {
        const t = document.getElementById('lvl-name').value || "ç„¡é¡Œ";
        const o = [0,1,2,3].map(i => document.getElementById(`sel-${i}`).value);
        const idx = parseInt(document.getElementById('edit-index').value);
        if(idx>=0) { levels[idx]={title:t, order:o}; showToast("æ›´æ–°ã—ã¾ã—ãŸ"); }
        else { levels.push({title:t, order:o}); showToast("è¿½åŠ ã—ã¾ã—ãŸ"); }
        cancelEdit(); saveLocal(); renderUI();
    }
    function editLevel(i) {
        const l=levels[i]; document.getElementById('lvl-name').value=l.title;
        for(let j=0;j<4;j++) document.getElementById(`sel-${j}`).value=l.order[j];
        document.getElementById('edit-index').value=i;
        document.getElementById('add-btn').innerText="æ›´æ–°";
        document.getElementById('cancel-btn').style.display="inline-block";
    }
    function cancelEdit() {
        document.getElementById('lvl-name').value="";
        for(let j=0;j<4;j++) document.getElementById(`sel-${j}`).value="";
        document.getElementById('edit-index').value="-1";
        document.getElementById('add-btn').innerText="ï¼‹ è¿½åŠ ";
        document.getElementById('cancel-btn').style.display="none";
    }

    function renderUI() {
        const cl = document.getElementById('reg-list'); cl.innerHTML="";
        cards.forEach((c,i)=>{
            const style = c.isBlank ? "border:2px dashed #0f0;" : "";
            cl.innerHTML+=`<div class="card-thumb" style="${style}"><img src="${c.thumb}"><div class="card-name">${c.name}</div><div style="position:absolute;top:0;right:0;background:red;width:20px;color:white;text-align:center;cursor:pointer;" onclick="if(confirm('å‰Šé™¤?')){cards.splice(${i},1);if(c.isBlank)blankData=null;saveLocal();renderUI();}">Ã—</div></div>`;
        });
        for(let i=0;i<4;i++){
            const s=document.getElementById(`sel-${i}`); const v=s.value; s.innerHTML="<option value=''>- ç©ºç™½ -</option>";
            cards.forEach(c=>{ if(!c.isBlank) s.innerHTML+=`<option value='${c.name}'>${c.name}</option>`; });
            s.value=v;
        }
        const tl = document.getElementById('title-level-list'); tl.innerHTML="";
        if(levels.length===0) tl.innerHTML="<div style='color:#777;margin-top:20px;'>â€»å³ä¸Šã®è¨­å®šâš™ï¸ã‹ã‚‰å•é¡Œã‚’ä½œæˆã—ã¦ãã ã•ã„</div>";
        levels.forEach((l,i)=>{
            tl.innerHTML+=`
            <div style="background:rgba(255,255,255,0.1); padding:15px; margin-bottom:10px; border-radius:10px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; border:1px solid #555;" onclick="startGame(${i})">
                <span style="font-weight:bold; font-size:16px;">${l.title}</span>
                <span style="background:#007bff; padding:5px 10px; border-radius:15px; font-size:12px;">æŒ‘æˆ¦ â–¶</span>
            </div>`;
        });
        const sl = document.getElementById('settings-level-list'); sl.innerHTML="";
        levels.forEach((l,i)=>{
            const detail = l.order.map(n=>n===""?"_":n).join(", ");
            sl.innerHTML+=`
            <div class="level-row">
                <div class="level-row-header">
                    <span style="font-weight:bold;">${l.title}</span>
                    <div><button class="btn-mini btn-edit" onclick="editLevel(${i})">ç·¨é›†</button><button class="btn-mini btn-del" onclick="if(confirm('å‰Šé™¤?')){levels.splice(${i},1);saveLocal();renderUI();}">å‰Šé™¤</button></div>
                </div>
                <div style="font-size:11px;color:#aaa;">æ­£è§£: ${detail}</div>
            </div>`;
        });
    }

    function startGame(i) { currentTarget=levels[i].order; isGameMode=true; updateScreen(); }
    function goTitle() { isGameMode=false; updateScreen(); }
    function updateScreen() {
        const disp = isGameMode ? 'block' : 'none';
        const notDisp = isGameMode ? 'none' : 'block';
        document.getElementById('btn-judge').style.display = disp;
        document.getElementById('btn-back').style.display = disp;
        document.getElementById('title-ui').style.display = notDisp;
    }
    
    function judge() { 
        const isMatch = JSON.stringify(detected) === JSON.stringify(currentTarget); 
        const m = document.getElementById('res-msg'); 
        m.innerText=isMatch?"æ­£è§£!!":"ä¸æ­£è§£..."; m.style.color=isMatch?"#0f0":"#f00";
        document.getElementById('result-view').style.display='flex';
    }

    function saveLocal() { localStorage.setItem('cm_v19_data', JSON.stringify({cards,levels,blank:blankData})); }
    function loadLocal() { const d=localStorage.getItem('cm_v19_data'); if(d){ const j=JSON.parse(d); cards=j.cards; levels=j.levels; blankData=j.blank;} }
    function resetData() { if(confirm("å…¨æ¶ˆå»?")) { localStorage.clear(); location.reload(); } }
    function showToast(m) { const e=document.getElementById('status-msg'); e.innerText=m; e.style.opacity=1; setTimeout(()=>e.style.opacity=0,2000); }
    function openSettings() { document.getElementById('settings-overlay').classList.add('open'); }
    function closeSettings() { document.getElementById('settings-overlay').classList.remove('open'); cancelEdit(); }
    
    function downloadHTML() {
        let html = document.documentElement.outerHTML;
        const data = JSON.stringify({ cards, levels, blank: blankData });
        const tag = '\x3cscript id="embedded-data" type="application/json"\x3e' + data + '\x3c/script\x3e';
        html = html.replace(/<script id="embedded-data" type="application\/json">.*?<\/script>/i, tag);
        const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([html], {type:"text/html"})); a.download = "index.html"; a.click();
    }
    
    let peer=null;
    function startHost(){ if(typeof Peer==='undefined'){alert("é€šä¿¡ã‚¨ãƒ©ãƒ¼");return;} if(peer)peer.destroy(); peer=new Peer(); document.getElementById('sync-area').style.display='block'; document.getElementById('sync-msg').innerText="å¾…æ©Ÿä¸­..."; peer.on('open',id=>{ new QRCode(document.getElementById('qrcode'),{text:window.location.href.split('?')[0]+"?sync="+id,width:128,height:128});}); peer.on('connection',c=>{c.on('open',()=>c.send({cards,levels,blank:blankData}));});}
    function startClient(id){ if(peer)peer.destroy(); peer=new Peer(); peer.on('open',()=>{ const c=peer.connect(id); c.on('data',d=>{cards=d.cards;levels=d.levels;blankData=d.blank;saveLocal();renderUI();showToast("åŒæœŸå®Œäº†");window.history.replaceState({},document.title,window.location.pathname);}); });}
</script>
</body>
</html>
